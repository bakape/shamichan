{"version":3,"sources":["node_modules/browser-pack/_prelude.js","main.js","client/main/amusement.js","client/main/client.js","client/main/common/index.js","client/main/common/oneesama.js","client/main/common/util.js","client/main/connection.js","client/main/extract.js","client/main/fsm.js","client/main/hide.js","client/main/history.js","client/main/loop.js","client/main/memory.js","client/main/options/index.js","client/main/options/opts.js","client/main/posts/article.js","client/main/posts/common.js","client/main/posts/embed.js","client/main/posts/identity.js","client/main/posts/imager.js","client/main/posts/index.js","client/main/posts/menu.js","client/main/posts/models.js","client/main/posts/nonce.js","client/main/posts/posting.js","client/main/posts/section.js","client/main/scroll.js","client/main/state.js","client/main/time.js","client/main/util.js","client/main/main.js"],"names":["require","e","t","n","r","s","o","u","a","i","f","Error","code","l","exports","call","length",1,"module","_slicedToArray","sliceIterator","arr","_arr","_n","_d","_e","undefined","_s","_i","Symbol","iterator","next","done","push","value","err","Array","isArray","Object","TypeError","main","$","common","state","oneeSama","hook","imouto","queueRoll","bit","number","this","allRolls","sent","info","$tag","callback","strong","dice","readable_dice","seen","_ref","postForm","request","rolls","lim","html","dispatcher","EXECUTE_JS","_ref2","_ref3","js","eval","console","error","./main",2,"_defineProperty","obj","key","defineProperty","enumerable","configurable","writable","checkRepliedToMe","links","sourceNum","mine","readAll","num","modelHandler","func","model","posts","get","_$extend","_","util","online","document","query","extend","INSERT_POST","message","_message","msg","bump","page","isThread","op","syncs","editing","el","nonce","myNonce","tab","ownPosts","trigger","postSM","feed","write","addLinks","models","view","id","render","insertIntoDOM","clientInit","parent","dispatch","INSERT_IMAGE","_msg","img","postModel","toPostForm","insertUploaded","setImage","UPDATE_POST","frag","_ref2$","extra","update","FINISH_POST","_msg2","set","DELETE_POSTS","deletePost","LOCK_THREAD","toggleLocked","UNLOCK_THREAD","DELETE_IMAGES","removeImage","SPOILER_IMAGES","setSpoiler","BAN","_msg3","JSON","parse","setBan","BACKLINK","addBacklink","ONLINE_COUNT","textContent","HOT_INJECTION","_msg4","force","hash","hotConfig","configHash","send","SYNCHRONIZE","connSM","feeder","INVALID","listener","event","spoilt","target","classList","toggle",3,"OneeSama","./oneesama","./util",4,"_classCallCheck","instance","Constructor","_taggedTemplateLiteral","strings","raw","freeze","defineProperties","_createClass","props","descriptor","protoProps","staticProps","prototype","_templateObject","_templateObject2","_templateObject3","_templateObject4","_templateObject5","_templateObject6","_templateObject7","_templateObject8","_templateObject9","_templateObject10","_templateObject11","_templateObject12","_templateObject13","_templateObject14","_templateObject15","_templateObject16","_templateObject17","_templateObject18","_templateObject19","_templateObject20","_templateObject21","index","_imports","imports","config","pad","parseHTML","ref_re","RegExp","WORD_LENGTH_LIMIT","String","replace","board","link_targets","searchBase","class","url","type","symbol","base","args","hooks","name","hs","indexOf","param","data","cls","arguments","setModel","locked","monogatari","image","mod","body","backlinks","banned","large","header","modInfo","subject","escape","time","postNavigation","full","expansionLinks","auth","email","href","encodeURI","resolveName","mnemonic","trip","lang","anon","staff_aliases","_time","title","text","readable","readableTime","rTime","relativeTime","Date","now","d","getDate","year","getMonth","getFullYear","week","getDay","getHours","getMinutes","seconds","getUTCDate","getUTCMonth","getUTCFullYear","getUTCDay","getUTCHours","getUTCMinutes","getUTCSeconds","then","Math","floor","isFuture","just_now","divide","unit","ago","unit_year","mnem","post","postURL","expand","lastN","last","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","action","formatLog","banMessage","_body","fragment","_this","lines","split","line","startsWith","forEach","word","parseWord","ref","match","redString","parseHashes","dest","linkClass","test","slice","link","m","tamashii","parseInt","attrs","rel","linkify","bits","dice_re","parse_dice","eLinkify","padWord","len","escaped","postRef","reveal","showThumb","thumbStyle","figcaption","IMAGE_HATS","thumbnail","list","commaList","audio","readable_filesize","size","dims","apng","hiddenToggle","imageSearch","imageLink","ext","imageURl","thumbPath","parts","mid","thumb","imagePaths","_imgPaths","mediaURL","MEDIA_URL","src","spoil","imgnm","fullName","tooLong","SECONDARY_MEDIA_URL","download","paths","width","height","thumbWidth","thumbHeight","spoiler","spoilToggle","sp","spoilerInfo","autoGif","linkAttrs","imgAttrs","style","highDef","desc_html","inner","innerCls","asideLink","./index","underscore",5,6,"socket","readyState","SockJS","OPEN","warn","stringify","DEBUG","log","on_message","shift","isPubSub","is_pubsub","handler","follow","sync_status","sync","connect","onclose","onmessage","window","location","protocol","new_socket","onopen","transports","USE_WEBSOCKETS","unshift","SOCKET_URL","SOCKET_PATH","reset_attempts","attemptTimer","clearTimeout","attempts","window_focused","rs","CONNECTING","navigator","onLine","reply","getElementById","act","connecting","syncing","connID","randomID","cookie","synced","setTimeout","DESYNC","dropped","wait","pow","min","reconnecting","close","addEventListener","hidden",7,"options","Extract","catalog","$threads","json","innerHTML","extractReplies","extractThreads","articles","getElementsByTagName","article","Article","Post","extractModel","sections","section","Section","Thread","renderOmit","hctr","getNum",8,"FSM","start","spec","acts","ons","wilds","preflights","second","pres","trans_spec","on_func","halves","tok","part","on","ev","from","to","ps","fs",9,"Memory","count","remove","purgeAll","defer",10,"readingSteiner","nextState","read","isMatch","attributes","preventDefault","address","$loading","show","xhr","XMLHttpRequest","open","onload","status","hide","alert","baseURL","responseURL","response","thread","RESYNC","live","history","pushState","scrollTo","$doc","ctrlKey","onpopstate",11,"reRenderImages","workMode","queryAll","display","getImages","each","toggleSpoilers","toggleAutoGIF","toggleAnonymisation","source","command","_model$attributes","change:thumbs","change:spoilers","change:autogif","change:anonymise","workModeTOG",12,"Cookie","expiry","needCookie","purgeExpired","bind","object","nums","keys","sort","b","join","localStorage","removeItem","getItem","val","isObject","isEmpty","setItem","bakeCookie","writeAll","limit","expired",13,"_interopRequireDefault","__esModule","default","_main","_opts","_opts2","Backbone","Model","OptionsCollection","Collection","persist","opts","getValue","optionsCollection","OptionModel","initialize","load","setValue","exec","listenTo","execListen","execOnStart","add","validate","valid","fadeout","$el","filter","fadeOut","fadein","fadeIn","addClass","click","removeClass","OptionsView","View","find","prop","fromCharCode","toUpperCase","$hidden","renderHidden","events","click .option_tab_sel>li>a","change","click #export","click #import","click #hidden","switchTab","$a","children","$li","applyChange","$target","attr","charCodeAt","export","setAttribute","URL","createObjectURL","Blob","import","$input","one","reader","FileReader","readAsText","files","result","clear","reload","clearHidden","./opts",14,"toggleHeadStyle","css","head","appendChild","parseDOM","disabled","isMobile","notMobile","LANGS","DEFAULT_LANG","langApplied","autogif","spoilertoggle","notifToggle","Notification","permission","requestPermission","RADIO","engine","ILLYA_DANCE","DEFAULT_CSS","theme","cssHash","upload","validation","reasonable_last_n","THREAD_LAST_N","shorts","short",15,"PostCommon","tagName","setElement","after","autoExpandImage","fun","../main","./common",16,"imager","Hidamari","className","redirect","anonymise","_len","_key","apply","updateBody","blockquote","renderTime","outerHTML","renderBacklinks","renderName","renderModerationInfo","getContainer","before","renderBan","renderEditing","normalize","./imager",17,"make_video","params","allowFullScreen","allowScriptAccess","autohide","modestbranding","origin","showinfo","autoplay","loop","playlist","frameborder","video_dims","screen","fetchSoundcloud","cb","encodeURIComponent","getAttribute","responseType","youtube_url_re","youtube_short_re","youtube_time_re","youtube_short_time_re","timeCall","timeRex","append","which","metaKey","altKey","shiftKey","is","$video","siblings","andSelf","gotInfo","node","orig","color","accessControl","embed","contents","nodeType","ajax","v","alt","dataType","success","soundcloud_url_re","iframe","previousElementSibling","round","innerWidth","createElement","firstChild","pastebin_re","$obj","$window","innerHeight",18,"ident","$name","$email","propagate","renderIdentity","save","$script","debounce","LOGIN_KEYWORD","clientHash",19,"renderImage","arg","manual","figure","scrollTop","getBoundingClientRect","top","thumbnailRevealed","imageExpanded","tallImage","massExpander","toggleImageExpansion","fit","fitImage","renderAudio","newWidth","newHeight","expandImage","both","widthFlag","heightFlag","aspect","fullWidth","fullHeight","maxWidth","imageMaxWidth","maxHeight","offsetHeight","closest","left","outerWidth","noMargin","isVideo","controls","lastChild","ExpanderModel","massToggle","expander","unset","getModel",20,"Menu","posting","./article","./embed","./menu","./models","./nonce","./posting","./section",21,"MenuView","actions","_popup_menu","offsetWidth","handleClick","stopPropagation","stopListening",22,"idAttribute","concat","updates","silent","moderationInfo","defaults","replies","omit","image_omit","getImageOmit",23,"nonces","postNonces","nonceCache","save_nonces","today_id","create","day","destroy","changed","yesterday","random",24,"handle_shortcut","prevent","stopImmediatePropagation","aside","togglespoiler","onToggle","$submit","finish","textSpoiler","postState","state2","expandAll","banner","querySelector","openPostBox","inputMinSize","ComposerModel","ComposerView","destination","preflight","matches","onAllocation","IMAGE_STATUS","parentNode","$buffer","$ref","refText","click #cancel","change #imageInput","input #trans","keydown #trans","click #done","click #toggle","renderButtons","change:spoiler","renderSpoilerPane","nextSpoiler","pending","line_count","char_count","inject","blockqoute","desc","you","input","rows","autocomplete","form","method","enctype","cancel","imageInput","accept","els","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","parsed","parse_name","haveTrip","tetxContent","trim","removeAttribute","resizeInput","sizer","INPUT_ROOM","max","uploading","uploaded","uploadStatus","sentAllocRequest","allocWait","submit","marginLeft","background","backgroundImage","S_BOL","touchable_spoiler_tag","$lineBuffer","$meta","$subject","maxlength","SUBJECT_MAX_LENGTH","$blockquote","$sizer","appendTo","$uploadForm","renderUploadForm","focus","$b","first","removeAttr","margin-left","$cancel","$imageInput","$uploadStatus","$toggle","$form","proxy","WEBM","$iframe","uploadError","cancelled","onImageChosen","prepareUpload","k","uploadURL","doc","contentWindow","contentDocument","unknownUpload","uploadFallbackMessage","notifyUploading","stat","unknownResult","offset","onInput","embedRewrite","rw","old","newVal","substr","diff","end","Event","video","selectionStart","selectionEnd","findTimeArg","sc","pbin","nl","lastIndexOf","ok","commit","reverse","setSelectionRange","MAX_POST_CHARS","pair","breach","MAX_POST_LINES","pop","allocationMessage","createTextNode","opt","onKeyDown","_this2","flushPending","replaceWith","padding-left","preserve","replyBox","missing","checkAgain","pick","pick_spoiler","onbeforeunload","$img","onImageAllocation","addReference","sel","isInside","gsel","parentElement","getSelection","toString","./identity",25,"nextElementSibling","renderLocked","shiftReplies","_state$page$attribute","abbrev_msg","bumpThread",26,"cacheState","lockIndicator","checkBottom","atBottom","scrollHeight","scrollY","visibility","followDOM","previous","referenceDistance","ret","elExists","referenceEl","delta","topDistance","scrollBy","contains","skipCheck","_el$getBoundingClient","bounds","selector","aboveBanner","$anchor","_document",27,"addition","reset",28,"batcTimeRender","rtime","renderTimer","timer_from_el","serverTimeOffset","maxh","maxm","maxs","moumouikkai","serverTime","finished","countdown","hour","sec","mouikkai","setInterval","GET_TIME","cursor","removeEventListener","readableUTCTime",29,"_toArray","del","imageUploadURL","hard","HTTP","getID","parseEls","string","childNodes","parseEl","once","getComputedStyle","isSage","isNode","cachedOffset","EIGHT_BALL","readableSyncwatch","readableRegularDice","bias","eq","sum","roll","metaIndex","imgs","action_link_html","resonableLastN","Number","isInteger","tripcode","secure","EXCLUDE_REGEXP","char","callSite","formatHTML","output","map","elementAttributes","str","m1","items","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","item","checkAuth","staff","classes","rights","thumbStyles","_fsm","_fsm2","radio","NativeView","channel","_deferred","execDefered","cookieVersion","boards","enabled","path","debug","tuneIn","scroll","thread_locked","amusement","client","conection","./amusement","./client","./connection","./extract","./fsm","./hide","./history","./loop","./memory","./options","./posts","./scroll","./state","./time","backbone","backbone.nativeview","backbone.radio","core-js","dom4","js-cookie","scriptjs","sockjs-client"],"mappings":"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","file":"main.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","require=(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';var _slicedToArray=(function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err) {_d=true;_e=err;}finally {try{if(!_n&&_i[\"return\"])_i[\"return\"]();}finally {if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else {throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");}};})();var main=require('./main');var $=main.$;var common=main.common;var state=main.state;var oneeSama=main.oneeSama;oneeSama.hook('imouto',function(imouto){imouto.queueRoll=function(bit){var number=this.allRolls.sent++;var info=this.allRolls[number];if(!info)info=this.allRolls[number]={};info.bit=bit;info.$tag=$(this.callback('<strong>'));this.strong=true;this.callback(info.dice?common.readable_dice(bit,info.dice):bit);this.strong=false;this.callback('</strong>');};imouto.allRolls={sent:0,seen:0};});oneeSama.hook('insertOwnPost',function(_ref){var dice=_ref.dice;var postForm=main.request('postForm');if(!postForm||!postForm.imouto||!dice)return;var rolls=postForm.imouto.allRolls;for(var i=0,lim=dice.length;i<lim;i++){var n=rolls.seen++;var info=rolls[n];if(!info)info=rolls[n]={};info.dice=dice[i];if(info.$tag){var r=common.readable_dice(info.bit,info.dice);info.$tag.html(r);}}});main.dispatcher[common.EXECUTE_JS]=function(_ref2){var _ref3=_slicedToArray(_ref2,1);var js=_ref3[0];try{eval(js);}catch(e) {console.error(e);}};\n\n},{\"./main\":\"main\"}],2:[function(require,module,exports){\n'use strict';var _$extend;var _slicedToArray=(function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err) {_d=true;_e=err;}finally {try{if(!_n&&_i[\"return\"])_i[\"return\"]();}finally {if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else {throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");}};})();function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj;}var main=require('./main');var _=main._;var common=main.common;var dispatcher=main.dispatcher;var util=main.util;var posts=main.posts;var state=main.state;var online=document.query('#onlineCount');_.extend(dispatcher,(_$extend={},_defineProperty(_$extend,common.INSERT_POST,function(message){var _message=_slicedToArray(message,2);var msg=_message[0];var bump=_message[1];bump=bump&&state.page.get('live');var isThread=!msg.op;var num=msg.num;if(isThread)state.syncs[num]=1;msg.editing=true;var el=undefined;var nonce=msg.nonce;delete msg.nonce;var myNonce=main.request('nonce:get')[nonce];if(myNonce&&myNonce.tab===state.page.get('tabID')){state.ownPosts[num]=true;main.oneeSama.trigger('insertOwnPost',msg);main.postSM.feed('alloc',msg);bump=false;main.request('nonce:destroy',nonce);var postForm=main.request('postForm');if(postForm&&postForm.el)el=postForm.el;}if(myNonce){msg.mine=true;state.mine.write(num);}state.addLinks(msg.links);var model=new posts.models[isThread?'Thread':'Post'](msg);var view=new posts[isThread?'Section':'Article']({model:model,el:el,id:num});if(!el)view.render().insertIntoDOM();view.clientInit();checkRepliedToMe(msg.links,num);main.request('post:inserted',model);if(isThread)return;var parent=state.posts.get(msg.op);if(!parent)return;parent.get('replies').push(num);if(state.page.get('thread'))return;parent.dispatch('shiftReplies');if(bump)parent.dispatch('bumpThread');}),_defineProperty(_$extend,common.INSERT_IMAGE,function(msg){var _msg=_slicedToArray(msg,2);var num=_msg[0];var img=_msg[1];var postModel=main.request('postModel'),toPostForm=postModel&&postModel.get('num')==num;if(toPostForm)main.request('postForm').insertUploaded(img);modelHandler(num,function(model){return model.setImage(img,toPostForm);});}),_defineProperty(_$extend,common.UPDATE_POST,function(_ref){var _ref2=_slicedToArray(_ref,3);var num=_ref2[0];var frag=_ref2[1];var _ref2$=_ref2[2];var extra=_ref2$===undefined?{}:_ref2$;modelHandler(num,function(model){state.addLinks(extra.links);model.update(frag,extra);checkRepliedToMe(extra.links,num);if(num in state.ownPosts)main.oneeSama.trigger('insertOwnPost',extra);else model.dispatch('updateBody',frag);});}),_defineProperty(_$extend,common.FINISH_POST,function(msg){var _msg2=_slicedToArray(msg,1);var num=_msg2[0];delete state.ownPosts[num];modelHandler(num,function(model){model.set('editing',false);model.dispatch('renderEditing',false);});}),_defineProperty(_$extend,common.DELETE_POSTS,function(msg){modelHandler(msg[0],function(model){return model.deletePost(msg[1]);});}),_defineProperty(_$extend,common.LOCK_THREAD,function(msg){modelHandler(msg[0],function(model){return model.toggleLocked(true,msg[1]);});}),_defineProperty(_$extend,common.UNLOCK_THREAD,function(msg){modelHandler(msg[0],function(model){return model.toggleLocked(false,msg[1]);});}),_defineProperty(_$extend,common.DELETE_IMAGES,function(msg){modelHandler(msg[0],function(model){return model.removeImage(msg[1]);});}),_defineProperty(_$extend,common.SPOILER_IMAGES,function(msg){modelHandler(msg[0],function(model){return model.setSpoiler(msg[1],msg[2]);});}),_defineProperty(_$extend,common.BAN,function(msg){var _msg3=_slicedToArray(msg,2);var num=_msg3[0];var info=_msg3[1];if(!num){if(!info)return;info=JSON.parse(info);num=info.num;}modelHandler(num,function(model){return model.setBan(num,info);});}),_defineProperty(_$extend,common.BACKLINK,function(msg){modelHandler(msg[0],function(model){return model.addBacklink(msg[1],msg[2]);});}),_defineProperty(_$extend,common.ONLINE_COUNT,function(msg){online.textContent='['+msg[0]+']';}),_defineProperty(_$extend,common.HOT_INJECTION,function(msg){var _msg4=_slicedToArray(msg,3);var force=_msg4[0];var hash=_msg4[1];var hotConfig=_msg4[2];if(!force&&hash!==state.configHash)main.send([common.HOT_INJECTION,true]);else if(force){state.configHash=hash;state.hotConfig.set(hotConfig);}}),_$extend));dispatcher[common.SYNCHRONIZE]=main.connSM.feeder('sync');dispatcher[common.INVALID]=main.connSM.feeder('invalid');function checkRepliedToMe(links,sourceNum){if(!links)return;var mine=state.mine.readAll();for(var num in links){if(num in mine)main.request('repliedToMe',sourceNum);}}function modelHandler(num,func){var model=state.posts.get(num);if(model)func(model);}util.listener(document,'click','del',function(event){if(event.spoilt)return;event.spoilt=true;event.target.classList.toggle('reveal');});\n\n},{\"./main\":\"main\"}],3:[function(require,module,exports){\n'use strict';module.exports=exports=require('./util');exports.OneeSama=require('./oneesama');\n\n},{\"./oneesama\":4,\"./util\":5}],4:[function(require,module,exports){\n'use strict';var _createClass=(function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if(\"value\" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};})();var _templateObject=_taggedTemplateLiteral(['>>(d+|>/watch?v=[w-]{11}(?:#t=[dhms]{1,9})?\\n\\t\\t|>/soundcloud/[w-]{1,40}/[w-]{1,80}|>/pastebin/w+'],['>>(\\\\d+|>\\\\/watch\\\\?v=[\\\\w-]{11}(?:#t=[\\\\dhms]{1,9})?\\n\\t\\t|>\\\\/soundcloud\\\\/[\\\\w-]{1,40}\\\\/[\\\\w-]{1,80}|>\\\\/pastebin\\\\/\\\\w+']),_templateObject2=_taggedTemplateLiteral(['|>/','/(?:w+/?)?'],['|>\\\\/','\\\\/(?:\\\\w+\\\\/?)?']),_templateObject3=_taggedTemplateLiteral(['<a target=\"_blank\"\\n\\t\\t\\t\\t\\trel=\"nofollow\"\\n\\t\\t\\t\\t\\tclass=\"imageSearch ','\"\\n\\t\\t\\t\\t\\thref=\"',''],['<a target=\"_blank\"\\n\\t\\t\\t\\t\\trel=\"nofollow\"\\n\\t\\t\\t\\t\\tclass=\"imageSearch ','\"\\n\\t\\t\\t\\t\\thref=\"','']),_templateObject4=_taggedTemplateLiteral(['<section id=\"p','\" class=\"','\">\\n\\t\\t\\t\\t<div class=\"background glass\">\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t\\t<span class=\"omit\"></span>\\n\\t\\t\\t\\t</div>\\n\\t\\t\\t</section>'],['<section id=\"p','\" class=\"','\">\\n\\t\\t\\t\\t<div class=\"background glass\">\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t\\t<span class=\"omit\"></span>\\n\\t\\t\\t\\t</div>\\n\\t\\t\\t</section>']),_templateObject5=_taggedTemplateLiteral(['<article id=\"p','\" class=\"','\">\\n\\t\\t\\t\\t','\\n\\t\\t\\t</article>'],['<article id=\"p','\" class=\"','\">\\n\\t\\t\\t\\t','\\n\\t\\t\\t</article>']),_templateObject6=_taggedTemplateLiteral(['','\\n\\t\\t\\t','\\n\\t\\t\\t<div class=\"container\">\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t<blockquote>\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</blockquote>\\n\\t\\t\\t\\t<small>\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</small>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</div>'],['','\\n\\t\\t\\t','\\n\\t\\t\\t<div class=\"container\">\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t<blockquote>\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</blockquote>\\n\\t\\t\\t\\t<small>\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</small>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</div>']),_templateObject7=_taggedTemplateLiteral(['<header>\\n\\t\\t\\t\\t<input type=\"checkbox\" class=\"postCheckbox\">\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t</header>\\n\\t\\t\\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>'],['<header>\\n\\t\\t\\t\\t<input type=\"checkbox\" class=\"postCheckbox\">\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t</header>\\n\\t\\t\\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>']),_templateObject8=_taggedTemplateLiteral(['<a ','>'],['<a ','>']),_templateObject9=_taggedTemplateLiteral(['<time title=\"','\">\\n\\t\\t\\t\\t','\\n\\t\\t\\t</time>'],['<time title=\"','\">\\n\\t\\t\\t\\t','\\n\\t\\t\\t</time>']),_templateObject10=_taggedTemplateLiteral(['<nav>\\n\\t\\t\\t\\t<a href=\"','\" class=\"history\">\\n\\t\\t\\t\\t\\tNo.\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t\\t<a href=\"','\" class=\"quote\">\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</nav>'],['<nav>\\n\\t\\t\\t\\t<a href=\"','\" class=\"history\">\\n\\t\\t\\t\\t\\tNo.\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t\\t<a href=\"','\" class=\"quote\">\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</nav>']),_templateObject11=_taggedTemplateLiteral(['<span class=\"act expansionLinks\">\\n\\t\\t\\t\\t<a href=\"','\" class=\"history\">\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t\\t] [\\n\\t\\t\\t\\t<a href=\"','?last=','\" class=\"history\">\\n\\t\\t\\t\\t\\t',' ','\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</span>'],['<span class=\"act expansionLinks\">\\n\\t\\t\\t\\t<a href=\"','\" class=\"history\">\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t\\t] [\\n\\t\\t\\t\\t<a href=\"','?last=','\" class=\"history\">\\n\\t\\t\\t\\t\\t',' ','\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</span>']),_templateObject12=_taggedTemplateLiteral(['^>/(',')/(w+/?)?'],['^>\\\\/(',')\\\\/(\\\\w+\\\\/?)?']),_templateObject13=_taggedTemplateLiteral(['<a ','>\\n\\t\\t\\t\\t>>','\\n\\t\\t\\t</a>'],['<a ','>\\n\\t\\t\\t\\t>>','\\n\\t\\t\\t</a>']),_templateObject14=_taggedTemplateLiteral(['<a href=\"','\" rel=\"nofollow\" target=\"_blank\">\\n\\t\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t\\t</a>'],['<a href=\"','\" rel=\"nofollow\" target=\"_blank\">\\n\\t\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t\\t</a>']),_templateObject15=_taggedTemplateLiteral(['<figure>\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t</figure>'],['<figure>\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t</figure>']),_templateObject16=_taggedTemplateLiteral(['<figcaption>\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t<span>\\n\\t\\t\\t\\t\\t(',')\\n\\t\\t\\t\\t</span>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</figcaption>'],['<figcaption>\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t<span>\\n\\t\\t\\t\\t\\t(',')\\n\\t\\t\\t\\t</span>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</figcaption>']),_templateObject17=_taggedTemplateLiteral(['<a class=\"imageToggle\">\\n\\t\\t\\t\\t[',']\\n\\t\\t\\t</a>'],['<a class=\"imageToggle\">\\n\\t\\t\\t\\t[',']\\n\\t\\t\\t</a>']),_templateObject18=_taggedTemplateLiteral(['<a ','>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</a>'],['<a ','>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</a>']),_templateObject19=_taggedTemplateLiteral(['<a ','>\\n\\t\\t\\t\\t<img ','>\\n\\t\\t\\t</a>'],['<a ','>\\n\\t\\t\\t\\t<img ','>\\n\\t\\t\\t</a>']),_templateObject20=_taggedTemplateLiteral(['','','','.png'],['','','','.png']),_templateObject21=_taggedTemplateLiteral(['<aside class=\"act glass ','\">\\n\\t\\t\\t\\t<a ','\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t>\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</aside>'],['<aside class=\"act glass ','\">\\n\\t\\t\\t\\t<a ','\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t>\\n\\t\\t\\t\\t\\t','\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</aside>']);function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError(\"Cannot call a class as a function\");}}function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}var _=require('underscore');var index=require('./index');var util=require('./util');var _imports=imports;var config=_imports.config;var pad=util.pad;var parseHTML=util.parseHTML;var break_re=new RegExp(\"(\\\\S{\"+index.WORD_LENGTH_LIMIT+\"})\");var ref_re=(function(){var ref_re=String.raw(_templateObject).replace(/[\\n\\t]+/gm,'');for(var board in config.link_targets){ref_re+=String.raw(_templateObject2,board);}ref_re+=')';return new RegExp(ref_re);})();var searchBase=(function(){var models=[{class:'google',url:'https://www.google.com/searchbyimage?image_url=',type:'thumb',symbol:'G'},{class:'iqdb',url:'http://iqdb.org/?url=',type:'thumb',symbol:'Iq'},{class:'saucenao',url:'http://saucenao.com/search.php?db=999&url=',type:'thumb',symbol:'Sn'},{class:'desustorage',type:'MD5',url:'https://desustorage.org/_/search/image/',symbol:'Ds'},{class:'exhentai',type:'SHA1',url:'http://exhentai.org/?fs_similar=1&fs_exp=1&f_shash=',symbol:'Ex'}];var base=[];for(var i=0,l=models.length;i<l;i++){var model=models[i];base[i]=[parseHTML(_templateObject3,model.class,model.url),model.type,'\">'+model.symbol+'</a>'];}return base;})();var OneeSama=(function(){function OneeSama(args){_classCallCheck(this,OneeSama);_.extend(this,args);this.hooks={};}_createClass(OneeSama,[{key:'hook',value:function hook(name,func){var hs=this.hooks[name];if(!hs)this.hooks[name]=[func];else if(hs.indexOf(func)<0)hs.push(func);}},{key:'trigger',value:function trigger(name,param){var hs=this.hooks[name];if(!hs)return;for(var i=0;i<hs.length;i++){hs[i].call(this,param);}}},{key:'section',value:function section(data){var cls=arguments.length<=1||arguments[1]===undefined?'':arguments[1];this.setModel(data);if(data.locked)cls+=' locked';if(data.editing)cls+=' editing';return parseHTML(_templateObject4,data.num,cls,this.monogatari(data));}},{key:'article',value:function article(data){this.setModel(data);var cls='glass';if(data.editing)cls+=' editing';return parseHTML(_templateObject5,data.num,cls,this.monogatari(data));}},{key:'setModel',value:function setModel(model){this.model=model;this.state=[0,0,0,0];return this;}},{key:'monogatari',value:function monogatari(data){var image=data.image;var mod=data.mod;var body=data.body;var backlinks=data.backlinks;var banned=data.banned;if(image&&!data.op)image.large=true;return parseHTML(_templateObject6,this.header(data),image&&this.image(image),mod&&this.modInfo(mod),this.body(body),this.backlinks(backlinks),banned&&this.banned());}},{key:'header',value:function header(data){return parseHTML(_templateObject7,data.subject&&'<h3>'+_.escape(data.subject)+'</h3>',this.name(data),this.time(data.time),this.postNavigation(data),!this.full&&!data.op&&this.expansionLinks(data.num));}},{key:'name',value:function name(data){var html='<b class=\"name';var auth=data.auth;var email=data.email;if(auth)html+=' '+(auth==='admin'?'admin':'moderator');html+='\">';if(email){html+=parseHTML(_templateObject8,{class:'email',href:'mailto:'+encodeURI(email),target:'blank'});}html+=this.resolveName(data);if(email)html+='</a>';html+='</b>';if(data.mnemonic)html+=' '+this.mnemonic(data.mnemonic);return html;}},{key:'resolveName',value:function resolveName(data){var html='';var trip=data.trip;var name=data.name;var auth=data.auth;if(name||!trip){if(name)html+=_.escape(name);else html+=this.lang.anon;if(trip)html+=' ';}if(trip)html+='<code>'+_.escape(trip)+'</code>';if(auth)html+=' ## '+(imports.hotConfig.staff_aliases[auth]||auth);return html;}},{key:'time',value:function time(_time){var title=undefined,text=undefined;var readable=this.readableTime(_time);if(this.rTime){title=readable;text=this.relativeTime(_time,Date.now());}return parseHTML(_templateObject9,title,text||readable);}},{key:'readableTime',value:function readableTime(time){var d=new Date(time);return pad(d.getDate())+' '+this.lang.year[d.getMonth()]+' '+d.getFullYear()+('('+this.lang.week[d.getDay()]+')')+(pad(d.getHours())+':'+pad(d.getMinutes()));}},{key:'readableUTCTime',value:function readableUTCTime(d,seconds){var html=pad(d.getUTCDate())+' '+this.lang.year[d.getUTCMonth()]+' '+d.getUTCFullYear()+('('+this.lang.week[d.getUTCDay()]+')')+(pad(d.getUTCHours())+':'+pad(d.getUTCMinutes()));if(seconds)html+=':'+pad(d.getUTCSeconds());html+=' UTC';return html;}},{key:'relativeTime',value:function relativeTime(then,now){var time=Math.floor((now-then)/60000),isFuture=undefined;if(time<1){if(time>-5)return this.lang.just_now;else {isFuture=true;time=-time;}}var divide=[60,24,30,12],unit=['minute','hour','day','month'];for(var i=0;i<divide.length;i++){if(time<divide[i])return this.lang.ago(time,this.lang['unit_'+unit[i]],isFuture);time=Math.floor(time/divide[i]);}return this.lang.ago(time,this.lang.unit_year,isFuture);}},{key:'mnemonic',value:function mnemonic(mnem){return '<b class=\"mod addr\">'+mnem+'</b>';}},{key:'postNavigation',value:function postNavigation(post){var num=post.num,op=post.op;return parseHTML(_templateObject10,this.postURL(num,op),this.postURL(num,op),num);}},{key:'postURL',value:function postURL(num,op){op=op||num;return (this.op==op?'':op)+'#'+num;}},{key:'expansionLinks',value:function expansionLinks(num){return parseHTML(_templateObject11,num,this.lang.expand,num,this.lastN,this.lang.last,this.lastN);}},{key:'modInfo',value:function modInfo(info){var html='<b class=\"modLog admin\">';var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=info[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var action=_step.value;html+=this.lang.mod.formatLog(action)+'<br>';}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}html+='</b>';return html;}},{key:'banned',value:function banned(){return '<b class=\"admin banMessage\">'+this.lang.mod.banMessage+'</b>';}},{key:'body',value:function body(_body){var html=this.fragment(_body);if(this.state[1])html+='</em>';if(this.state[2])html+='</del>';return html;}},{key:'fragment',value:function fragment(frag){var _this=this;var lines=frag.split('\\n');var state=this.state;var html='';for(var i=0;i<lines.length;i++){if(state[0]&&i%2){if(state[1]%2){html+='</em>';state[1]++;}html+='<br>';state[0]=0;}var line=lines[i];if(!state[0]&&line.startsWith('>')){html+='<em>';state[1]++;}if(frag){line.split(' ').forEach(function(word){return html+=_this.parseWord(word);});state[0]=1;}}return html;}},{key:'parseWord',value:function parseWord(word){var split=word.split(/\\[\\/?spoiler]/i);var html='';for(var i=0;i<split.length;i++){if(i%2){html+='<'+(this.state[2]%2?'/':'')+'del>';this.state[2]++;}var bit=split[i];var ref=bit.match(ref_re);if(ref){html+=this.redString(ref[1]);bit=bit.replace(ref_re,'');}html+=this.parseHashes(bit);}return html;}},{key:'redString',value:function redString(ref){var dest=undefined,linkClass=undefined;if(/^>\\/watch/.test(ref)){dest='https://www.youtube.com/'+ref.slice(2);linkClass='embed watch';}else if(/^>\\/soundcloud/.test(ref)){dest='https://soundcloud.com/'+ref.slice(13);linkClass='embed soundcloud';}else if(/^>\\/pastebin/.test(ref)){dest='https://pastebin.com/'+ref.slice(11);linkClass='embed pastebin';}for(var link in config.link_targets){var m=ref.match(new RegExp(String.raw(_templateObject12,link)));if(!m)continue;dest=config.link_targets[link];if(m[2])dest+=m[2];break;}if(!dest)return this.tamashii(parseInt(ref,10));var attrs={href:encodeURI(dest),target:'_blank',rel:'nofollow',class:linkClass};return parseHTML(_templateObject13,attrs,_.escape(ref));}},{key:'parseHashes',value:function parseHashes(text){if(!this.model.dice)return this.linkify(text);var html='';var bits=text.split(util.dice_re);for(var i=0;i<bits.length;i++){var bit=bits[i];if(!(i%2)||!util.parse_dice(bit))html+=this.linkify(bit);else if(this.queueRoll)this.queueRoll(bit);else {if(this.state[0])html+=' ';var dice=this.model.dice[this.state[3]++];html+='<strong>'+util.readable_dice(bit,dice)+'</strong>';}}return html;}},{key:'linkify',value:function linkify(text){if(!this.eLinkify)return this.padWord(_.escape(text));var html='';var bits=text.split(/(https?:\\/\\/[^\\s\"<>]*[^\\s\"<>'.,!?:;])/);for(var i=0,len=bits.length;i<len;i++){var escaped=_.escape(bits[i]);if(i%2){html+=parseHTML(_templateObject14,escaped,this.padWord(escaped));}else if(escaped)html+=this.padWord(escaped);}return html;}},{key:'padWord',value:function padWord(word){if(this.state[0])word=' '+word;return word;}},{key:'backlinks',value:function backlinks(links){if(!links)return '';var html='';for(var num in links){if(html)html+=' ';html+=this.postRef(num,links[num]);}return html;}},{key:'image',value:function image(data,reveal){var showThumb=this.thumbStyle!=='hide'||reveal;return parseHTML(_templateObject15,this.figcaption(data,reveal),showThumb&&config.IMAGE_HATS&&'<span class=\"hat\"></span>',showThumb&&this.thumbnail(data));}},{key:'figcaption',value:function figcaption(data,reveal){var list=util.commaList([data.audio&&'',data.length,util.readable_filesize(data.size),data.dims[0]+'x'+data.dims[1],data.apng&&'APNG']);return parseHTML(_templateObject16,this.thumbStyle==='hide'&&this.hiddenToggle(reveal),this.imageSearch(data),list,this.imageLink(data));}},{key:'hiddenToggle',value:function hiddenToggle(reveal){return parseHTML(_templateObject17,this.lang[reveal?'hide':'show']);}},{key:'imageSearch',value:function imageSearch(data){var html='';var base=searchBase;if(['.pdf','.mp3'].indexOf(data.ext)>-1)base=[base[0]];var imageURl=this.thumbPath(data);for(var i=0,l=base.length;i<l;i++){var parts=base[i];html+=parts[0]+encodeURI(parts[1]!=='thumb'?data[parts[1]]:imageURl)+parts[2];}return html;}},{key:'thumbPath',value:function thumbPath(data,mid){var type='thumb';if(mid&&data.mid)type='mid';else if(!data.thumb)type='src';return this.imagePaths()[type]+data[type];}},{key:'imagePaths',value:function imagePaths(){if(!this._imgPaths){var mediaURL=config.MEDIA_URL;this._imgPaths={src:mediaURL+'src/',thumb:mediaURL+'thumb/',mid:mediaURL+'mid/',spoil:mediaURL+'spoil/spoiler'};}return this._imgPaths;}},{key:'imageLink',value:function imageLink(data){var name='',imgnm=data.imgnm;var m=imgnm.match(/^(.*)\\.\\w{3,4}$/);if(m)name=m[1];var fullName=_.escape(imgnm),tooLong=name.length>=38;if(tooLong)imgnm=_.escape(name.slice(0,30))+'(&hellip;)'+_.escape(data.ext);var attrs={href:config.SECONDARY_MEDIA_URL+'src/'+data.src,rel:'nofollow',download:fullName};if(tooLong)attrs.title=fullName;return parseHTML(_templateObject18,attrs,imgnm);}},{key:'thumbnail',value:function thumbnail(data,href){var paths=this.imagePaths(),dims=data.dims;var src=paths.src+data.src,thumb=undefined,width=dims[0],height=dims[1],thumbWidth=dims[2],thumbHeight=dims[3];if(data.spoiler&&this.spoilToggle){var sp=this.spoilerInfo(data);thumb=sp.thumb;thumbWidth=sp.dims[0];thumbHeight=sp.dims[1];}else if(data.ext==='.gif'&&this.autoGif)thumb=src;else thumb=this.thumbPath(data,this.thumbStyle!=='small');if(!thumbWidth){thumbWidth=width;thumbHeight=height;}var linkAttrs={target:'_blank',rel:'nofollow',href:href||src};var imgAttrs={src:thumb,width:thumbWidth,height:thumbHeight};if(href){linkAttrs.class='history';imgAttrs.class='expanded';if(this.thumbStyle=='hide')imgAttrs.style='display: none';}return parseHTML(_templateObject19,linkAttrs,imgAttrs);}},{key:'spoilerInfo',value:function spoilerInfo(data){var highDef=data.large||this.thumbStyle!=='small';return {thumb:parseHTML(_templateObject20,this.imagePaths().spoil,highDef&&'s',data.spoiler),dims:config[data.large?'THUMB_DIMENSIONS':'PINKY_DIMENSIONS']};}},{key:'postRef',value:function postRef(num,op,desc_html){var ref='&gt;&gt;'+num;if(desc_html)ref+=' '+desc_html;if(this.op&&this.op!=op)ref+=' ';else if(num==op&&this.op==op)ref+=' (OP)';return '<a href=\"'+this.postURL(num,op)+'\" class=\"history\">'+ref+'</a>';}},{key:'asideLink',value:function asideLink(inner,href,cls,innerCls){return parseHTML(_templateObject21,cls,href&&'href=\"'+href+'\"',innerCls&&' class=\"'+innerCls+'\"',this.lang[inner]||inner);}},{key:'replyBox',value:function replyBox(){return this.asideLink('reply',null,'posting');}},{key:'newThreadBox',value:function newThreadBox(){return this.asideLink('newThread',null,'posting');}}]);return OneeSama;})();module.exports=OneeSama;\n\n},{\"./index\":3,\"./util\":5,\"underscore\":undefined}],5:[function(require,module,exports){\n\"use strict\";\n\n},{}],6:[function(require,module,exports){\n'use strict';var main=require('./main');var _=main._;var common=main.common;var config=main.config;var connSM=main.connSM;var state=main.state;var SockJS=main.SockJS;var lang=main.lang.sync;var socket=undefined,attempts=undefined,attemptTimer=undefined;function send(msg){if(connSM.state!='synced'&&connSM.state!='syncing')return;if(socket.readyState!=SockJS.OPEN){if(console)console.warn(\"Attempting to send while socket closed\");return;}msg=JSON.stringify(msg);if(config.DEBUG)console.log('<',msg);socket.send(msg);}main.reply('send',send);function on_message(e){if(config.DEBUG)console.log('>',e.data);var msg=JSON.parse(e.data)[0],op=msg.shift(),type=msg.shift(),isPubSub=common.is_pubsub(type);if(isPubSub&&connSM.state==='locked')return;var handler=main.dispatcher[type];if(!handler)return;if(isPubSub&&op in state.syncs)state.syncs[op]++;main.follow(function(){return handler(msg,op);});}var sync=document.getElementById('sync');function sync_status(msg){sync.textContent=msg;}connSM.act('load + start -> conn',function(){sync_status(lang.connecting);attempts=0;connect();});function connect(){if(socket){socket.onclose=null;socket.onmessage=null;}if(window.location.protocol=='file:'){console.log(\"Page downloaded locally; refusing to sync.\");return;}socket=new_socket();socket.onopen=connSM.feeder('open');socket.onclose=connSM.feeder('close');socket.onmessage=on_message;if(config.DEBUG)window.socket=socket;}function new_socket(){var transports=['xdr-streaming','xhr-streaming','iframe-eventsource','iframe-htmlfile','xdr-polling','xhr-polling','iframe-xhr-polling','jsonp-polling'];if(config.USE_WEBSOCKETS)transports.unshift('websocket');return new SockJS(config.SOCKET_URL||config.SOCKET_PATH,null,{transports:transports});}connSM.act('conn, reconn + open -> syncing',function(){sync_status(lang.syncing);var connID=common.randomID(32);var page=state.page;page.set('connID',connID);send([common.SYNCHRONIZE,connID,page.get('board'),state.syncs,page.get('live'),document.cookie]);});connSM.act('syncing + sync -> synced',function(){sync_status(lang.synced);attemptTimer=setTimeout(function(){attemptTimer=0;reset_attempts();},10000);});function reset_attempts(){if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}attempts=0;}connSM.act('synced, syncing + lock -> locked');connSM.act('locked + unlock -> synced');main.reply('connection:lock',function(){return send([common.DESYNC]);},connSM.feed('lock'));main.reply('connection:unlock',function(msg){return send(msg);},connSM.feed('unlock'));connSM.act('* + close -> dropped',function(error){if(socket){socket.onclose=null;socket.onmessage=null;}if(config.DEBUG)console.error('E:',error);if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}sync_status(lang.dropped);var wait=500*Math.pow(1.5,Math.min(Math.floor(++attempts/2),12));setTimeout(connSM.feeder('retry'),wait);});connSM.act('dropped + retry -> reconn',function(){connect();setTimeout(function(){if(connSM.state=='reconn')sync_status(lang.reconnecting);},100);});connSM.act('* + invalid, desynced + close -> desynced',function(msg){msg=msg&&msg[0]?'Out of sync: '+msg[0]:'Out of sync';sync_status(msg);if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}socket.onclose=null;socket.onmessage=null;socket.close();socket=null;if(config.DEBUG)window.socket=null;});function window_focused(){switch(connSM.state){case 'desynced':return;case 'synced':case 'syncing':case 'conn':var rs=socket.readyState;if(rs!=SockJS.OPEN&&rs!=SockJS.CONNECTING){connSM.feed('close');return;}else if(navigator.onLine===false){connSM.feed('close');return;}break;}connSM.feed('retry');}connSM.feed('start');document.addEventListener('visibilitychange',function(e){if(e.target.hidden)return;setTimeout(window_focused,20);});window.addEventListener('online',function(){return reset_attempts();},connSM.feed('retry'));window.addEventListener('offline',connSM.feeder('close'));\n\n},{\"./main\":\"main\"}],7:[function(require,module,exports){\n'use strict';var _createClass=(function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if(\"value\" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};})();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError(\"Cannot call a class as a function\");}}var main=require('./main');var _=main._;var util=main.util;var options=main.options;var state=main.state;var posts=main.posts;var Extract=(function(){function Extract(catalog){_classCallCheck(this,Extract);var el=main.$threads[0];var json=JSON.parse(document.getElementById('postData').innerHTML);main.request('notify:title',json.title);if(catalog)return;var mine=this.mine=state.mine.readAll(),posts=this.posts=json.posts;this.extractReplies(el);this.extractThreads(el);state.addLinks(json.links);for(var post in posts){var links=posts[post].links;if(!links)continue;for(var num in links){if(num in mine)main.request('repliedToMe',posts[post].num);}}if(options.get('anonymise'))main.request('loop:anonymise');main.request('time:render');}_createClass(Extract,[{key:'extractReplies',value:function extractReplies(el){var articles=el.getElementsByTagName('article');for(var i=0,l=articles.length;i<l;i++){var article=articles[i];new posts.Article({model:new posts.models.Post(this.extractModel(article)),el:article});}}},{key:'extractThreads',value:function extractThreads(el){var sections=el.getElementsByTagName('section');for(var i=0;i<sections.length;i++){var section=sections[i];var model=this.extractModel(section);new posts.Section({model:new posts.models.Thread(model),el:section}).renderOmit();state.syncs[model.num]=model.hctr;}}},{key:'extractModel',value:function extractModel(el){var info=this.posts[util.getNum(el)];if(info.num in this.mine)info.mine=true;return info;}}]);return Extract;})();module.exports=Extract;new Extract(state.page.get('catalog'));\n\n},{\"./main\":\"main\"}],8:[function(require,module,exports){\n'use strict';var _createClass=(function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if(\"value\" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};})();Object.defineProperty(exports,\"__esModule\",{value:true});function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError(\"Cannot call a class as a function\");}}3;var FSM=(function(){function FSM(start){_classCallCheck(this,FSM);this.state=start;this.spec={acts:{},ons:{},wilds:{},preflights:{}};}_createClass(FSM,[{key:'clone',value:function clone(){var second=new FSM(this.state);second.spec=this.spec;return second;}},{key:'on',value:function on(key,f){var ons=this.spec.ons[key];if(ons){ons.push(f);}else {this.spec.ons[key]=[f];}}},{key:'preflight',value:function preflight(key,f){var pres=this.spec.preflights[key];if(pres){pres.push(f);}else {this.spec.preflights[key]=[f];}}},{key:'act',value:function act(trans_spec,on_func){var halves=trans_spec.split('->');if(halves.length!=2){throw new Error(\"Bad FSM spec: \"+trans_spec);}var parts=halves[0].split(','),dest=halves[1].match(/^\\s*(\\w+)\\s*$/)[1];var tok=undefined;for(var i=parts.length-1;i>=0;i--){var part=parts[i],m=part.match(/^\\s*(\\*|\\w+)\\s*(?:\\+\\s*(\\w+)\\s*)?$/);if(!m){throw new Error(\"Bad FSM spec portion: \"+part);}if(m[2]){tok=m[2];}if(!tok){throw new Error(\"Tokenless FSM action: \"+part);}var src=m[1];if(src=='*'){this.spec.wilds[tok]=dest;}else {var acts=this.spec.acts[src];if(!acts){this.spec.acts[src]=acts={};}acts[tok]=dest;}}if(on_func){this.on(dest,on_func);}}},{key:'feed',value:function feed(ev,param){var spec=this.spec;var from=this.state;var acts=spec.acts[from];var to=acts&&acts[ev]||spec.wilds[ev];if(to&&from!=to){var ps=spec.preflights[to];for(var i=0;ps&&i<ps.length;i++){if(!ps[i].call(this,param)){return false;}}this.state=to;var fs=spec.ons[to];for(var i=0;fs&&i<fs.length;i++){fs[i].call(this,param);}}return true;}},{key:'feeder',value:function feeder(ev){var _this=this;return function(param){return _this.feed(ev,param);};}}]);return FSM;})();exports.default=FSM;\n\n},{}],9:[function(require,module,exports){\n'use strict';var main=require('./main');var hidden=new main.Memory('hide',7,true);main.reply('hide',function(model){if(model.get('mine'))return;var count=hidden.write(model.get('num'));model.remove();main.request('hide:render',count);});main.reply('hide:clear',function(){return hidden.purgeAll();});main.defer(function(){return main.request('hide:render',hidden.size());});\n\n},{\"./main\":\"main\"}],10:[function(require,module,exports){\n'use strict';var main=require('./main');var $=main.$;var _=main._;var common=main.common;var Extract=main.Extract;var state=main.state;main.$doc.on('click','a.history',function(event){if(event.ctrlKey)return;readingSteiner(this.href,event);});var $loading=$('#loadingImage');main.reply('loading:show',function(){return $loading.show();});main.reply('loading:hide',function(){return $loading.hide();});function readingSteiner(url,event){var nextState=state.read(url);if(_.isMatch(state.page.attributes,nextState))return;main.request('connection:lock');if(event)event.preventDefault();var split=url.split('#');var address=split[0]+(/\\?/.test(split[0])?'&':'?')+'minimal=true';if(split.length!==1)address+='#'+split[1];$loading.show();var xhr=new XMLHttpRequest();xhr.open('GET',address);xhr.onload=function(){if(this.status!==200){$loading.hide();return alert(this.status);}if(baseURL(url)!==baseURL(this.responseURL))nextState=state.read(this.responseURL);main.request('postSM:feed','done');main.trigger('state:clear');main.$threads[0].innerHTML=this.response;state.page.set(nextState);main.oneeSama.op=nextState.thread;new Extract(nextState.catalog);if(!nextState.catalog){main.request('connection:unlock',[common.RESYNC,nextState.board,state.syncs,nextState.live]);}if(event){history.pushState(null,null,nextState.href);if(location.hash)main.request('scroll:aboveBanner');else window.scrollTo(0,0);}$loading.hide();};xhr.send();}function baseURL(url){return url.split(/[\\?#]/)[0];}window.onpopstate=function(event){readingSteiner(event.target.location.href);main.request('scroll:aboveBanner');};\n\n},{\"./main\":\"main\"}],11:[function(require,module,exports){\n'use strict';var main=require('./main');var util=main.util;var follow=main.follow;var options=main.options;var oneeSama=main.oneeSama;var posts=main.state.posts;options.on({'change:thumbs':reRenderImages,'change:spoilers':toggleSpoilers,'change:autogif':toggleAutoGIF,'change:anonymise':toggleAnonymisation,'workModeTOG':reRenderImages});function reRenderImages(){if(main.state.page.get('catalog')){(function(){var show=options.get(\"thumbs\")!=='hide'&&!main.oneeSama.workMode?'':'none';document.queryAll(\".expanded\").forEach(function(el){return el.style.display=show;});})();}else follow(function(){return getImages(function(image,model){return image&&model.dispatch('renderImage',image);});});}function getImages(func){posts.each(function(model){return func(model.get('image'),model);});}function toggleSpoilers(){follow(function(){return getImages(function(image,model){return image&&image.spoiler&&model.dispatch('renderImage',image);});});}function toggleAutoGIF(){follow(function(){return getImages(function(image,model){return image&&image.ext==='.gif'&&model.dispatch('renderImage',image);});});}function toggleAnonymisation(source,toggle){follow(function(){var command=toggle?'anonymise':'renderName';posts.each(function(model){var _model$attributes=model.attributes;var name=_model$attributes.name;var trip=_model$attributes.trip;if(name||trip)model.dispatch(command);});});}main.reply('loop:anonymise',function(){return options.get('anonymise')&&toggleAnonymisation(null,true);});\n\n},{\"./main\":\"main\"}],12:[function(require,module,exports){\n'use strict';var _createClass=(function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if(\"value\" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};})();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError(\"Cannot call a class as a function\");}}var main=require('./main');var _=main._;var Cookie=main.Cookie;var Memory=(function(){function Memory(key,expiry,needCookie){_classCallCheck(this,Memory);this.key=key;this.expiry=expiry;this.needCookie=needCookie;main.defer(this.purgeExpired.bind(this));}_createClass(Memory,[{key:'bakeCookie',value:function bakeCookie(object){if(!this.needCookie)return;var nums=Object.keys(object);nums.sort(function(a,b){return parseInt(a,10)-parseInt(b,10);});Cookie.set(this.key,nums.join('/'));}},{key:'now',value:function now(){return Math.floor(Date.now()/1000);}},{key:'purgeAll',value:function purgeAll(){localStorage.removeItem(this.key);if(this.needCookie)Cookie.remove(this.key);}},{key:'readAll',value:function readAll(){var key=localStorage.getItem(this.key);if(!key)return {};var val=undefined;try{val=JSON.parse(key);}catch(e) {}return _.isObject(val)?val:{};}},{key:'writeAll',value:function writeAll(object){if(_.isEmpty(object))return this.purgeAll();localStorage.setItem(this.key,JSON.stringify(object));this.bakeCookie(object);}},{key:'write',value:function write(key){var object=this.readAll();object[key]=this.now();this.writeAll(object);return _.size(object);}},{key:'size',value:function size(){return _.size(this.readAll());}},{key:'purgeExpired',value:function purgeExpired(){if(!this.expiry)return;var object=this.readAll();var now=this.now(),limit=86400*this.expiry;var expired=[];for(var key in object){var time=object[key];if(time&&now>time+limit)expired.push(key);}if(!expired.length)return;for(var i=0,lim=expired.length;i<lim;i++){delete object[expired[i]];}this.writeAll(object);}}]);return Memory;})();module.exports=Memory;\n\n},{\"./main\":\"main\"}],13:[function(require,module,exports){\n'use strict';var _main=require('main');var _opts=require('./opts');var _opts2=_interopRequireDefault(_opts);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var options;try{options=JSON.parse(localStorage.options);}catch(e) {}if(!options)options={};options=module.exports=new _main.Backbone.Model(options);var OptionsCollection=_main.Backbone.Collection.extend({persist:function persist(){var opts={};this.forEach(function(model){var val=model.getValue();if(val===model.get('default'))return;opts[model.get('id')]=val;});localStorage.options=JSON.stringify(opts);}});var optionsCollection=new OptionsCollection();var OptionModel=_main.Backbone.Model.extend({initialize:function initialize(opts){if(opts.load!==undefined&&!opts.load)return;if(!opts.type)this.set('type','checkbox');var val=this.getValue();this.setValue(val);if(opts.exec!==undefined){this.listenTo(options,'change:'+opts.id,this.execListen);if(opts.execOnStart!==false)opts.exec(val);}optionsCollection.add(this);},setValue:function setValue(val){options.set(this.get('id'),val);},getValue:function getValue(){var val=options.get(this.get('id'));return val===undefined?this.get('default'):val;},validate:function validate(val){var valid=this.get('validation');return valid?valid(val):true;},execListen:function execListen(model,val){this.get('exec')(val);}});(function(){if(localStorage.getItem('options'))return;var $el=$('#options');$el.addClass('noOptions');function fadeout(){$el.filter('.noOptions').fadeOut(fadein);}function fadein(){$el.fadeIn();if($el.filter('.noOptions').length)fadeout();}fadeout();$el.click(function(){$el.removeClass('noOptions');});})();var OptionsView=_main.Backbone.View.extend({initialize:function initialize(){var _this=this;optionsCollection.each(function(model){var $el=_this.$el.find('#'+model.get('id'));if(!$el.length)return;var type=model.get('type'),val=model.getValue();if(type=='checkbox')$el.prop('checked',val);else if(type=='number'||type instanceof Array)$el.val(val);else if(type=='shortcut')$el.val(String.fromCharCode(val).toUpperCase());});this.$hidden=this.$el.find('#hidden');main.reply('hide:render',this.renderHidden,this);},events:{'click .option_tab_sel>li>a':'switchTab','change':'applyChange','click #export':'export','click #import':'import','click #hidden':'clearHidden'},switchTab:function switchTab(event){event.preventDefault();var $a=$(event.target);this.$el.children('.option_tab_sel').find('a').removeClass('tab_sel');$a.addClass('tab_sel');var $li=this.$el.children('.option_tab_cont').children('li');$li.removeClass('tab_sel');$li.filter('.'+$a.data('content')).addClass('tab_sel');},applyChange:function applyChange(event){var $target=$(event.target),model=optionsCollection.get($target.attr('id')),val;if(!model)return;var type=model.get('type');if(type=='checkbox')val=$target.prop('checked');else if(type=='number')val=parseInt($target.val());else if(type=='image')return main.request('background:store',event.target);else if(type=='shortcut')val=$target.val().toUpperCase().charCodeAt(0);else val=$target.val();if(!model.validate(val))return $target.val('');model.setValue(val);optionsCollection.persist();},export:function _export(){var a=document.getElementById('export');a.setAttribute('href',window.URL.createObjectURL(new Blob([JSON.stringify(localStorage)],{type:'octet/stream'})));a.setAttribute('download','meguca-config.json');},import:function _import(event){event.preventDefault();var $input=this.$el.find('#importSettings');$input.click();$input.one('change',function(){var reader=new FileReader();reader.readAsText($input[0].files[0]);reader.onload=function(e){var json;try{json=JSON.parse(e.target.result);}catch(e) {alert('Import failed. File corrupt');}if(!json)return;localStorage.clear();for(var key in json){localStorage[key]=json[key];}alert('Import successfull. The page will now reload.');location.reload(true);};});},renderHidden:function renderHidden(count){var $el=this.$hidden;$el.text($el.text().replace(/\\d+$/,count));},clearHidden:function clearHidden(){main.request('hide:clear');this.renderHidden(0);}});var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=_opts2.default[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var spec=_step.value;new OptionModel(spec);}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}main.defer(function(){new OptionsView({el:document.getElementById('options-panel')});});\n\n},{\"./opts\":14,\"main\":\"main\"}],14:[function(require,module,exports){\n'use strict';var _main=require('main');module.exports=function(isMobile){var notMobile=!isMobile;var opts=[{id:'lang',type:_main.config.LANGS,tab:0,default:_main.config.DEFAULT_LANG,execOnStart:false,exec:function exec(type){_main.Cookie.set('lang',type);alert(main.lang.langApplied);location.reload(true);}},{id:'inlinefit',type:['none','full','width','height','both'],tab:1,default:'width'},{id:'thumbs',type:['small','sharp','hide'],tab:1,default:'small',exec:function exec(type){_main.Cookie.set('thumb',type);oneeSama.thumbStyle=type;}},{id:'imageHover',default:true,load:notMobile,tab:0},{id:'webmHover',load:notMobile,tab:0},{id:'autogif',load:notMobile,tab:1,exec:function exec(autogif){_main.Cookie.set('agif',autogif);oneeSama.autoGif=autogif;}},{id:'spoilers',tab:1,default:true,exec:function exec(spoilertoggle){_main.Cookie.set('spoil',spoilertoggle);oneeSama.spoilToggle=spoilertoggle;}},{id:'linkify',tab:0,exec:function exec(toggle){_main.Cookie.set('linkify',toggle);oneeSama.eLinkify=toggle;}},{id:'notification',load:notMobile,tab:0,exec:function exec(notifToggle){if(notifToggle&&Notification.permission!==\"granted\")Notification.requestPermission();}},{id:'anonymise',tab:0},{id:'relativeTime',tab:0,default:true,exec:function exec(toggle){oneeSama.rTime=toggle;}},{id:'nowPlaying',load:notMobile&&_main.config.RADIO,tab:3,default:true,exec:function exec(toggle){if(toggle)main.send([index.RADIO]);else main.request('banner:radio:clear');}}];var _arr=['google','iqdb','saucenao','desustorage','exhentai'];for(var _i=0;_i<_arr.length;_i++){var engine=_arr[_i];opts.push({id:engine,lang:'imageSearch',tab:2,default:engine==='google',exec:toggleHeadStyle(engine+'Toggle','.'+engine+'{display:initial;}')});}opts.push({id:'illyaBGToggle',load:notMobile&&hotConfig.ILLYA_DANCE,tab:3},{id:'illyaMuteToggle',load:notMobile&&hotConfig.ILLYA_DANCE,tab:3},{id:'horizontalPosting',tab:3,exec:toggleHeadStyle('horizontal','article,aside{display:inline-block;}')},{id:'replyright',tab:1,exec:toggleHeadStyle('reply-at-right','section>aside{margin: -26px 0 2px auto;}')},{id:'theme',type:['moe','gar','mawaru','moon','ashita','console','tea','higan','ocean','rave','tavern','glass'],tab:1,default:hotConfig.DEFAULT_CSS,exec:function exec(theme){if(!theme)return;document.getElementById('theme').setAttribute('href',_main.config.MEDIA_URL+'css/'+theme+'.css?v='+main.cssHash);}},{id:'userBG',load:notMobile,tab:1},{id:'userBGimage',load:notMobile,type:'image',tab:1,execOnStart:false,exec:function exec(upload){main.request('background:store',upload);}},{id:'lastn',type:'number',tab:0,validation:_main.util.reasonable_last_n,default:hotConfig.THREAD_LAST_N,exec:function exec(n){oneeSama.lastN=n;_main.Cookie.set('lastn',n);}},{id:'alwaysLock',tab:0});var shorts=[{id:'new',default:78},{id:'togglespoiler',default:73},{id:'textSpoiler',default:68},{id:'done',default:83},{id:'expandAll',default:69},{id:'workMode',default:66}];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=shorts[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var short=_step.value;short.type='shortcut';short.tab=4;short.load=notMobile;opts.push(short);}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}return opts;};function toggleHeadStyle(id,css){return function(toggle){if(!document.getElementById(id)){document.head.appendChild(_main.util.parseDOM('<style id=\"'+id+'\">'+css+'</style>'));}document.getElementById(id).disabled=!toggle;};}\n\n},{\"main\":\"main\"}],15:[function(require,module,exports){\n'use strict';var main=require('../main');var PostCommon=require('./common');var _=main._;var Backbone=main.Backbone;module.exports=PostCommon.extend({tagName:'article',render:function render(){this.setElement(main.oneeSama.article(this.model.attributes));return this;},insertIntoDOM:function insertIntoDOM(){_.last(document.query('#p'+this.model.get('op')).queryAll('article')).after(this.el);this.autoExpandImage().fun();}});\n\n},{\"../main\":\"main\",\"./common\":16}],16:[function(require,module,exports){\n'use strict';var main=require('../main');var imager=require('./imager');var _=main._;var Backbone=main.Backbone;var common=main.common;var util=main.util;var lang=main.lang;var oneeSama=main.oneeSama;var options=main.options;var state=main.state;module.exports=imager.Hidamari.extend({className:'glass',initialize:function initialize(){this.listenTo(this.model,'dispatch',this.redirect);},clientInit:function clientInit(){if(options.get('anonymise'))this.anonymise();return this;},redirect:function redirect(command){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}this[command].apply(this,args);},updateBody:function updateBody(frag){if(!this.blockquote)this.blockquote=this.el.query('blockquote');var model=this.model.attributes;this.blockquote.innerHTML=oneeSama.setModel(model).body(model.body);},renderTime:function renderTime(){this.el.query('time').outerHTML=oneeSama.time(this.model.get('time'));},renderBacklinks:function renderBacklinks(links){this.el.query('small').innerHTML=oneeSama.backlinks(links);},fun:function fun(){},anonymise:function anonymise(){this.el.query('.name').innerHTML='<b class=\"name\">'+lang.anon+'<b>';},renderName:function renderName(){this.el.query('.name').outerHTML=oneeSama.name(this.model.attributes);},renderModerationInfo:function renderModerationInfo(info){var el=this.getContainer();el.query('.modLog').remove();el.query('blockquote').before(util.parseDOM(oneeSama.modInfo(info)));},getContainer:function getContainer(){return this.el.query('.container');},renderBan:function renderBan(){var el=this.getContainer();el.query('.banMessage').remove();el.query('blockquote').after(util.parseDOM(oneeSama.banned()));},renderEditing:function renderEditing(editing){var el=this.el;if(editing)el.classList.add('editing');else {el.classList.remove('editing');el.query('blockquote').normalize();}}});\n\n},{\"../main\":\"main\",\"./imager\":19}],17:[function(require,module,exports){\n'use strict';var main=require('../main');var $=main.$;var util=main.util;var youtube_url_re=exports.youtube_url_re=/(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?youtube\\.com\\/watch\\/?\\?((?:[^\\s#&=]+=[^\\s#&]*&)*)?v=([\\w-]{11})((?:&[^\\s#&=]+=[^\\s#&]*)*)&?(#t=[\\dhms]{1,9})?/,youtube_short_re=exports.youtube_short_re=/(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?youtu.be\\/([\\w-]{11})\\??(t=[\\dhms]{1,9})?/,youtube_time_re=exports.youtube_time_re=/^#t=(?:(\\d\\d?)h)?(?:(\\d{1,3})m)?(?:(\\d{1,3})s)?$/,youtube_short_time_re=exports.youtube_short_time_re=/^t=(?:(\\d\\d?)h)?(?:(\\d{1,3})m)?(?:(\\d{1,3})s)?$/;function make_video(id,params,start){if(!params)params={allowFullScreen:'true'};params.allowScriptAccess='always';var query={autohide:1,fs:1,modestbranding:1,origin:document.location.origin,rel:0,showinfo:0};if(start)query.start=start;if(params.autoplay)query.autoplay=params.autoplay;if(params.loop){query.loop='1';query.playlist=id;}return $('<iframe></iframe>',{type:'text/html',src:encodeURI('https://www.youtube.com/embed/'+id)+'?'+$.param(query),frameborder:'0',attr:video_dims(),class:'youtube-player'});}function video_dims(){if(window.screen&&screen.width<=320)return {width:250,height:150};else return {width:560,height:340};}main.$threads.on('click','.watch',function(e){if(e.which>1||e.metaKey||e.ctrlKey||e.altKey||e.shiftKey)return;var $target=$(e.target);if(!$target.is('a'))return;var $video=$target.find('iframe');if($video.length){$video.siblings('br').andSelf().remove();$target.css('width','auto');return false;}if($target.data('noembed'))return;var m=$target.attr('href').match(youtube_url_re);if(!m){m=$target.attr('href').match(youtube_short_re);if(!m)return;timeCall(m[1],m[2],youtube_short_time_re);}timeCall(m[2],m[4],youtube_time_re);function timeCall(url,time,timeRex){var start=0;if(time){var t=time.match(timeRex);if(t){if(t[1])start+=parseInt(t[1],10)*3600;if(t[2])start+=parseInt(t[2],10)*60;if(t[3])start+=parseInt(t[3],10);}}$target.css('width',video_dims().width).append('<br>',make_video(url,null,start));}return false;});main.$threads.on('mouseenter','.watch',function(event){var $target=$(event.target);if($target.data('requestedTitle'))return;$target.data('requestedTitle',true);var node=$target.contents().filter(function(){return this.nodeType===3;})[0];if(!node)return;var orig=node.textContent;node.textContent=orig+'...';var m=$target.attr('href').match(youtube_url_re);if(!m){m=$target.attr('href').match(youtube_short_re);if(!m)return;$.ajax({url:'//gdata.youtube.com/feeds/api/videos/'+m[1],data:{v:'2',alt:'jsonc'},dataType:'json',success:gotInfo,error:function error(){node.textContent=orig+'???';}});}$.ajax({url:'//gdata.youtube.com/feeds/api/videos/'+m[2],data:{v:'2',alt:'jsonc'},dataType:'json',success:gotInfo,error:function error(){node.textContent=orig+'???';}});function gotInfo(data){var title=data&&data.data&&data.data.title;if(title){node.textContent=orig+': '+title;$target.css({color:'black'});}else node.textContent=orig+' (gone?)';if(data&&data.data&&data.data.accessControl&&data.data.accessControl.embed==='denied'){node.textContent+=' (EMBEDDING DISABLED)';$target.data('noembed',true);}}});function make_embed(uri,params,dims){var $obj=$('<object/>',{attr:dims});for(var name in params){$('<param/>',{attr:{name:name,value:params[name]}}).appendTo($obj);}$('<embed/>',{src:uri,type:'application/x-shockwave-flash'}).attr(dims).attr(params).appendTo($obj);return $obj;}var soundcloud_url_re=exports.soundcloud_url_re=/(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.)?soundcloud\\.com\\/([\\w-]{1,40}\\/[\\w-]{1,80})\\/?/;function fetchSoundcloud(target,width,cb){var url='https://soundcloud.com/oembed?url='+encodeURIComponent(target.getAttribute('href'))+('&maxwidth='+width+'&maxheight=166&auto_play=true&format=json')+'&show_comments=false';var xhr=new XMLHttpRequest();xhr.open('GET',url);xhr.responseType='json';xhr.onload=function(){if(this.status!==200)return cb(this.status);cb(null,this.response);};xhr.send();}main.$threads.on('click','.soundcloud',function(e){if(e.which>1||e.ctrlKey||e.altKey||e.shiftKey||e.metaKey)return;var target=e.target;var iframe=target.query('iframe');e.preventDefault();if(iframe){iframe.previousElementSibling.remove();iframe.remove();return;}var width=Math.round(window.innerWidth*0.75);fetchSoundcloud(target,width,function(err,json){if(err)return alert(err);target.append(document.createElement('br'));target.append(util.parseDOM(json.html));target.style.width=width+'px';});});main.$threads.on('mouseenter','.soundcloud:not(.fetched)',function(event){var target=event.target;var node=target.firstChild;var text=node.textContent;node.textContent=text+' ...';fetchSoundcloud(target,1000,function(err,json){if(err)return node.textContent=text+': Error: '+err;node.textContent=text+': '+json.title;target.style.color='black';target.classList.add('fetched');});});var pastebin_re=exports.pastebin_re=/(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?pastebin\\.com\\/(.*)/;$(document).on('click','.pastebin',function(event){if(event.which>1||event.ctrlKey||event.altKey||event.shiftKey||event.metaKey)return;var $target=$(event.target);var $obj=$target.find('iframe');if($obj.length){$obj.siblings('br').andSelf().remove();$target.css({width:'auto',height:'auto'});return false;}var m=$target.attr('href').match(pastebin_re);if(!m)return;var $window=$(window),width=Math.round($window.innerWidth()*0.65),height=Math.round($window.innerHeight()*0.65);$target.css({width:width,height:height}).append('<br>',$('<iframe></iframe>',{type:'text/html',src:'https://pastebin.com/embed_iframe.php?i='+m[1],frameborder:'0',width:width,height:height}));return false;});\n\n},{\"../main\":\"main\"}],18:[function(require,module,exports){\n'use strict';var main=require('../main');var $=main.$;var $script=main.$script;var $email=main.$email;var $name=main.$name;var _=main._;var common=main.common;var config=main.config;function load(){try{var id=JSON.parse(localStorage.ident);if(id.name)$name.val(id.name);if(id.email)$email.val(id.email);}catch(e) {}}var save=_.debounce(function(){try{var name=$name.val();var email=$email.val();if(email===config.LOGIN_KEYWORD){$email.val('');$script(config.MEDIA_URL+'js/login.js?v='+main.clientHash);email=false;}if(name||email){var id={};if(name)id.name=name;if(email)id.email=email;localStorage.ident=JSON.stringify(id);}else localStorage.removeItem('ident');}catch(e) {}},1000);function propagate(){var postForm=main.request('postForm');if(postForm)postForm.renderIdentity();save();}main.defer(function(){load();$name.on('input',propagate);$email.on('input',propagate);});\n\n},{\"../main\":\"main\"}],19:[function(require,module,exports){\n'use strict';var _templateObject=_taggedTemplateLiteral(['<',' ','>'],['<',' ','>']),_templateObject2=_taggedTemplateLiteral(['<audio src=\"','\"\\n\\t\\t\\t\\twidth=\"300\"\\n\\t\\t\\t\\theight=\"3em\"\\n\\t\\t\\t\\tautoplay loop controls\\n\\t\\t\\t>\\n\\t\\t\\t</audio>'],['<audio src=\"','\"\\n\\t\\t\\t\\twidth=\"300\"\\n\\t\\t\\t\\theight=\"3em\"\\n\\t\\t\\t\\tautoplay loop controls\\n\\t\\t\\t>\\n\\t\\t\\t</audio>']);function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}var main=require('../main');var $threads=main.$threads;var _=main._;var Backbone=main.Backbone;var common=main.common;var util=main.util;var oneeSama=main.oneeSama;var options=main.options;var state=main.state;exports.Hidamari=Backbone.View.extend({renderImage:function renderImage(arg,image,manual){var reveal=arg===true;var model=this.model;var el=this.el;if(!image||!image.src)image=model.get('image');var figure=el.query('figure');if(figure)figure.remove();if(!image)return;el.query('blockquote').before(util.parseDOM(oneeSama.image(image,reveal)));if(manual&&model.get('tallImage')){window.scrollTop=el.getBoundingClientRect().top+document.body.scrollTop-document.query('#banner').height;}model.set({thumbnailRevealed:reveal,imageExpanded:false,tallImage:false});},autoExpandImage:function autoExpandImage(){var img=this.model.get('image');if(!img||!massExpander.get('expand')||['.webm','.pdf','.mp3'].indexOf(img.ext)>-1)return this;this.toggleImageExpansion(true,img);return this;},toggleImageExpansion:function toggleImageExpansion(expand,img,manual){var fit=options.get('inlinefit');if(!img||fit==='none')return;if(expand)this.fitImage(img,fit);else this.renderImage(null,img,manual);},fitImage:function fitImage(img,fit){if(img.ext==='.pdf')return window.open(oneeSama.imagePaths().src+img.src,'_blank');if(img.ext==='.mp3')return this.renderAudio(img);var newWidth=undefined,newHeight=undefined,width=newWidth=img.dims[0],height=newHeight=img.dims[1];if(fit==='full')return this.expandImage(img,{width:width,height:height});var both=fit==='both',widthFlag=both||fit==='width',heightFlag=both||fit==='height',aspect=width/height;var fullWidth=undefined,fullHeight=undefined;if(widthFlag){var maxWidth=this.imageMaxWidth();if(newWidth>maxWidth){newWidth=maxWidth;newHeight=newWidth/aspect;fullWidth=true;}}if(heightFlag){var maxHeight=window.innerHeight-document.query('#banner').offsetHeight;if(newHeight>maxHeight){newHeight=maxHeight;newWidth=newHeight*aspect;fullHeight=true;}}if(newWidth>50&&newHeight>50){width=newWidth;height=newHeight;}this.expandImage(img,width,height,fullHeight&&!fullWidth);},imageMaxWidth:function imageMaxWidth(){var el=this.el;var model=this.model;return window.innerWidth-parseInt(el.closest('section').getBoundingClientRect().left)*2-util.outerWidth(model.get('op')?el:el.query('.background'));},expandImage:function expandImage(img,width,height,noMargin){var isVideo=img.ext==='.webm';var attrs={src:oneeSama.imagePaths().src+img.src,width:width,height:height};var cls='expanded';if(noMargin)cls+=' noMargin';attrs.class=cls;if(isVideo)attrs.autoplay=attrs.loop=attrs.controls=true;this.el.query('figure').lastChild.innerHTML=common.parseHTML(_templateObject,isVideo?'video':'img',attrs);this.model.set({imageExpanded:true,tallImage:height>window.innerHeight});},renderAudio:function renderAudio(img){this.el.query('figure').append(util.parseDOM(common.parseHTML(_templateObject2,oneeSama.imagePaths().src+img.src)));this.model.set('imageExpanded',true);}});var ExpanderModel=Backbone.Model.extend({initialize:function initialize(){var _this=this;$threads.on('click','#expandImages',function(e){e.preventDefault();_this.toggle();});},toggle:function toggle(){var expand=!this.get('expand');this.set('expand',expand).massToggle(expand);$threads.find('#expandImages').text(main.lang.expander[+expand]);},massToggle:function massToggle(expand){var fit=options.get('inlinefit');if(fit==='none')return;var models=state.posts.models;for(var i=0,l=models.length;i<l;i++){var model=models[i],img=model.get('image');if(!img)continue;if(expand)model.dispatch('fitImage',img,fit);else model.dispatch('renderImage',null,img);}}});var massExpander=exports.massExpander=new ExpanderModel();main.reply('massExpander:unset',function(){return massExpander.unset();});$threads.on('click','img, video',function(e){if(options.get('inlinefit')=='none'||e.which!==1)return;var model=util.getModel(e.target);if(!model)return;e.preventDefault();main.request('imager:clicked');model.dispatch('toggleImageExpansion',!model.get('imageExpanded'),model.get('image'),true);});$threads.on('click','.imageToggle',function(e){e.preventDefault();var model=util.getModel(e.target);if(!model)return;main.follow(function(){return model.dispatch('renderImage',!model.get('thumbnailRevealed'));});});\n\n},{\"../main\":\"main\"}],20:[function(require,module,exports){\n'use strict';module.exports={imager:require('./imager'),Menu:require('./menu'),common:require('./common'),Article:require('./article'),Section:require('./section'),models:require('./models'),nonce:require('./nonce'),embed:require('./embed'),posting:require('./posting')};\n\n},{\"./article\":15,\"./common\":16,\"./embed\":17,\"./imager\":19,\"./menu\":21,\"./models\":22,\"./nonce\":23,\"./posting\":24,\"./section\":25}],21:[function(require,module,exports){\n'use strict';var main=require('../main');var $=main.$;var _=main._;var Backbone=main.Backbone;var common=main.common;var util=main.util;var lang=main.lang;var state=main.state;var MenuView=module.exports=Backbone.View.extend({className:'popup-menu glass',tagName:'ul',actions:['report','hide'],events:{click:'handleClick'},initialize:function initialize(_ref){var parent=_ref.parent;parent._popup_menu=this;this.parent=parent;this.render();},render:function render(){var html='';var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.actions[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var action=_step.value;html+='<li data-type=\"'+action+'\">'+lang[action]+'</li>';}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}var el=this.el;var parent=this.parent;el.innerHTML=html;parent.append(el);el.style.left=el.getBoundingClientRect().left-(util.outerWidth(el)+el.offsetWidth)*0.6+'px';},handleClick:function handleClick(e){e.stopPropagation();main.request(e.target.getAttribute('data-type'),this.model);this.remove();},remove:function remove(){this.parent._popup_menu=null;this.el.remove();this.stopListening();}});main.reply('menu:extend',function(action){return _.extend(MenuView.prototype.actions,action);});main.$threads.on('click','.control',function(event){var target=event.target;if(target._popup_menu)return target._popup_menu.remove();var model=util.getModel(target);if(model)new MenuView({parent:target,model:model});});\n\n},{\"../main\":\"main\"}],22:[function(require,module,exports){\n'use strict';var main=require('../main');var _=main._;var Backbone=main.Backbone;var state=main.state;exports.Post=Backbone.Model.extend({idAttribute:'num',initialize:function initialize(){state.posts.add(this);},dispatch:function dispatch(command){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}this.trigger.apply(this,['dispatch',command].concat(args));},remove:function remove(){this.stopListening().dispatch('remove');state.posts.remove(this);},update:function update(frag,links,dice){var updates={body:this.get('body')+frag};if(links)_.extend(this.get('links'),links);if(dice)updates.dice=(this.get('dice')||[]).concat(dice);this.set(updates);},setImage:function setImage(image,silent){this.set('image',image);if(!silent)this.dispatch('renderImage',image);},setSpoiler:function setSpoiler(spoiler,info){var image=this.get('image');image.spoiler=spoiler;this.dispatch('renderImage',image);this.moderationInfo(info);},removeImage:function removeImage(info){this.moderationInfo(info)||this.unset('image').dispatch('renderImage');},deletePost:function deletePost(info){this.moderationInfo(info)||this.remove();},setBan:function setBan(display,info){if(display)this.set('ban',true).dispatch('renderBan');this.moderationInfo(info);},addBacklink:function addBacklink(num,op){var backlinks=this.get('backlinks')||{};backlinks[num]=op;this.set({backlinks:backlinks}).dispatch('renderBacklinks',backlinks);},moderationInfo:function moderationInfo(info){if(!info)return false;var mod=this.get('mod')||[];mod.push(info);this.set('mod',mod).dispatch('renderModerationInfo',mod);return true;}});exports.Thread=exports.Post.extend({defaults:{replies:[],omit:0,image_omit:0},initialize:function initialize(){if(this.get('omit'))this.getImageOmit();state.posts.add(this);},remove:function remove(){this.stopListening().dispatch('remove');state.posts.remove(this);var replies=this.get('replies');for(var i=0,lim=replies.length;i<lim;i++){var model=state.posts.get(replies[i]);if(model)model.remove();}},getImageOmit:function getImageOmit(){var image_omit=this.get('imgctr')-1;var replies=this.get('replies');for(var i=0,lim=replies.length;i<lim;i++){var model=state.posts.get(replies[i]);if(!model)continue;if(model.get('image'))image_omit--;}this.set('image_omit',image_omit);},toggleLocked:function toggleLocked(val,info){this.moderationInfo(info);this.set('locked',val).dispatch('renderLocked',val);}});\n\n},{\"../main\":\"main\"}],23:[function(require,module,exports){\n'use strict';var main=require('../main');var common=main.common;var state=main.state;var nonceCache={};function get(){var nonces;if(window.localStorage){try{nonces=JSON.parse(localStorage.postNonces);}catch(e) {}}else nonces=nonceCache;return nonces||{};}main.reply('nonce:get',get);function save_nonces(nonces){if(window.localStorage)localStorage.postNonces=JSON.stringify(nonces);else nonceCache=nonces;}function today_id(){return Math.floor(Date.now()/(1000*60*60*24));}function create(){var nonces=get(),nonce=common.randomID(32);nonces[nonce]={tab:state.page.get('tabID'),day:today_id()};save_nonces(nonces);return nonce;}main.reply('nonce:create',create);setTimeout(function(){if(!window.localStorage)return;var nonces=get();var changed=undefined;var yesterday=today_id()-1;for(var nonce in nonces){if(nonces[nonce].day>=yesterday)continue;delete nonces[nonce];changed=true;}if(changed)save_nonces(nonces);},Math.floor(Math.random()*5000));function destroy(nonce){setTimeout(function(){var nonces=get();if(!nonces[nonce])return;delete nonces[nonce];save_nonces(nonces);},10000);}main.reply('nonce:destroy',destroy);\n\n},{\"../main\":\"main\"}],24:[function(require,module,exports){\n'use strict';var _templateObject=_taggedTemplateLiteral(['<header>\\n\\t\\t\\t\\t<a class=\"name nope\" target=\"_blank\">\\n\\t\\t\\t\\t\\t<b></b>\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</header>\\n\\t\\t\\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>\\n\\t\\t\\t<div class=\"container\">\\n\\t\\t\\t\\t<blockquote>\\n\\t\\t\\t\\t\\t<p id=\"buffer\" class=\"exclude\"></p>\\n\\t\\t\\t\\t\\t<p id=\"lineBuffer\" class=\"exclude\"></p>\\n\\t\\t\\t\\t\\t<textarea ','></textarea>\\n\\t\\t\\t\\t</blockquote>\\n\\t\\t\\t\\t<form ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<strong id=\"uploadStatus\"></strong>\\n\\t\\t\\t\\t</form>\\n\\t\\t\\t\\t<small></small>\\n\\t\\t\\t</div>'],['<header>\\n\\t\\t\\t\\t<a class=\"name nope\" target=\"_blank\">\\n\\t\\t\\t\\t\\t<b></b>\\n\\t\\t\\t\\t</a>\\n\\t\\t\\t</header>\\n\\t\\t\\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>\\n\\t\\t\\t<div class=\"container\">\\n\\t\\t\\t\\t<blockquote>\\n\\t\\t\\t\\t\\t<p id=\"buffer\" class=\"exclude\"></p>\\n\\t\\t\\t\\t\\t<p id=\"lineBuffer\" class=\"exclude\"></p>\\n\\t\\t\\t\\t\\t<textarea ','></textarea>\\n\\t\\t\\t\\t</blockquote>\\n\\t\\t\\t\\t<form ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<input ','>\\n\\t\\t\\t\\t\\t<strong id=\"uploadStatus\"></strong>\\n\\t\\t\\t\\t</form>\\n\\t\\t\\t\\t<small></small>\\n\\t\\t\\t</div>']);function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}var Article=require('./article');var main=require('../main');var embed=require('./embed');var ident=require('./identity');var imager=require('./imager');var $=main.$;var _=main._;var Backbone=main.Backbone;var Cookie=main.Cookie;var common=main.common;var config=main.config;var connSM=main.connSM;var util=main.util;var lang=main.lang;var oneeSama=main.oneeSama;var options=main.options;var postSM=main.postSM;var state=main.state;var postForm=undefined,postModel=undefined;main.reply('postForm',function(){return postForm;}).reply('postModel',function(){return postModel;}).reply('postForm:indentity',function(){return postForm&&postForm.renderIdentity();});var inputMinSize=300;if(window.screen&&screen.width<=320)inputMinSize=50;var ComposerModel=Backbone.Model.extend({idAttribute:'num'});connSM.on('synced',postSM.feeder('sync'));connSM.on('dropped',postSM.feeder('desync'));connSM.on('desynced',postSM.feeder('desync'));main.reply('postSM:feed',function(state){return postSM.feed(state);});postSM.act('* + desync -> none',function(){if(postForm){postForm.el.classList.remove('editing');postForm.$input.val('');postForm.finish();}main.$threads.find('aside.posting').hide();});postSM.act('none + sync, draft, alloc + done -> ready',function(){if(postForm){postForm.remove();postForm=postModel=null;}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=main.$threads[0].queryAll('aside.posting')[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var el=_step.value;el.style.display='';}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}});postSM.act('ready + new -> draft',function(aside){var op=undefined,section=aside.closest('section');if(section)op=util.getNum(section);else section=document.createElement('section');if(op&&!state.page.get('thread'))state.posts.get(op).dispatch('shiftReplies',true);postForm=new ComposerView({model:postModel=new ComposerModel({op:op}),destination:aside,section:section});});postSM.preflight('draft',function(aside){return aside.matches('aside');});postSM.act('draft + alloc -> alloc',function(msg){return postForm.onAllocation(msg);});main.dispatcher[common.IMAGE_STATUS]=function(msg){return postForm&&postForm.dispatch(msg[0]);};main.$doc.on('click','aside.posting a',function(){postSM.feed('new',this.parentNode);});main.$doc.on('keydown',handle_shortcut);function handle_shortcut(event){if(!event.altKey)return;var opts=options.attributes;switch(event.which){case opts.new:var aside=document.query('aside.posting');if(aside){postSM.feed('new',aside);prevent();}break;case opts.togglespoiler:if(postForm){postForm.onToggle(event);prevent();}break;case opts.done:if(postForm&&!postForm.$submit.attr('disabled')){postForm.finish();prevent();}break;case opts.textSpoiler:if(postForm){var postState=this.imouto.state2.spoiler;var sp=(postState?'[/':' [')+'spoiler]';this.imouto.state2.spoiler=!postState;this.$input.val(this.$input.val()+sp);prevent();}break;case opts.expandAll:imager.massExpander.toggle();prevent();break;case opts.workMode:var val=main.oneeSama.workMode=!main.oneeSama.workMode;Cookie.set('workModeTOG',val);var banner=document.querySelector(\"h1 > img\");if(banner!=null)banner.style.display=val?'none':'';document.getElementById('theme').setAttribute('href',config.MEDIA_URL+'css/'+(val?state.hotConfig.get('DEFAULT_CSS'):main.options.get(\"theme\"))+'.css?v='+main.cssHash);oneeSama.thumbStyle=val?'hide':main.options.get('thumbs');main.options.trigger(\"workModeTOG\");window.addEventListener('beforeunload',function(){Cookie.set(\"workModeTOG\",false);});prevent();break;}function prevent(){event.stopImmediatePropagation();event.preventDefault();}}main.oneeSama.hook('insertOwnPost',function(_ref){var links=_ref.links;if(!postForm||!links)return;postForm.$buffer.find('.nope').each(function(){var $a=$(this);var text=$a.text(),m=text.match(/^>>(\\d+)/);if(!m)return;var num=m[1],op=links[num];if(!op)return;var $ref=$(common.join([postForm.imouto.postRef(num,op,false)]));$a.attr('href',$ref.attr('href')).attr('class','history');var refText=$ref.text();if(refText!=text)$a.text(refText);});});var ArticleComposer=Article.extend({events:{'click #cancel':'cancel','change #imageInput':'onImageChosen','input #trans':'onInput','keydown #trans':'onKeyDown','click #done':'finish','click #toggle':'onToggle'},initialize:function initialize(args){Article.prototype.initialize.call(this);this.listenTo(this.model,{'change':this.renderButtons,'change:spoiler':this.renderSpoilerPane});this.render(args).insertIntoDOM(args);this.model.set({spoiler:0,nextSpoiler:-1});this.pending='';this.line_count=1;this.char_count=0;var imouto=this.imouto=new common.OneeSama({callback:inject,op:state.page.get('thread'),blockqoute:this.blockqoute,eLinkify:main.oneeSama.eLinkify,lang:main.lang,tamashii:function tamashii(num){var section=document.query('#p'+num);section=section&&section.closest('section');if(section){var desc=num in state.mine.readAll()&&lang.you;return this.postRef(num,util.getNum(section),desc);}else return '<a class=\"nope\">&gt;&gt;'+num+'</a>';}});imouto.setModel(this.model);},render:function render(){var attrs={input:{name:'body',id:'input',rows:1,class:'themed exclude',autocomplete:main.isMobile},form:{method:'post',enctype:'multipart/form-data',target:'upload',id:'uploadForm'},cancel:{type:'buttom',value:lang.cancel,id:'cancel'},imageInput:{type:'file',id:'imageInput',name:'image',accept:'image/*;.webm;.pdf;.mp3'},toggle:{type:'button',id:'toggle'}};this.el.innerHTML=parseHTML(_templateObject,attrs.input,attrs.form,attrs.cancel,attrs.imageInput,attrs.toggle);var els=['buffer','lineBuffer','input','uploadForm','cancel','imageInput','toggle','uploadStatus','hiddenUpload','sizer'];var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=els[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var el=_step2.value;this[el]=document.query('#'+el);}}catch(err) {_didIteratorError2=true;_iteratorError2=err;}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally {if(_didIteratorError2){throw _iteratorError2;}}}this.renderIdentity();return this;},renderIdentity:function renderIdentity(){if(this.model.get('num'))return;var parsed=common.parse_name(main.$name.val(),main.$email.val()),haveTrip=!!(parsed[1]||parsed[2]);var el=this.el.query('.name'),name=el.query('a');if(parsed[0])name.textContent=parsed[0]+' ';else name.tetxContent=haveTrip?'':lang.anon;if(haveTrip)util.parseDOM(' <code>!?</code>').forEach(function(el){return name.after(el);});main.oneeSama.trigger('fillMyName',name);var email=main.$email.val().trim();if(email){el.setAttribute('href','mailto:'+email);el.classList.remove('nope');el.classList.add('email');}else {el.removeAttribute('href');el.classList.add('nope');el.classList.remove('email');}},insertIntoDOM:function insertIntoDOM(_ref2){var destination=_ref2.destination;destination.before(this.el);this.resizeInput();main.$threads.queryAll('aside.postsing').forEach(function(el){return el.style.display='none';});this.fun();},resizeInput:function resizeInput(val){var sizer=this.sizer;var input=this.input;if(typeof val!=='string')val=input.value;sizer.textContent=val;var size=sizer.width+common.INPUT_ROOM;size=Math.max(size,inputMinSize-input.getBoundingClientRect().left-this.el.getBoundingClientRect().left);this.input.style.width=size+'px';},renderButtons:function renderButtons(){var _model$attributes=this.model.attributes;var num=_model$attributes.num;var uploading=_model$attributes.uploading;var uploaded=_model$attributes.uploaded;var uploadStatus=_model$attributes.uploadStatus;var sentAllocRequest=_model$attributes.sentAllocRequest;var allocWait=sentAllocRequest&&!num;this.submit.disabled=!!(uploading||allocWait);if(uploaded)this.submit.style.marginLeft=0;this.cancel.disabled=!!allocWait;this.cancel.style.display=!num||uploading?'':'none';this.imageInput.disabled=!!uploading;this.uploadStatus.innerHTML=uploadStatus;},renderSpoilerPane:function renderSpoilerPane(model,spoiler){var background=spoiler?config.MEDIA_URL+'spoil/spoil'+spoiler+'.png':config.MEDIA_URL+'css/ui/pane.png';this.toggle.style.backgroundImage='url(\"'+background+'\")';}});var ComposerView=Backbone.View.extend({events:{'input #trans':'onInput','keydown #trans':'onKeyDown','click #done':'finish','click #toggle':'onToggle'},initialize:function initialize(args){this.listenTo(this.model,{'change':this.renderButtons,'change:spoiler':this.renderSpoilerPane});this.render(args);this.pending='';this.line_count=1;this.char_count=0;var imouto=this.imouto=new common.OneeSama({callback:inject,op:state.page.get('thread'),state:[common.S_BOL,0],state2:{spoiler:0},$buffer:this.$buffer,eLinkify:main.oneeSama.eLinkify,lang:main.lang,tamashii:function tamashii(num){var section=document.query('#p'+num);section=section&&section.closest('section');if(section){var desc=num in state.mine.readAll()&&this.lang.you;return this.postRef(num,util.getNum(section),desc);}else return '<a class=\"nope\">&gt;&gt;'+num+'</a>';}});imouto.hook('spoilerTag',util.touchable_spoiler_tag);main.oneeSama.trigger('imouto',imouto);},render:function render(_ref3){var destination=_ref3.destination;var section=_ref3.section;var op=this.model.get('op');this.setElement(op?document.createElement('article'):section);this.isThread=!op;this.$buffer=$('<p/>');this.$lineBuffer=$('<p/>');this.$meta=$('<header><a class=\"nope\"><b/></a> <time/></header>');this.$input=$('<textarea/>',{name:'body',id:'trans',rows:'1',class:'themed',autocomplete:main.isMobile});this.$submit=$('<input/>',{id:'done',type:'button',value:main.lang.done});this.$subject=$('<input/>',{id:'subject',class:'themed',maxlength:state.hotConfig.SUBJECT_MAX_LENGTH,width:'80%'});this.$blockquote=$('<blockquote/>');this.$sizer=$('<pre/>').appendTo('body');this.$blockquote.append(this.$buffer,this.$lineBuffer,this.$input);this.$el.append(this.$meta,this.$blockquote,'<small/>');if(this.isThread){this.$el.append('<label for=\"subject\">'+lang.subject+': </label>',this.$subject);this.$blockquote.hide();}this.$uploadForm=this.renderUploadForm();this.$el.append(this.$uploadForm);main.oneeSama.trigger('draft',this.$el);this.renderIdentity();destination.style.display='none';if(this.isThread){destination.after(this.el);this.el.after(document.createElement('hr'));this.$subject.focus();}else {destination.before(this.el);this.resizeInput();this.$input.focus();}main.$threads.find('aside.posting').hide();this.fun();},renderIdentity:function renderIdentity(){if(this.model.get('num'))return;var parsed=common.parse_name(main.$name.val(),main.$email.val()),haveTrip=!!(parsed[1]||parsed[2]);var $b=this.$meta.find('b');if(parsed[0])$b.text(parsed[0]+' ');else $b.text(haveTrip?'':main.lang.anon);if(haveTrip)$b.append(' <code>!?</code>');main.oneeSama.trigger('fillMyName',$b);var email=main.$email.val().trim();var $tag=this.$meta.children('a').first();if(email){$tag.attr({href:'mailto:'+email,target:'_blank',class:'email'});}else $tag.removeAttr('href').removeAttr('target').attr('class','nope');},renderButtons:function renderButtons(){var attrs=this.model.attributes,allocWait=attrs.sentAllocRequest&&!attrs.num,d=attrs.uploading||allocWait;this.$submit.prop('disabled',!!d);if(attrs.uploaded)this.$submit.css({'margin-left':'0'});this.$cancel.prop('disabled',!!allocWait);this.$cancel.toggle(!!(!attrs.num||attrs.uploading));this.$imageInput.prop('disabled',!!attrs.uploading);this.$uploadStatus.html(attrs.uploadStatus);},renderSpoilerPane:function renderSpoilerPane(model,sp){var background=sp?config.MEDIA_URL+'spoil/spoil'+sp+'.png':config.MEDIA_URL+'css/ui/pane.png';this.$toggle.css('background-image','url(\"'+background+'\")');},renderUploadForm:function renderUploadForm(){var $form=$('<form method=\"post\" enctype=\"multipart/form-data\" '+'target=\"upload\"></form>');this.$cancel=$('<input/>',{type:'button',value:lang.cancel,click:$.proxy(this,'cancel')});this.$imageInput=$('<input/>',{type:'file',id:'image',name:'image',accept:config.WEBM?'imager/*;.webm':'image/*',change:$.proxy(this,'onImageChosen')});this.$toggle=$('<input/>',{type:'button',id:'toggle'});this.$uploadStatus=$('<strong/>');$form.append(this.$cancel,this.$imageInput,this.$toggle,' ',this.$uploadStatus);this.$iframe=$('<iframe/>',{src:'',name:'upload',id:'hidden-upload'}).appendTo('body');this.model.set({spoiler:0,nextSpoiler:-1});return $form;},cancel:function cancel(){if(this.model.get('uploading')){this.$iframe.remove();this.$iframe=$('<iframe></iframe>',{src:'',name:'upload',id:'hidden-upload'}).appendTo('body');this.uploadError('');this.model.set({cancelled:true});}else this.finish();},onImageChosen:function onImageChosen(){if(this.model.get('uploading')||this.model.get('uploaded'))return;if(!this.$imageInput.val()){this.model.set('uploadStatus','');return;}var extra=this.prepareUpload();for(var k in extra){$('<input type=hidden>').attr('name',k).val(extra[k]).appendTo(this.$uploadForm);}this.$uploadForm.prop('action',util.uploadURL());this.$uploadForm.submit();this.$iframe.load(function(){if(!postForm)return;var doc=this.contentWindow||this.contentDocument;if(!doc)return;try{var error=$(doc.document||doc).text();if(/legitimate imager response/.test(error))return;if(error.length<5||error.length>100)error=lang.unknownUpload;postForm.uploadError(error);}catch(e) {setTimeout(function(){postForm.uploadFallbackMessage();},500);}});this.notifyUploading();},prepareUpload:function prepareUpload(){this.model.set('uploadStatus',lang.uploading);this.$input.focus();var attrs=this.model.attributes;return {spoiler:attrs.spoiler,op:attrs.op||0};},uploadFallbackMessage:function uploadFallbackMessage(){var a=this.model.attributes,stat=a.uploadStatus;if(!a.cancelled&&a.uploading&&(!stat||stat==lang.uploading))this.model.set('uploadStatus',lang.unknownResult);},notifyUploading:function notifyUploading(){this.model.set({uploading:true,cancelled:false});this.$input.focus();},resizeInput:function resizeInput(val){if(typeof val!=='string')val=this.$input.val();this.$sizer.text(val);var size=this.$sizer.width()+common.INPUT_ROOM;size=Math.max(size,inputMinSize-this.$input.offset().left-this.$el.offset().left);this.$input.css('width',size+'px');},onInput:function onInput(val){if(val===undefined||val instanceof $.Event)val=this.$input.val();var start=this.$input[0].selectionStart,end=this.$input[0].selectionEnd;var changed=false,m,time,video;while(true){m=val.match(embed.youtube_url_re);if(!m)break;time=this.findTimeArg(m[3])||this.findTimeArg(m[1])||m[4]||'';video='>>>/watch?v='+m[2]+time;val=embedRewrite(m,video);}while(true){m=val.match(embed.youtube_short_re);if(!m)break;time=this.findTimeArg(m[2])||'';video='>>>/watch?v='+m[1]+time;val=embedRewrite(m,video);}while(true){m=val.match(embed.soundcloud_url_re);if(!m)break;var sc='>>>/soundcloud/'+m[1];val=embedRewrite(m,sc);}while(true){m=val.match(embed.pastebin_re);if(!m)break;var pbin='>>>/pastebin/'+m[1];val=embedRewrite(m,pbin);}function embedRewrite(m,rw){var old=m[0].length;var newVal=val.substr(0,m.index)+rw+val.substr(m.index+old);changed=true;if(m.index<start){var diff=old-rw.length;start-=diff;end-=diff;}return newVal;}if(changed)this.$input.val(val);var nl=val.lastIndexOf('\\n');if(nl>=0){var ok=val.substr(0,nl);val=val.substr(nl+1);this.$input.val(val);if(this.model.get('sentAllocRequest')||/[^ ]/.test(ok))this.commit(ok+'\\n');}else {m=val.split('').reverse().join('').match(/^(\\s*\\S+\\s+\\S+)\\s+(?=\\S)/);if(m){var lim=val.length-m[1].length;this.commit(val.substr(0,lim));val=val.substr(lim);start-=lim;end-=lim;this.$input.val(val);this.$input[0].setSelectionRange(start,end);}}this.$input.attr('maxlength',common.MAX_POST_CHARS-this.char_count);this.resizeInput(val);},findTimeArg:function findTimeArg(params){if(!params||params.indexOf('t=')<0)return false;params=params.split('&');for(var i=0,len=params.length;i<len;i++){var pair='#p'+params[i];if(embed.youtube_time_re.test(pair))return pair;}return false;},commit:function commit(text){var lines;if(text.indexOf('\\n')>=0){lines=text.split('\\n');this.line_count+=lines.length-1;var breach=this.line_count-common.MAX_POST_LINES+1;if(breach>0){for(var i=0;i<breach;i++){lines.pop();}text=lines.join('\\n');this.line_count=common.MAX_POST_LINES;}}var left=common.MAX_POST_CHARS-this.char_count;if(left<text.length)text=text.substr(0,left);if(!text)return;this.char_count+=text.length;var attrs=this.model.attributes;if(!attrs.num&&!attrs.sentAllocRequest){main.send([common.INSERT_POST,this.allocationMessage(text,null)]);this.model.set({sentAllocRequest:true});}else if(attrs.num)main.send(text);else this.pending+=text;if(lines){lines[0]=this.$lineBuffer.text()+lines[0];this.$lineBuffer.text(lines.pop());for(var o=0,len=lines.length;o<len;o++){this.imouto.fragment(lines[o]+'\\n');}}else {this.$lineBuffer.append(document.createTextNode(text));this.$lineBuffer[0].normalize();}},allocationMessage:function allocationMessage(text,image){var msg={nonce:main.request('nonce:create')};function opt(key,val){if(val)msg[key]=val;}opt('name',main.$name.val().trim());opt('email',main.$email.val().trim());opt('subject',this.$subject.val().trim());opt('frag',text);opt('image',image);opt('op',this.model.get('op'));return msg;},onKeyDown:function onKeyDown(event){var _this=this;main.follow(function(){switch(event.which){case 13:event.preventDefault();case 32:var input=_this.$input[0];var val=_this.$input.val();val=val.slice(0,input.selectionStart)+(event.which==13?'\\n':' ')+val.slice(input.selectionEnd);_this.onInput(val);break;default:handle_shortcut.bind(_this)(event);}});},finish:function finish(){var _this2=this;if(this.model.get('num')){this.flushPending();this.commit(this.$input.val());this.$input.remove();this.$submit.remove();if(this.$uploadForm)this.$uploadForm.remove();if(this.$iframe){this.$iframe.remove();this.$iframe=null;}this.imouto.fragment(this.$lineBuffer.text());this.$buffer.replaceWith(this.$buffer.contents());this.$lineBuffer.remove();this.$blockquote.css({'margin-left':'','padding-left':''});main.send([common.FINISH_POST]);this.preserve=true;if(this.isThread)this.$el.append(main.oneeSama.replyBox());var missing=this.imouto.allRolls.sent-this.imouto.allRolls.seen;if(missing>0){(function(){var checkAgain=undefined;(checkAgain=function(n){setTimeout(function(){if(_this2.imouto.allRolls.seen==_this2.imouto.allRolls.sent||n==0)postSM.feed('done');else checkAgain(n-1);},100);})(5);})();}else postSM.feed('done');}else postSM.feed('done');},flushPending:function flushPending(){if(this.pending){main.send(this.pending);this.pending='';}},onToggle:function onToggle(event){var attrs=this.model.attributes;if(attrs.uploading||attrs.uploaded)return;event.preventDefault();event.stopImmediatePropagation();if(attrs.spoiler){this.model.set({spoiler:0});return;}var pick=common.pick_spoiler(attrs.nextSpoiler);this.model.set({spoiler:pick.index,nextSpoiler:pick.next});},onAllocation:function onAllocation(msg){var num=msg.num;state.ownPosts[num]=num;this.model.set({num:num});this.flushPending();var header=$(main.oneeSama.header(msg));this.$meta.replaceWith(header);this.$meta=header;if(!this.isThread)this.$el.addClass('editing');this.$el.attr('id','p'+num);if(msg.image)this.insertUploaded(msg.image);if(this.$uploadForm)this.$uploadForm.append(this.$submit);else this.$blockquote.after(this.$submit);if(this.isThread){this.$subject.siblings('label').andSelf().remove();this.$blockquote.show();this.resizeInput();this.$input.focus();}window.onbeforeunload=function(){return \"You have an unfinished post.\";};},insertUploaded:function insertUploaded(info){this.renderImage(null,info);this.$imageInput.siblings('strong').andSelf().remove();this.$cancel.remove();this.$uploadForm.find('#toggle').remove();this.flushPending();this.model.set({uploading:false,uploaded:true,sentAllocRequest:true});var $img=this.$el.find('img');this.$blockquote.css({'margin-left':$img.css('margin-right'),'padding-left':$img.width()});this.resizeInput();},dispatch:function dispatch(msg){var a=msg.arg;switch(msg.t){case 'alloc':this.onImageAllocation(a);break;case 'error':this.uploadError(a);break;case 'status':this.uploadStatus(a);break;}},onImageAllocation:function onImageAllocation(msg){var attrs=this.model.attributes;if(attrs.cancelled)return;if(!attrs.num&&!attrs.sentAllocRequest){main.send([common.INSERT_POST,this.allocationMessage(null,msg)]);this.model.set({sentAllocRequest:true});}else main.send([common.INSERT_IMAGE,msg]);},uploadError:function uploadError(msg){if(this.model.get('cancelled'))return;this.model.set({uploadStatus:msg,uploading:false});if(this.$uploadForm)this.$uploadForm.find('input[name=alloc]').remove();},uploadStatus:function uploadStatus(msg){if(this.model.get('cancelled'))return;this.model.set('uploadStatus',msg);},addReference:function addReference(num,sel){var val=this.$input.val();if(/^>>\\d+$/.test(val)){this.$input.val(val+'\\n');this.onInput();val=this.$input.val();}if(sel){sel=sel.split('\\n');for(var i=0,len=sel.length;i<len;i++){sel[i]='>'+sel[i];}num+='\\n'+sel.join('\\n')+'\\n';}this.$input.val(val+'>>'+num);this.$input[0].selectionStart=this.$input.val().length;this.onInput();this.$input.focus();},remove:function remove(){if(!this.preserve){if(this.isThread)this.$el.next('hr').remove();this.$el.remove();}this.$sizer.remove();if(this.$iframe){this.$iframe.remove();this.$iframe=null;}this.stopListening();window.onbeforeunload=null;},renderImage:imager.Hidamari.renderImage,autoExpandImage:function autoExpandImage(){return this;},fun:function fun(){}});exports.ComposerView=ComposerView;function openPostBox(num){postSM.feed('new',document.query('#p'+num+' aside.posting'));}main.reply('openPostBox',openPostBox);window.addEventListener('message',function(event){var msg=event.data;if(msg!=='OK'&&postForm)postForm.uploadError(msg);},false);main.$threads.on('click','a.quote',function(e){e.preventDefault();var post=e.target.closest('article, section'),gsel=getSelection(),num=util.getNum(post);function isInside(prop){var el=gsel[prop]&&gsel[prop].parentElement;return el&&el.closest('blockquote')&&el.closest('article, section')===post;}var sel=undefined;if(isInside('baseNode')&&isInside('focusNode'))sel=gsel.toString();openPostBox(util.getNum(post.closest('section')));postForm.addReference(num,sel);});\n\n},{\"../main\":\"main\",\"./article\":15,\"./embed\":17,\"./identity\":18,\"./imager\":19}],25:[function(require,module,exports){\n'use strict';var main=require('../main');var PostCommon=require('./common');var $=main.$;var _=main._;var Backbone=main.Backbone;var util=main.util;var oneeSama=main.oneeSama;var state=main.state;module.exports=PostCommon.extend({tagName:'section',render:function render(){var attrs=this.model.attributes;this.setElement(oneeSama.section(attrs)).insertIntoDOM();var reply=util.parseDOM(oneeSama.replyBox());if(attrs.num in state.ownPosts||!!main.request('postForm'))reply.style.display='none';this.el.append(reply);this.el.nextElementSibling.remove();return this;},insertIntoDOM:function insertIntoDOM(){main.$threads[0].query('aside').after(this.el,document.createElement('hr'));this.fun();},renderLocked:function renderLocked(locked){this.el.classList[locked?'add':'remove']('locked');},remove:function remove(){this.el.nextElementSibling.remove();this.el.remove();this.stopListening();return this;},shiftReplies:function shiftReplies(postForm){var attrs=this.model.attributes;var replies=attrs.replies;var lim=state.hotConfig.get('ABBREVIATED_REPLIES'),changed=undefined;if(postForm)lim--;var len=replies.slice().length;for(var i=len;i>lim;i--){var post=state.posts.get(replies.shift());if(!post)continue;if(post.get('image'))attrs.image_omit++;attrs.omit++;changed=true;post.remove();}if(changed)this.renderOmit(attrs.omit,attrs.image_omit);},renderOmit:function renderOmit(){var omit=arguments.length<=0||arguments[0]===undefined?this.model.get('omit'):arguments[0];var image_omit=arguments.length<=1||arguments[1]===undefined?this.model.get('image_omit'):arguments[1];if(omit===0)return;var _state$page$attribute=state.page.attributes;var thread=_state$page$attribute.thread;var href=_state$page$attribute.href;this.el.query('.omit').innerHTML=oneeSama.lang.abbrev_msg(omit,this.model.get('image_omit'),thread&&href.split('?')[0]);},bumpThread:function bumpThread(){this.el.nextElementSibling.remove();this.el.remove();this.insertIntoDOM();}});\n\n},{\"../main\":\"main\",\"./common\":16}],26:[function(require,module,exports){\n'use strict';var main=require('./main');var $=main.$;var Backbone=main.Backbone;var options=main.options;var state=main.state;var _document=document;var body=_document.body;var atBottom=undefined,lockIndicator=undefined,isThread=undefined;function cacheState(){lockIndicator=document.query('#lock');isThread=!!state.posts.get('thread');}state.page.on('change',cacheState);cacheState();function checkBottom(){atBottom=body.scrollHeight-window.innerHeight<=window.scrollY;if(lockIndicator)lockIndicator.style.visibility=atBottom?'visible':'hidden';}checkBottom();document.addEventListener('scroll',checkBottom);var referenceEl=undefined;function followDOM(func){var previous=referenceDistance(),ret=func();if(atBottom&&(!document.hidden||options.get('alwaysLock')))window.scrollTo(0,body.scrollHeight);else {if(!elExists(referenceEl))return ret;var delta=topDistance(referenceEl,true)-previous;if(delta)window.scrollBy(0,delta);}return ret;}main.follow=followDOM;function elExists(el){return el&&document.contains(el);}function topDistance(el,skipCheck){var _el$getBoundingClient=el.getBoundingClientRect();var top=_el$getBoundingClient.top;if(skipCheck||top>=0&&top<window.innerHeight)return top;return null;}function referenceDistance(){if(elExists(referenceEl)){var bounds=topDistance(referenceEl);if(bounds!==null)return bounds;}var _arr=['article','section','threads'];for(var _i=0;_i<_arr.length;_i++){var selector=_arr[_i];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=main.$threads[0].queryAll(selector)[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var el=_step.value;var bounds=topDistance(el);if(bounds!==null){referenceEl=el;return bounds;}}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}}}function aboveBanner(){if(!/^#p\\d+$/.test(location.hash))return;var $anchor=$(location.hash);if(!$anchor.length)return;$(window).scrollTop($anchor.offset().top-$('#banner').height());}main.reply('scroll:aboveBanner',aboveBanner);window.onload=aboveBanner;\n\n},{\"./main\":\"main\"}],27:[function(require,module,exports){\n'use strict';Object.defineProperty(exports,\"__esModule\",{value:true});exports.read=read;exports.addLinks=addLinks;var main=require('./main');var _=main._;var Backbone=main.Backbone;function read(href){var state={board:href.match(/\\/([a-zA-Z0-9]+?)\\//)[1],thread:href.match(/\\/(\\d+)(:?#\\d+)?(?:[\\?&]\\w+=\\w+)*$/),lastN:href.match(/[\\?&]last=(\\d+)/)};var _arr=['thread','lastN'];for(var _i=0;_i<_arr.length;_i++){var key=_arr[_i];var val=state[key];state[key]=val?parseInt(val[1]):0;}return state;}var page=exports.page=new Backbone.Model(read(location.href));var syncs=exports.syncs={};var ownPosts=exports.ownPosts={};var mine=exports.mine=new main.Memory('mine',2,true);var posts=exports.posts=new Backbone.Collection();main.on('state:clear',function(){main.$threads.innerHTML='';models.each(function(model){return model.dispatch('stopListening');});posts.reset();exports.syncs={};main.request('massExpander:unset');});var links=exports.links={};function addLinks(addition){if(addition){_.extend(links,addition);}}\n\n},{\"./main\":\"main\"}],28:[function(require,module,exports){\n'use strict';var main=require('./main');var $=main.$;var Backbone=main.Backbone;var common=main.common;var oneeSama=main.oneeSama;var options=main.options;var state=main.state;var serverTimeOffset=0;main.dispatcher[common.GET_TIME]=function(msg){if(!msg[0])return;serverTimeOffset=msg[0]-Date.now();};main.reply('time:offset',function(){return serverTimeOffset;});var renderTimer=undefined;function batcTimeRender(source){var rtime=arguments.length<=1||arguments[1]===undefined?options.get('relativeTime'):arguments[1];state.posts.each(function(model){return model.dispatch('renderTime');});if(renderTimer)clearTimeout(renderTimer);if(rtime)renderTimer=setTimeout(batcTimeRender,60000);}main.reply('time:render',batcTimeRender);options.on('change:relativeTime',batcTimeRender);function timer_from_el(el){if(!serverTimeOffset)return;el.classList.add('timerTicking');var start=el.getAttribute('start'),end=el.getAttribute('end'),maxh=common.pad(el.getAttribute('hour')),maxm=common.pad(el.getAttribute('min')),maxs=common.pad(el.getAttribute('sec'));(function moumouikkai(){if(!document.body.contains(el))return;var now=common.serverTime();if(now>end)return el.textContent=main.lang.finished;if(start>now){var countdown=Math.round((start-now)/1000);if(countdown===10)main.request('time:syncwatch');el.textContent='Countdown: '+countdown;return setTimeout(moumouikkai,1000);}var diff=now-start;var hour=Math.floor(diff/1000/60/60);diff-=hour*1000*60*60;var min=Math.floor(diff/1000/60);diff-=min*1000*60;var sec=Math.floor(diff/1000);el.textContent=common.pad(hour)+\":\"+common.pad(min)+\":\"+common.pad(sec)+\" / \"+maxh+\":\"+maxm+\":\"+maxs;return setTimeout(moumouikkai,1000);})();}function mouikkai(){setInterval(function(){var els=document.getElementsByTagName('syncwatch');for(var i=0;i<els.length;i++){if(els[i].classList.contains('timerTicking'))continue;timer_from_el(els[i]);}},1000);}main.defer(batcTimeRender).defer(mouikkai).defer(function(){var seconds=undefined;var el=document.getElementById('UTCClock').firstChild;el.addEventListener('click',handler);function handler(){seconds=true;this.removeAttribute('title');this.style.cursor='default';this.removeEventListener('click',handler);render();}function render(){if(!serverTimeOffset)return setTimeout(render,1000);el.innerHTML=oneeSama.readableUTCTime(new Date(common.serverTime()),seconds);setTimeout(render,seconds?1000:60000);}render();});\n\n},{\"./main\":\"main\"}],29:[function(require,module,exports){\n'use strict';var _templateObject=_taggedTemplateLiteral(['<syncwatch ','>\\n\\t\\t\\tsyncwatch\\n\\t\\t</syncwatch>'],['<syncwatch ','>\\n\\t\\t\\tsyncwatch\\n\\t\\t</syncwatch>']),_templateObject2=_taggedTemplateLiteral(['<span class=\"act\">\\n\\t\\t\\t<a href=\"','\"\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</a>\\n\\t\\t</span>'],['<span class=\"act\">\\n\\t\\t\\t<a href=\"','\"\\n\\t\\t\\t\\t','\\n\\t\\t\\t\\t','\\n\\t\\t\\t>\\n\\t\\t\\t\\t','\\n\\t\\t\\t</a>\\n\\t\\t</span>']);Object.defineProperty(exports,\"__esModule\",{value:true});exports.thumbStyles=undefined;exports.touchable_spoiler_tag=touchable_spoiler_tag;exports.imageUploadURL=imageUploadURL;exports.getNum=getNum;exports.getID=getID;exports.getModel=getModel;exports.parseEls=parseEls;exports.parseEl=parseEl;exports.listener=listener;exports.once=once;exports.outerWidth=outerWidth;exports.isSage=isSage;exports.serverTime=serverTime;exports.readable_dice=readable_dice;exports.pick_spoiler=pick_spoiler;exports.readable_filesize=readable_filesize;exports.pad=pad;exports.action_link_html=action_link_html;exports.resonableLastN=resonableLastN;exports.parse_name=parse_name;exports.randomID=randomID;exports.parseHTML=parseHTML;exports.commaList=commaList;exports.checkAuth=checkAuth;var _main=require('main');function _toArray(arr){return Array.isArray(arr)?arr:Array.from(arr);}function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}main.util=module.exports;function touchable_spoiler_tag(del){del.html='<del onclick=\"void(0)\">';}function imageUploadURL(){return (_main.config.hard.HTTP.upload||'../upload/')+'?id='+_main.state.page.get('connID');}function getNum(el){if(!el){return 0;}return parseInt(el.getAttribute('id').slice(1),10);}function getID(el){if(!el){return 0;}return getNum(el.closest('article, section'));}function getModel(el){var id=getID(el);if(!id)return null;return _main.state.posts.get(id);}function parseEls(string){var el=document.createElement('div');el.innerHTML=string;var children=el.childNodes;return Array.from(children);}function parseEl(string){var el=document.createElement('div');el.innerHTML=string;return el.firstChild;}function listener(el,type,selector,handler){el.addEventListener(type,function(event){if(event.target.matches(selector))handler.call(this,event);});}function once(el,type,handler){el.addEventListener(type,function(event){handler.call(this,event);el.removeEventListener(type,handler);});}function outerWidth(el){var style=getComputedStyle(el),props=['marginLeft','marginRight','paddingLeft','paddingRight'];var width=0;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=props[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var prop=_step.value;width+=parseInt(style[prop]);}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}return width;}function isSage(email){return email&&email.trim()==='sage';}var cachedOffset=undefined;function serverTime(){var d=Date.now();if(imports.isNode)return d;if(!cachedOffset)cachedOffset=imports.main.request('time:offset');return d+cachedOffset;}function readable_dice(bit,dice){var inner=undefined;switch(bit){case '#flip':inner=(dice[2]==2).toString();break;case '#8ball':inner=imports.hotConfig.EIGHT_BALL[dice[2]-1];break;case '#pyu':case '#pcount':case '#q':inner=dice[0];break;}if(inner!==undefined)return _main._.escape(bit+' ('+inner+')');if(/^#sw/.test(bit))return readableSyncwatch(dice[0]);return readableRegularDice(bit,dice);}function readableSyncwatch(dice){dice.class='embed';return parseHTML(_templateObject,dice);}function readableRegularDice(bit,_ref){var _ref2=_toArray(_ref);var max=_ref2[0];var bias=_ref2[1];var rolls=_ref2.slice(2);bit+=' (';var eq=rolls.length>1||bias;if(eq)bit+=rolls.join(', ');if(bias)bit+=bias<0?' - '+-bias:' + '+bias;var sum=bias;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=rolls[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var roll=_step2.value;sum+=roll;}}catch(err) {_didIteratorError2=true;_iteratorError2=err;}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally {if(_didIteratorError2){throw _iteratorError2;}}}return bit+(eq?' = ':'')+sum+')';}function pick_spoiler(metaIndex){var imgs=imports.config.SPOILER_IMAGES,n=imgs.length;var i=undefined;if(metaIndex<0)i=Math.floor(Math.random()*n);else i=metaIndex%n;return {index:imgs[i],next:(i+1)%n};}var thumbStyles=exports.thumbStyles=['small','sharp','hide'];function readable_filesize(size){if(size<1024)return size+' B';if(size<1048576)return Math.round(size/1024)+' KB';size=Math.round(size/104857.6).toString();return size.slice(0,-1)+'.'+size.slice(-1)+' MB';}function pad(n){return (n<10?'0':'')+n;}function action_link_html(href,name,id,cls){return parseHTML(_templateObject2,href,id&&' id=\"'+id+'\"',cls&&' class=\"'+cls+'\"',name);}function resonableLastN(n){return Number.isInteger(n)&&n<=500;}function parse_name(name){var tripcode='',secure='';var hash=name.indexOf('#');if(hash>=0){tripcode=name.substr(hash+1);name=name.substr(0,hash);hash=tripcode.indexOf('#');if(hash>=0){secure=_main._.escape(tripcode.substr(hash+1));tripcode=tripcode.substr(0,hash);}tripcode=_main._.escape(tripcode);}name=name.trim().replace(imports.hotConfig.EXCLUDE_REGEXP,'');return [name.substr(0,100),tripcode.substr(0,128),secure.substr(0,128)];}function randomID(len){var id='';for(var i=0;i<len;i++){var char=(Math.random()*36).toString(36)[0];if(Math.random()<0.5)char=char.toUpperCase();id+=char;}return id;}function parseHTML(callSite){if(typeof callSite==='string')return formatHTML(callSite);if(typeof callSite==='function')return formatHTML(callSite(args));var len=arguments.length;var args=[];for(var i=1;i<len;i++){args[i-1]=arguments[i];}var output=callSite.slice(0,len).map(function(text,i){var arg=args[i-1];var result=undefined;if(i===0||!arg&&arg!==0)result='';else if(arg instanceof Object)result=elementAttributes(arg);else result=arg;return result+text;}).join('');return formatHTML(output);}function formatHTML(str){var size=-1;return str.replace(/\\n(\\s+)/g,function(m,m1){if(size<0)size=m1.replace(/\\t/g,'    ').length;return m1.slice(Math.min(m1.length,size));}).replace(/^\\s*\\n/gm,'');}function elementAttributes(attrs){var html='';for(var key in attrs){html+=' ';var val=attrs[key];if(val===true)html+=key;else if(val||val===0)html+=key+'=\"'+val+'\"';}return html;}function commaList(items){var html='';var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=items[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var item=_step3.value;if(!item&&item!==0)continue;if(html)html+=', ';html+=item;}}catch(err) {_didIteratorError3=true;_iteratorError3=err;}finally {try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return();}}finally {if(_didIteratorError3){throw _iteratorError3;}}}return html;}function checkAuth(action){var cls=_main.config.staff.classes[main.ident&&main.ident.auth];return cls&&!!cls.rights[action];}\n\n},{\"main\":\"main\"}],\"main\":[function(require,module,exports){\n'use strict';var _templateObject=_taggedTemplateLiteral(['<style>\\n\\t\\t.locked:after {\\n\\t\\t\\tcontent: \"','\";\\n\\t\\t}\\n\\t\\t.locked > header nav:after {\\n\\t\\t\\tcontent: \" (',')\";\\n\\t\\t}\\n\\t</style>'],['<style>\\n\\t\\t.locked:after {\\n\\t\\t\\tcontent: \"','\";\\n\\t\\t}\\n\\t\\t.locked > header nav:after {\\n\\t\\t\\tcontent: \" (',')\";\\n\\t\\t}\\n\\t</style>']);var _fsm=require('./fsm');var _fsm2=_interopRequireDefault(_fsm);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}var _=require('underscore'),Backbone=require('backbone'),Cookie=require('js-cookie'),radio=require('backbone.radio');require('core-js');require('dom4');require('backbone.nativeview');Backbone.View=Backbone.NativeView;var main=module.exports=radio.channel('main');_.extend(main,{_:_,Backbone:Backbone,Cookie:Cookie,FSM:_fsm2.default,$script:require('scriptjs'),SockJS:require('sockjs-client'),_deferred:[],defer:function defer(func){main._deferred.push(func);return main;},execDefered:function execDefered(){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this._deferred[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var func=_step.value;func();}}catch(err) {_didIteratorError=true;_iteratorError=err;}finally {try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally {if(_didIteratorError){throw _iteratorError;}}}},dispatcher:{}});_.extend(main,{config:config,configHash:configHash,clientHash:clientHash,isMobile:isMobile});var cookieVersion=3;if(localStorage.cookieVersion!=cookieVersion){for(var cookie in Cookie.get()){var paths=main.config.boards.enabled.slice();paths.push('');var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=paths[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var path=_step2.value;Cookie.remove(cookie,{path:path});}}catch(err) {_didIteratorError2=true;_iteratorError2=err;}finally {try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally {if(_didIteratorError2){throw _iteratorError2;}}}}localStorage.cookieVersion=cookieVersion;}if(/[&\\?]debug=true/.test(location.href))main.config.hard.debug=true;if(main.config.hard.debug){radio.DEBUG=true;window.Backbone=Backbone;radio.tuneIn('main');}main.send=main.request.bind(main,'send');main.Memory=require('./memory');var lang=main.lang=require('lang'),state=main.state=require('./state'),util=require('./util'),common=main.common=require('./common');main.options=require('./options');main.scroll=require('./scroll');state.page.set('tabID',common.randomID(32));document.head.appendChild(util.parseDOM(common.parseHTML(_templateObject,lang.thread_locked,lang.locked)));_.extend(main,{$threads:document.query('threads'),$name:document.query('input[name=name]'),$email:document.query('input[name=email]'),connSM:new _fsm2.default('load'),postSM:new _fsm2.default('none')});_.extend(main,{loop:require('./loop'),time:require('./time'),amusement:require('./amusement')});main.posts=require('./posts');main.Extract=require('./extract');main.client=require('./client');main.conection=require('./connection');_.extend(main,{history:require('./history'),hide:require('./hide')});main.execDefered();main.request('loading:hide');\n\n},{\"./amusement\":1,\"./client\":2,\"./common\":3,\"./connection\":6,\"./extract\":7,\"./fsm\":8,\"./hide\":9,\"./history\":10,\"./loop\":11,\"./memory\":12,\"./options\":13,\"./posts\":20,\"./scroll\":26,\"./state\":27,\"./time\":28,\"./util\":29,\"backbone\":undefined,\"backbone.nativeview\":undefined,\"backbone.radio\":undefined,\"core-js\":undefined,\"dom4\":undefined,\"js-cookie\":undefined,\"lang\":undefined,\"scriptjs\":undefined,\"sockjs-client\":undefined,\"underscore\":undefined}]},{},[\"main\"])\n\n","/*\n * Dice rolls and fun JS injections\n */\n\nconst main = require('./main'),\n\t{$, common, state, oneeSama} = main;\n\n// Render dice rolls and other hash commands\noneeSama.hook('imouto', function (imouto) {\n\timouto.queueRoll = function (bit) {\n\t\tconst number = this.allRolls.sent++;\n\t\tlet info = this.allRolls[number];\n\t\tif (!info)\n\t\t\tinfo = this.allRolls[number] = {};\n\t\tinfo.bit = bit;\n\t\tinfo.$tag = $(this.callback('<strong>'));\n\t\tthis.strong = true;\n\t\tthis.callback(info.dice ? common.readable_dice(bit, info.dice) : bit);\n\t\tthis.strong = false;\n\t\tthis.callback('</strong>');\n\t};\n\timouto.allRolls = {sent: 0, seen: 0};\n});\n\n// Handle dice in the postForm\noneeSama.hook('insertOwnPost', ({dice}) => {\n\tlet postForm = main.request('postForm');\n\tif (!postForm || !postForm.imouto || !dice)\n\t\treturn;\n\tlet rolls = postForm.imouto.allRolls;\n\tfor (let i = 0, lim = dice.length; i < lim; i++) {\n\t\tconst n = rolls.seen++;\n\t\tlet info = rolls[n];\n\t\tif (!info)\n\t\t\tinfo = rolls[n] = {};\n\t\tinfo.dice = dice[i];\n\t\tif (info.$tag) {\n\t\t\tconst r = common.readable_dice(info.bit, info.dice);\n\t\t\tinfo.$tag.html(r);\n\t\t}\n\t}\n});\n\n// Execute server-sent JS in fun threads\nmain.dispatcher[common.EXECUTE_JS] = ([js]) => {\n\ttry {\n\t\teval(js);\n\t}\n\tcatch (e) {\n\t\tconsole.error(e);\n\t}\n};\n","/*\n * Handles the brunt of the post-related websocket calls\n */\n\nconst main = require('./main'),\n\t{_, common, dispatcher, util, posts, state} = main;\n\nconst online = document.query('#onlineCount');\n\n_.extend(dispatcher, {\n\t[common.INSERT_POST](message) {\n\t\tlet [msg, bump] = message;\n\t\tbump = bump && state.page.get('live');\n\t\tconst isThread = !msg.op,\n\t\t\t{num} = msg;\n\t\tif (isThread)\n\t\t\tstate.syncs[num] = 1;\n\t\tmsg.editing = true;\n\n\t\t// Did I create this post?\n\t\tlet el;\n\t\tconst {nonce} = msg;\n\t\tdelete msg.nonce;\n\t\tconst myNonce = main.request('nonce:get')[nonce];\n\t\tif (myNonce && myNonce.tab === state.page.get('tabID')) {\n\t\t\t// posted in this tab; transform placeholder\n\t\t\tstate.ownPosts[num] = true;\n\t\t\tmain.oneeSama.trigger('insertOwnPost', msg);\n\t\t\tmain.postSM.feed('alloc', msg);\n\t\t\tbump = false;\n\t\t\tmain.request('nonce:destroy', nonce);\n\n\t\t\t// if we've already made a placeholder for this post, use it\n\t\t\tconst postForm = main.request('postForm');\n\t\t\tif (postForm && postForm.el)\n\t\t\t\tel = postForm.el;\n\t\t}\n\n\t\t// Add to my post set. Separate `if`, so posts form other tabs also\n\t\t// register.\n\t\tif (myNonce) {\n\t\t\tmsg.mine = true;\n\t\t\tstate.mine.write(num);\n\t\t}\n\t\tstate.addLinks(msg.links);\n\n\t\t// Create model\n\t\tconst model = new posts.models[isThread ? 'Thread' : 'Post'](msg);\n\t\tconst view = new posts[isThread ? 'Section' : 'Article']({model, el,\n\t\t\tid: num});\n\t\tif (!el)\n\t\t\tview.render().insertIntoDOM();\n\t\tview.clientInit();\n\n\t\tcheckRepliedToMe(msg.links, num);\n\t\tmain.request('post:inserted', model);\n\n\t\tif (isThread)\n\t\t\treturn;\n\t\tconst parent = state.posts.get(msg.op);\n\t\tif (!parent)\n\t\t\treturn;\n\t\tparent.get('replies').push(num);\n\t\tif (state.page.get('thread'))\n\t\t\treturn;\n\t\tparent.dispatch('shiftReplies');\n\n\t\t// Bump thread to page top\n\t\tif (bump)\n\t\t\tparent.dispatch('bumpThread');\n\t},\n\t[common.INSERT_IMAGE](msg) {\n\t\tconst [num, img] = msg;\n\n\t\t// Did I just upload this?\n\t\tconst postModel = main.request('postModel'),\n\t\t\ttoPostForm = postModel && postModel.get('num') == num;\n\t\tif (toPostForm)\n\t\t\tmain.request('postForm').insertUploaded(img);\n\n\t\t// If the image gets inseted into the postForm, we don't need the\n\t\t// generic model to fire a separate image render\n\t\tmodelHandler(num, model => model.setImage(img, toPostForm));\n\t},\n\t[common.UPDATE_POST]([num, frag, extra = {}]) {\n\t\tmodelHandler(num, model => {\n\t\t\tstate.addLinks(extra.links);\n\t\t\tmodel.update(frag, extra);\n\t\t\tcheckRepliedToMe(extra.links, num);\n\n\t\t\t// Am I updating my own post?\n\t\t\tif (num in state.ownPosts)\n\t\t\t\tmain.oneeSama.trigger('insertOwnPost', extra);\n\t\t\telse\n\t\t\t\tmodel.dispatch('updateBody', frag);\n\t\t});\n\t},\n\t[common.FINISH_POST](msg) {\n\t\tconst [num] = msg;\n\t\tdelete state.ownPosts[num];\n\t\tmodelHandler(num, function (model) {\n\t\t\t// No change event listener to avoid extra overhead\n\t\t\tmodel.set('editing', false);\n\t\t\tmodel.dispatch('renderEditing', false);\n\t\t});\n\t},\n\t[common.DELETE_POSTS](msg) {\n\t\tmodelHandler(msg[0], model => model.deletePost(msg[1]));\n\t},\n\t[common.LOCK_THREAD](msg) {\n\t\tmodelHandler(msg[0], model => model.toggleLocked(true, msg[1]));\n\t},\n\t[common.UNLOCK_THREAD](msg) {\n\t\tmodelHandler(msg[0], model => model.toggleLocked(false, msg[1]));\n\t},\n\t[common.DELETE_IMAGES](msg) {\n\t\tmodelHandler(msg[0], model => model.removeImage(msg[1]));\n\t},\n\t[common.SPOILER_IMAGES](msg) {\n\t\tmodelHandler(msg[0], model => model.setSpoiler(msg[1], msg[2]));\n\t},\n\t[common.BAN](msg) {\n\t\t// Only a 0 is passed to unauthenticated clients, if the ban was not\n\t\t// set to be displayed publicly. Otherwise a post number. A side\n\t\t// effect of complying to the existing pub/sub spec. Authenticated\n\t\t// staff receive either a post number or 0 and detailed ban information.\n\t\tlet [num, info] = msg;\n\t\tif (!num) {\n\t\t\tif (!info)\n\t\t\t\treturn;\n\t\t\tinfo = JSON.parse(info);\n\t\t\tnum = info.num;\n\t\t}\n\t\tmodelHandler(num, model => model.setBan(num, info));\n\t},\n\t[common.BACKLINK](msg) {\n\t\tmodelHandler(msg[0], model => model.addBacklink(msg[1], msg[2]));\n\t},\n\t[common.ONLINE_COUNT](msg) {\n\t\tonline.textContent = '['+msg[0]+']';\n\t},\n\t// Sync settings with server\n\t[common.HOT_INJECTION](msg) {\n\t\tconst [force, hash, hotConfig] = msg;\n\n\t\t// Request new varibles, if hashes don't match\n\t\tif (!force && hash !== state.configHash)\n\t\t\tmain.send([common.HOT_INJECTION, true]);\n\t\t// Update variables and hash\n\t\telse if (force) {\n\t\t\tstate.configHash = hash;\n\t\t\tstate.hotConfig.set(hotConfig);\n\t\t}\n\t}\n});\n\ndispatcher[common.SYNCHRONIZE] = main.connSM.feeder('sync');\ndispatcher[common.INVALID] = main.connSM.feeder('invalid');\n\n// Check if new posts links to one of my posts\nfunction checkRepliedToMe(links, sourceNum) {\n\tif (!links)\n\t\treturn;\n\tconst mine = state.mine.readAll();\n\tfor (let num in links) {\n\t\tif (num in mine)\n\t\t\tmain.request('repliedToMe', sourceNum);\n\t}\n}\n\n// Find model and pass it to function, if it exists\nfunction modelHandler(num, func) {\n\tconst model = state.posts.get(num);\n\tif (model)\n\t\tfunc(model);\n}\n\n// Make the text spoilers toggle revealing on click\nutil.listener(document, 'click', 'del', function (event) {\n\tif (event.spoilt)\n\t\treturn;\n\tevent.spoilt = true;\n\tevent.target.classList.toggle('reveal');\n});\n","/*\n This file is used both by the server and client\n Keep that in mind, when making modifications\n */\n\n// Export everything in one big object\nmodule.exports = exports = require('./util')\nexports.OneeSama = require('./oneesama')\n","/*\n Rendering singleton both server and client-side\n */\n\nconst _ = require('underscore'),\n\tindex = require('./index'),\n\tutil = require('./util'),\n\t{config} = imports,\n\t{pad, parseHTML} = util;\n\nconst break_re = new RegExp(\"(\\\\S{\" + index.WORD_LENGTH_LIMIT + \"})\");\n\n// `>>>/${link}/` referal links and embeds\nconst ref_re = (function () {\n\tlet ref_re = String.raw`>>(\\d+|>\\/watch\\?v=[\\w-]{11}(?:#t=[\\dhms]{1,9})?\n\t\t|>\\/soundcloud\\/[\\w-]{1,40}\\/[\\w-]{1,80}|>\\/pastebin\\/\\w+`\n\t\t\t.replace(/[\\n\\t]+/gm, '');\n\n\tfor (let board in config.link_targets) {\n\t\tref_re += String.raw`|>\\/${board}\\/(?:\\w+\\/?)?`;\n\t}\n\n\tref_re += ')';\n\treturn new RegExp(ref_re);\n})();\n\n// Generate the static part of image search links\nconst searchBase = (function() {\n\tconst models = [\n\t\t{\n\t\t\tclass: 'google',\n\t\t\turl: 'https://www.google.com/searchbyimage?image_url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'G'\n\t\t},\n\t\t{\n\t\t\tclass: 'iqdb',\n\t\t\turl: 'http://iqdb.org/?url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'Iq'\n\t\t},\n\t\t{\n\t\t\tclass: 'saucenao',\n\t\t\turl: 'http://saucenao.com/search.php?db=999&url=',\n\t\t\ttype: 'thumb',\n\t\t\tsymbol: 'Sn'\n\t\t},\n\t\t{\n\t\t\tclass: 'desustorage',\n\t\t\ttype: 'MD5',\n\t\t\turl: 'https://desustorage.org/_/search/image/',\n\t\t\tsymbol: 'Ds'\n\t\t},\n\t\t{\n\t\t\tclass: 'exhentai',\n\t\t\ttype: 'SHA1',\n\t\t\turl: 'http://exhentai.org/?fs_similar=1&fs_exp=1&f_shash=',\n\t\t\tsymbol: 'Ex'\n\t\t}\n\t];\n\n\tlet base = [];\n\tfor (let i = 0, l = models.length; i < l; i++) {\n\t\tlet model = models[i];\n\t\tbase[i] = [\n\t\t\tparseHTML\n\t\t\t`<a target=\"_blank\"\n\t\t\t\t\trel=\"nofollow\"\n\t\t\t\t\tclass=\"imageSearch ${model.class}\"\n\t\t\t\t\thref=\"${model.url}`,\n\t\t\tmodel.type,\n\t\t\t`\">${model.symbol}</a>`\n\t\t];\n\t}\n\treturn base;\n})();\n\nclass OneeSama {\n\tconstructor(args) {\n\t\t_.extend(this, args);\n\t\tthis.hooks = {};\n\t}\n\thook(name, func) {\n\t\tlet hs = this.hooks[name];\n\t\tif (!hs)\n\t\t\tthis.hooks[name] = [func];\n\t\telse if (hs.indexOf(func) < 0)\n\t\t\ths.push(func);\n\t}\n\ttrigger(name, param) {\n\t\tlet hs = this.hooks[name];\n\t\tif (!hs)\n\t\t\treturn;\n\t\tfor (var i = 0; i < hs.length; i++)\n\t\t\ths[i].call(this, param);\n\t}\n\t// Render OP\n\tsection(data, cls = '') {\n\t\tthis.setModel(data);\n\t\tif (data.locked)\n\t\t\tcls += ' locked';\n\t\tif (data.editing)\n\t\t\tcls += ' editing';\n\t\treturn parseHTML\n\t\t\t`<section id=\"p${data.num}\" class=\"${cls}\">\n\t\t\t\t<div class=\"background glass\">\n\t\t\t\t\t${this.monogatari(data)}\n\t\t\t\t\t<span class=\"omit\"></span>\n\t\t\t\t</div>\n\t\t\t</section>`;\n\t}\n\t// Render reply\n\tarticle(data) {\n\t\tthis.setModel(data);\n\t\tlet cls = 'glass';\n\t\tif (data.editing)\n\t\t\tcls += ' editing';\n\t\treturn parseHTML\n\t\t\t`<article id=\"p${data.num}\" class=\"${cls}\">\n\t\t\t\t${this.monogatari(data)}\n\t\t\t</article>`;\n\t}\n\t// Set the current model of the posts we are parsing\n\tsetModel(model) {\n\t\tthis.model = model;\n\n\t\t// Initial post state [new_line, no_qoute, no_spoiler, no_dice]\n\t\tthis.state = [0, 0, 0, 0];\n\t\treturn this;\n\t}\n\t// Render common post components\n\tmonogatari(data) {\n\t\tconst {image, mod, body, backlinks, banned} = data;\n\n\t\t// Larger thumbnails for thread images\n\t\tif (image && !data.op)\n\t\t\timage.large = true;\n\n\t\treturn parseHTML\n\t\t\t`${this.header(data)}\n\t\t\t${image && this.image(image)}\n\t\t\t<div class=\"container\">\n\t\t\t\t${mod && this.modInfo(mod)}\n\t\t\t\t<blockquote>\n\t\t\t\t\t${this.body(body)}\n\t\t\t\t</blockquote>\n\t\t\t\t<small>\n\t\t\t\t\t${this.backlinks(backlinks)}\n\t\t\t\t</small>\n\t\t\t\t${banned && this.banned()}\n\t\t\t</div>`;\n\t}\n\theader(data) {\n\t\treturn parseHTML\n\t\t\t`<header>\n\t\t\t\t<input type=\"checkbox\" class=\"postCheckbox\">\n\t\t\t\t${data.subject && `<h3>${_.escape(data.subject)}</h3>`}\n\t\t\t\t${this.name(data)}\n\t\t\t\t${this.time(data.time)}\n\t\t\t\t${this.postNavigation(data)}\n\t\t\t\t${!this.full && !data.op && this.expansionLinks(data.num)}\n\t\t\t</header>\n\t\t\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>`;\n\t}\n\tname(data) {\n\t\tlet html = '<b class=\"name';\n\t\tconst {auth, email} = data;\n\t\tif (auth)\n\t\t\thtml += ` ${auth === 'admin' ? 'admin' : 'moderator'}`;\n\t\thtml += '\">';\n\t\tif (email) {\n\t\t\thtml += parseHTML `<a ${{\n\t\t\t\tclass: 'email',\n\t\t\t\thref: 'mailto:' + encodeURI(email),\n\t\t\t\ttarget: 'blank'\n\t\t\t}}>`;\n\t\t}\n\t\thtml += this.resolveName(data);\n\t\tif (email)\n\t\t\thtml += '</a>';\n\t\thtml += '</b>';\n\t\tif (data.mnemonic)\n\t\t\thtml += ' ' + this.mnemonic(data.mnemonic);\n\t\treturn html;\n\t}\n\tresolveName(data) {\n\t\tlet html = '';\n\t\tconst {trip, name, auth} = data;\n\t\tif (name || !trip) {\n\t\t\tif (name)\n\t\t\t\thtml += _.escape(name);\n\t\t\telse\n\t\t\t\thtml += this.lang.anon;\n\t\t\tif(trip)\n\t\t\t\thtml += ' ';\n\t\t}\n\t\tif (trip)\n\t\t\thtml += `<code>${_.escape(trip)}</code>`;\n\t\tif (auth)\n\t\t\thtml += ` ## ${imports.hotConfig.staff_aliases[auth] || auth}`;\n\t\treturn html;\n\t}\n\ttime(time) {\n\t\t// Format according to client's relative post timestamp setting\n\t\tlet title, text;\n\t\tconst readable = this.readableTime(time);\n\t\tif (this.rTime) {\n\t\t\ttitle = readable;\n\t\t\ttext = this.relativeTime(time, Date.now());\n\t\t}\n\t\treturn parseHTML\n\t\t\t`<time title=\"${title}\">\n\t\t\t\t${text || readable}\n\t\t\t</time>`;\n\t}\n\treadableTime(time) {\n\t\tlet d = new Date(time);\n\t\treturn pad(d.getDate()) + ' '\n\t\t\t+ this.lang.year[d.getMonth()] + ' '\n\t\t\t+ d.getFullYear()\n\t\t\t+ `(${this.lang.week[d.getDay()]})`\n\t\t\t+`${pad(d.getHours())}:${pad(d.getMinutes())}`;\n\t}\n\treadableUTCTime(d, seconds) {\n\t\tlet html = pad(d.getUTCDate()) + ' '\n\t\t\t+ this.lang.year[d.getUTCMonth()] + ' '\n\t\t\t+ d.getUTCFullYear()\n\t\t\t+ `(${this.lang.week[d.getUTCDay()]})`\n\t\t\t+`${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}`;\n\t\tif (seconds)\n\t\t\thtml += `:${pad(d.getUTCSeconds())}`;\n\t\thtml += ' UTC';\n\t\treturn html;\n\t}\n\t// Readable elapsed time since post\n\trelativeTime(then, now) {\n\t\tlet time = Math.floor((now - then) / 60000),\n\t\t\tisFuture;\n\t\tif (time < 1) {\n\t\t\t// Assume to be client clock imprecission\n\t\t\tif (time > -5)\n\t\t\t\treturn this.lang.just_now;\n\t\t\telse {\n\t\t\t\tisFuture = true;\n\t\t\t\ttime = -time;\n\t\t\t}\n\t\t}\n\n\t\tconst divide = [60, 24, 30, 12],\n\t\t\tunit = ['minute', 'hour', 'day', 'month'];\n\t\tfor (let i = 0; i < divide.length; i++) {\n\t\t\tif (time < divide[i])\n\t\t\t\treturn this.lang.ago(time, this.lang['unit_' + unit[i]],\n\t\t\t\t\tisFuture);\n\t\t\ttime = Math.floor(time / divide[i]);\n\t\t}\n\n\t\treturn this.lang.ago(time, this.lang.unit_year, isFuture);\n\t}\n\tmnemonic(mnem) {\n\t\treturn `<b class=\"mod addr\">${mnem}</b>`;\n\t}\n\tpostNavigation(post) {\n\t\tconst num = post.num,\n\t\t\top = post.op;\n\t\treturn parseHTML\n\t\t\t`<nav>\n\t\t\t\t<a href=\"${this.postURL(num, op)}\" class=\"history\">\n\t\t\t\t\tNo.\n\t\t\t\t</a>\n\t\t\t\t<a href=\"${this.postURL(num, op)}\" class=\"quote\">\n\t\t\t\t\t${num}\n\t\t\t\t</a>\n\t\t\t</nav>`;\n\t}\n\tpostURL(num, op) {\n\t\top = op || num;\n\t\treturn `${this.op == op ? '' : op}#${num}`;\n\t}\n\texpansionLinks(num) {\n\t\treturn parseHTML\n\t\t\t`<span class=\"act expansionLinks\">\n\t\t\t\t<a href=\"${num}\" class=\"history\">\n\t\t\t\t\t${this.lang.expand}\n\t\t\t\t</a>\n\t\t\t\t] [\n\t\t\t\t<a href=\"${num}?last=${this.lastN}\" class=\"history\">\n\t\t\t\t\t${this.lang.last} ${this.lastN}\n\t\t\t\t</a>\n\t\t\t</span>`;\n\t}\n\t// Append moderation information. Only exposed to authenticated staff.\n\tmodInfo(info) {\n\t\tlet html = '<b class=\"modLog admin\">';\n\t\tfor (let action of info) {\n\t\t\thtml += `${this.lang.mod.formatLog(action)}<br>`;\n\t\t}\n\t\thtml += '</b>';\n\t\treturn html;\n\t}\n\tbanned() {\n\t\treturn `<b class=\"admin banMessage\">${this.lang.mod.banMessage}</b>`;\n\t}\n\t// Render full blockqoute contents\n\tbody(body) {\n\t\tlet html = this.fragment(body);\n\t\tif (this.state[1])\n\t\t\thtml += '</em>';\n\t\tif (this.state[2])\n\t\t\thtml += '</del>';\n\t\treturn html;\n\t}\n\t// Parse commited blockqoute fragment\n\tfragment(frag) {\n\t\tconst lines = frag.split('\\n'),\n\t\t\t{state} = this;\n\t\tlet html = '';\n\t\tfor (let i = 0; i < lines.length; i++) {\n\t\t\t// Start a new line\n\t\t\tif (state[0] && i % 2) {\n\t\t\t\t// Close qoute\n\t\t\t\tif (state[1] % 2) {\n\t\t\t\t\thtml += '</em>';\n\t\t\t\t\tstate[1]++;\n\t\t\t\t}\n\t\t\t\thtml += '<br>';\n\t\t\t\tstate[0] = 0;\n\t\t\t}\n\n\t\t\t// Quote or line starts with link/embed\n\t\t\tlet line = lines[i];\n\t\t\tif (!state[0] && line.startsWith('>')) {\n\t\t\t\thtml += '<em>';\n\t\t\t\tstate[1]++;\n\t\t\t}\n\n\t\t\t// Bodies may be empty\n\t\t\tif (frag) {\n\t\t\t\tline.split(' ').forEach(word => html += this.parseWord(word));\n\t\t\t\tstate[0] = 1;\n\t\t\t}\n\t\t}\n\t\treturn html;\n\t}\n\tparseWord(word) {\n\t\tconst split = word.split(/\\[\\/?spoiler]/i);\n\t\tlet html = '';\n\t\tfor (let i = 0; i < split.length; i++) {\n\t\t\t// Insert spoiler tags\n\t\t\tif (i % 2) {\n\t\t\t\thtml += `<${this.state[2] % 2 ? '/' : ''}del>`;\n\n\t\t\t\t// Callback  needs to be executed with the curent state for\n\t\t\t\t// live client-side appends\n\t\t\t\tthis.state[2]++;\n\t\t\t}\n\t\t\tlet bit = split[i];\n\t\t\tconst ref = bit.match(ref_re);\n\t\t\tif (ref) {\n\t\t\t\thtml += this.redString(ref[1]);\n\t\t\t\tbit = bit.replace(ref_re, '');\n\t\t\t}\n\t\t\thtml += this.parseHashes(bit);\n\t\t}\n\t\treturn html;\n\t}\n\t// Resolve internal and external URL references\n\tredString(ref) {\n\t\tlet dest, linkClass;\n\t\tif (/^>\\/watch/.test(ref)) {\n\t\t\tdest = 'https://www.youtube.com/' + ref.slice(2);\n\t\t\tlinkClass = 'embed watch';\n\t\t}\n\t\telse if (/^>\\/soundcloud/.test(ref)) {\n\t\t\tdest = 'https://soundcloud.com/' + ref.slice(13);\n\t\t\tlinkClass = 'embed soundcloud';\n\t\t}\n\t\telse if (/^>\\/pastebin/.test(ref)) {\n\t\t\tdest = 'https://pastebin.com/' + ref.slice(11);\n\t\t\tlinkClass = 'embed pastebin';\n\t\t}\n\n\t\t// Linkify other `>>>/${link}/` URLs\n\t\tfor (let link in config.link_targets) {\n\t\t\tconst m = ref.match(new RegExp(String\n\t\t\t\t.raw`^>\\/(${link})\\/(\\w+\\/?)?`));\n\t\t\tif (!m)\n\t\t\t\tcontinue;\n\t\t\tdest = config.link_targets[link];\n\t\t\tif (m[2])\n\t\t\t\tdest += m[2];\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!dest)\n\t\t\treturn this.tamashii(parseInt(ref, 10));\n\n\t\tconst attrs = {\n\t\t\thref: encodeURI(dest),\n\t\t\ttarget: '_blank',\n\t\t\trel: 'nofollow',\n\t\t\tclass: linkClass\n\t\t};\n\t\treturn parseHTML\n\t\t\t`<a ${attrs}>\n\t\t\t\t>>${_.escape(ref)}\n\t\t\t</a>`;\n\t}\n\t// Render hash commands\n\tparseHashes(text) {\n\t\tif (!this.model.dice)\n\t\t\treturn this.linkify(text);\n\n\t\tlet html = '';\n\t\tconst bits = text.split(util.dice_re);\n\t\tfor (let i = 0; i < bits.length; i++) {\n\t\t\tconst bit = bits[i];\n\t\t\tif (!(i % 2) || !util.parse_dice(bit))\n\t\t\t\thtml += this.linkify(bit);\n\t\t\telse if (this.queueRoll)\n\t\t\t\tthis.queueRoll(bit);\n\t\t\telse {\n\t\t\t\tif (this.state[0])\n\t\t\t\t\thtml += ' ';\n\t\t\t\tconst dice = this.model.dice[this.state[3]++];\n\t\t\t\thtml += `<strong>${util.readable_dice(bit, dice)}</strong>`;\n\t\t\t}\n\t\t}\n\t\treturn html;\n\t}\n\t// Render external URLs as links\n\tlinkify(text) {\n\t\t// Disabled in client options\n\t\tif (!this.eLinkify)\n\t\t\treturn this.padWord(_.escape(text));\n\n\t\tlet html = '';\n\t\tconst bits = text.split(/(https?:\\/\\/[^\\s\"<>]*[^\\s\"<>'.,!?:;])/);\n\t\tfor (let i = 0, len = bits.length; i < len; i++) {\n\t\t\tlet escaped = _.escape(bits[i]);\n\t\t\tif (i % 2) {\n\t\t\t\thtml += parseHTML\n\t\t\t\t\t`<a href=\"${escaped}\" rel=\"nofollow\" target=\"_blank\">\n\t\t\t\t\t\t${this.padWord(escaped)}\n\t\t\t\t\t</a>`;\n\t\t\t}\n\t\t\telse if (escaped)\n\t\t\t\thtml += this.padWord(escaped);\n\t\t}\n\t\treturn html;\n\t}\n\tpadWord(word) {\n\t\tif (this.state[0])\n\t\t\tword = ' ' + word;\n\t\treturn word;\n\t}\n\tbacklinks(links) {\n\t\tif (!links)\n\t\t\treturn '';\n\t\tlet html = '';\n\t\tfor (let num in links) {\n\t\t\tif (html)\n\t\t\t\thtml += ' ';\n\t\t\thtml += this.postRef(num, links[num]);\n\t\t}\n\t\treturn html;\n\t}\n\t// Central image rendering method\n\timage(data, reveal) {\n\t\tconst showThumb = this.thumbStyle !== 'hide' || reveal;\n\t\treturn parseHTML\n\t\t\t`<figure>\n\t\t\t\t${this.figcaption(data, reveal)}\n\t\t\t\t${showThumb && config.IMAGE_HATS && '<span class=\"hat\"></span>'}\n\t\t\t\t${showThumb && this.thumbnail(data)}\n\t\t\t</figure>`;\n\t}\n\t// Image header\n\tfigcaption(data, reveal) {\n\t\tconst list = util.commaList([\n\t\t\tdata.audio && '\\u266B',\n\t\t\tdata.length,\n\t\t\tutil.readable_filesize(data.size),\n\t\t\t`${data.dims[0]}x${data.dims[1]}`,\n\t\t\tdata.apng && 'APNG'\n\t\t]);\n\t\treturn parseHTML\n\t\t\t`<figcaption>\n\t\t\t\t${this.thumbStyle === 'hide' && this.hiddenToggle(reveal)}\n\t\t\t\t${this.imageSearch(data)}\n\t\t\t\t<span>\n\t\t\t\t\t(${list})\n\t\t\t\t</span>\n\t\t\t\t${this.imageLink(data)}\n\t\t\t</figcaption>`;\n\t}\n\thiddenToggle(reveal) {\n\t\treturn parseHTML\n\t\t\t`<a class=\"imageToggle\">\n\t\t\t\t[${this.lang[reveal ? 'hide' : 'show']}]\n\t\t\t</a>`;\n\t}\n\timageSearch(data) {\n\t\tlet html = '';\n\t\tlet base = searchBase;\n\t\t// Only render google for PDFs and MP3s\n\t\tif (['.pdf', '.mp3'].indexOf(data.ext) > -1)\n\t\t\tbase = [base[0]];\n\t\t// Only use HTTP for thumbnail image search, because IQDB and\n\t\t// Saucenao can't into certain SSL cyphers\n\t\tconst imageURl = this.thumbPath(data)\n\t\tfor (let i = 0, l = base.length; i < l; i++) {\n\t\t\tlet parts = base[i];\n\t\t\thtml += parts[0]\n\t\t\t\t+ encodeURI(parts[1] !== 'thumb' ?  data[parts[1]] : imageURl)\n\t\t\t\t+ parts[2];\n\t\t}\n\n\t\treturn html;\n\t}\n\t// Get thumbnail path, even if no thumbnail generated\n\tthumbPath(data, mid) {\n\t\tlet type = 'thumb';\n\t\tif (mid && data.mid)\n\t\t\ttype = 'mid';\n\t\telse if (!data.thumb)\n\t\t\ttype = 'src';\n\n\t\treturn this.imagePaths()[type] + data[type];\n\t}\n\timagePaths() {\n\t\tif (!this._imgPaths) {\n\t\t\tconst mediaURL = config.MEDIA_URL;\n\t\t\tthis._imgPaths = {\n\t\t\t\tsrc: mediaURL + 'src/',\n\t\t\t\tthumb: mediaURL + 'thumb/',\n\t\t\t\tmid: mediaURL + 'mid/',\n\t\t\t\tspoil: mediaURL + 'spoil/spoiler'\n\t\t\t};\n\t\t}\n\t\treturn this._imgPaths;\n\t}\n\timageLink(data) {\n\t\tlet name = '',\n\t\t\timgnm = data.imgnm;\n\t\tconst m = imgnm.match(/^(.*)\\.\\w{3,4}$/);\n\t\tif (m)\n\t\t\tname = m[1];\n\t\tconst fullName = _.escape(imgnm),\n\t\t\ttooLong = name.length >= 38;\n\t\tif (tooLong)\n\t\t\timgnm = _.escape(name.slice(0, 30))\n\t\t\t\t+ '(&hellip;)'\n\t\t\t\t+ _.escape(data.ext);\n\t\tconst attrs = {\n\t\t\thref: `${config.SECONDARY_MEDIA_URL}src/${data.src}`,\n\t\t\trel: 'nofollow',\n\t\t\tdownload: fullName\n\t\t};\n\t\tif (tooLong)\n\t\t\tattrs.title = fullName;\n\n\t\treturn parseHTML\n\t\t\t`<a ${attrs}>\n\t\t\t\t${imgnm}\n\t\t\t</a>`;\n\t}\n\tthumbnail(data, href) {\n\t\tconst paths = this.imagePaths(),\n\t\t\tdims = data.dims;\n\t\tlet src = paths.src + (data.src),\n\t\t\tthumb,\n\t\t\twidth = dims[0],\n\t\t\theight = dims[1],\n\t\t\tthumbWidth = dims[2],\n\t\t\tthumbHeight = dims[3];\n\n\t\t// Spoilered and spoilers enabled\n\t\tif (data.spoiler && this.spoilToggle) {\n\t\t\tlet sp = this.spoilerInfo(data);\n\t\t\tthumb = sp.thumb;\n\t\t\tthumbWidth = sp.dims[0];\n\t\t\tthumbHeight = sp.dims[1];\n\t\t}\n\t\t// Animated GIF thumbnails\n\t\telse if (data.ext === '.gif' && this.autoGif)\n\t\t\tthumb = src;\n\t\telse\n\t\t\tthumb = this.thumbPath(data, this.thumbStyle !== 'small');\n\n\t\t// Source image smaller than thumbnail and other fallbacks\n\t\tif (!thumbWidth) {\n\t\t\tthumbWidth = width;\n\t\t\tthumbHeight = height;\n\t\t}\n\n\t\tlet linkAttrs = {\n\t\t\ttarget: '_blank',\n\t\t\trel: 'nofollow',\n\t\t\thref: href || src\n\t\t};\n\t\tlet imgAttrs = {\n\t\t\tsrc: thumb,\n\t\t\twidth: thumbWidth,\n\t\t\theight: thumbHeight\n\t\t};\n\t\t// Catalog pages\n\t\tif (href) {\n\t\t\t// Handle the thumbnails with the HTML5 History controller\n\t\t\tlinkAttrs.class = 'history';\n\t\t\t// No image hover previews\n\t\t\timgAttrs.class = 'expanded';\n\t\t\tif(this.thumbStyle == 'hide')\n\t\t\t\timgAttrs.style= 'display: none';\n\t\t}\n\n\t\treturn parseHTML\n\t\t\t`<a ${linkAttrs}>\n\t\t\t\t<img ${imgAttrs}>\n\t\t\t</a>`\n\t}\n\tspoilerInfo(data) {\n\t\tlet highDef = data.large || this.thumbStyle !== 'small';\n\t\treturn {\n\t\t\tthumb: parseHTML\n\t\t\t\t`${this.imagePaths().spoil}${highDef && 's'}${data.spoiler}.png`,\n\t\t\tdims: config[data.large ? 'THUMB_DIMENSIONS' : 'PINKY_DIMENSIONS']\n\t\t};\n\t}\n\tpostRef(num, op, desc_html) {\n\t\tlet ref = '&gt;&gt;' + num;\n\t\tif (desc_html)\n\t\t\tref += ' ' + desc_html;\n\t\tif (this.op && this.op != op)\n\t\t\tref += ' \\u27a1';\n\t\telse if (num == op && this.op == op)\n\t\t\tref += ' (OP)';\n\t\treturn `<a href=\"${this.postURL(num, op)}\" class=\"history\">${ref}</a>`;\n\t}\n\tasideLink(inner, href, cls, innerCls) {\n\t\treturn parseHTML\n\t\t\t`<aside class=\"act glass ${cls}\">\n\t\t\t\t<a ${href && `href=\"${href}\"`}\n\t\t\t\t\t${innerCls && ` class=\"${innerCls}\"`}\n\t\t\t\t>\n\t\t\t\t\t${this.lang[inner] || inner}\n\t\t\t\t</a>\n\t\t\t</aside>`\n\t}\n\treplyBox() {\n\t\treturn this.asideLink('reply', null, 'posting');\n\t}\n\tnewThreadBox() {\n\t\treturn this.asideLink('newThread', null, 'posting');\n\t}\n}\nmodule.exports = OneeSama;\n","\"use strict\";\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsImZpbGUiOiJ1dGlsLmpzIiwic291cmNlc0NvbnRlbnQiOltdfQ==","/*\n * Websocket controller and connection notifier\n */\n\nconst main = require('./main'),\n\t{_, common, config, connSM, state, SockJS} = main,\n\tlang = main.lang.sync;\n\nlet socket, attempts, attemptTimer;\n\nfunction send(msg) {\n\t// need deferral or reporting on these lost messages...\n\tif (connSM.state != 'synced' && connSM.state != 'syncing')\n\t\treturn;\n\tif (socket.readyState != SockJS.OPEN) {\n\t\tif (console)\n\t\t\tconsole.warn(\"Attempting to send while socket closed\");\n\t\treturn;\n\t}\n\n\tmsg = JSON.stringify(msg);\n\tif (config.DEBUG)\n\t\tconsole.log('<', msg);\n\tsocket.send(msg);\n}\nmain.reply('send', send);\n\nfunction on_message(e) {\n\tif (config.DEBUG)\n\t\tconsole.log('>', e.data);\n\n\tconst msg = JSON.parse(e.data)[0],\n\t\top = msg.shift(),\n\t\ttype = msg.shift(),\n\t\tisPubSub = common.is_pubsub(type);\n\n\tif (isPubSub && connSM.state === 'locked')\n\t\treturn;\n\n\t// Some handlers are optional and/or dynamic. Ignore them silently.\n\tconst handler = main.dispatcher[type];\n\tif (!handler)\n\t\treturn;\n\tif (isPubSub && op in state.syncs)\n\t\tstate.syncs[op]++;\n\tmain.follow(() => handler(msg, op));\n}\n\nconst sync = document.getElementById('sync');\nfunction sync_status(msg) {\n\tsync.textContent = msg;\n}\n\nconnSM.act('load + start -> conn', function () {\n\tsync_status(lang.connecting);\n\tattempts = 0;\n\tconnect();\n});\n\nfunction connect() {\n\tif (socket) {\n\t\tsocket.onclose = null;\n\t\tsocket.onmessage = null;\n\t}\n\tif (window.location.protocol == 'file:') {\n\t\tconsole.log(\"Page downloaded locally; refusing to sync.\");\n\t\treturn;\n\t}\n\tsocket = new_socket();\n\tsocket.onopen = connSM.feeder('open');\n\tsocket.onclose = connSM.feeder('close');\n\tsocket.onmessage = on_message;\n\tif (config.DEBUG)\n\t\twindow.socket = socket;\n}\n\nfunction new_socket() {\n\tconst transports = ['xdr-streaming', 'xhr-streaming', 'iframe-eventsource',\n\t\t'iframe-htmlfile', 'xdr-polling', 'xhr-polling', 'iframe-xhr-polling',\n\t\t'jsonp-polling'];\n\tif (config.USE_WEBSOCKETS)\n\t\ttransports.unshift('websocket');\n\treturn new SockJS(config.SOCKET_URL || config.SOCKET_PATH, null, {\n\t\ttransports\n\t});\n}\n\nconnSM.act('conn, reconn + open -> syncing', () => {\n\tsync_status(lang.syncing);\n\tconst connID = common.randomID(32),\n\t\t{page} = state;\n\tpage.set('connID', connID);\n\tsend([common.SYNCHRONIZE, connID, page.get('board'), state.syncs,\n\t\tpage.get('live'), document.cookie]);\n});\n\nconnSM.act('syncing + sync -> synced', function () {\n\tsync_status(lang.synced);\n\tattemptTimer = setTimeout(function () {\n\t\tattemptTimer = 0;\n\t\treset_attempts();\n\t}, 10000);\n});\n\nfunction reset_attempts() {\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tattempts = 0;\n}\n\n// Prevent pub/sub mesages from being handled\nconnSM.act('synced, syncing + lock -> locked');\nconnSM.act('locked + unlock -> synced');\nmain.reply('connection:lock', () => send([common.DESYNC]), connSM.feed('lock'));\nmain.reply('connection:unlock', msg => send(msg), connSM.feed('unlock'));\n\nconnSM.act('* + close -> dropped',  error => {\n\tif (socket) {\n\t\tsocket.onclose = null;\n\t\tsocket.onmessage = null;\n\t}\n\tif (config.DEBUG)\n\t\tconsole.error('E:', error);\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tsync_status(lang.dropped);\n\n\t// Wait maxes out at ~1min\n\tconst wait = 500 * Math.pow(1.5, Math.min(Math.floor(++attempts / 2), 12));\n\tsetTimeout(connSM.feeder('retry'), wait);\n});\n\nconnSM.act('dropped + retry -> reconn', function () {\n\tconnect();\n\t/* Don't show this immediately so we don't thrash on network loss */\n\tsetTimeout(function () {\n\t\tif (connSM.state == 'reconn')\n\t\t\tsync_status(lang.reconnecting);\n\t}, 100);\n});\n\nconnSM.act('* + invalid, desynced + close -> desynced', msg => {\n\tmsg = (msg && msg[0]) ? 'Out of sync: ' + msg[0] : 'Out of sync';\n\tsync_status(msg);\n\tif (attemptTimer) {\n\t\tclearTimeout(attemptTimer);\n\t\tattemptTimer = 0;\n\t}\n\tsocket.onclose = null;\n\tsocket.onmessage = null;\n\tsocket.close();\n\tsocket = null;\n\tif (config.DEBUG)\n\t\twindow.socket = null;\n});\n\nfunction window_focused() {\n\tswitch (connSM.state) {\n\t\tcase 'desynced':\n\t\t\treturn;\n\t\t// might have just been suspended;\n\t\t// try to get our FSM up to date if possible\n\t\tcase 'synced':\n\t\tcase 'syncing':\n\t\tcase 'conn':\n\t\t\tconst rs = socket.readyState;\n\t\t\tif (rs != SockJS.OPEN && rs != SockJS.CONNECTING) {\n\t\t\t\tconnSM.feed('close');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\telse if (navigator.onLine === false) {\n\t\t\t\tconnSM.feed('close');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tbreak;\n\t}\n\tconnSM.feed('retry');\n}\n\n// Connect to server\nconnSM.feed('start');\n\n// Check for connectivity each time tab visibility changes to visible\n// A bit of an overhead, but should prevent unregistered disconnects,\n// especially on mobile.\ndocument.addEventListener('visibilitychange', e => {\n\tif (e.target.hidden)\n\t\treturn;\n\tsetTimeout(window_focused, 20);\n});\nwindow.addEventListener('online', () => reset_attempts(), connSM.feed('retry'));\nwindow.addEventListener('offline', connSM.feeder('close'));\n","/*\n * Extact model data from the thread tree HTML and populate models and views\n */\n\nconst main = require('./main'),\n\t{_, util, options, state, posts} = main;\n\nclass Extract {\n\tconstructor(catalog) {\n\t\tconst el = main.$threads[0];\n\n\t\t// Read serialised model data\n\t\tconst json = JSON.parse(document.getElementById('postData').innerHTML);\n\t\tmain.request('notify:title', json.title);\n\n\t\t// We don't need models on catalog pages\n\t\tif (catalog)\n\t\t\treturn;\n\n\t\tconst mine = this.mine = state.mine.readAll(),\n\t\t\tposts = this.posts = json.posts;\n\t\tthis.extractReplies(el);\n\t\tthis.extractThreads(el);\n\n\t\tstate.addLinks(json.links);\n\t\t// Forward posts that replied to my post\n\t\tfor (let post in posts) {\n\t\t\tconst links = posts[post].links;\n\t\t\tif (!links)\n\t\t\t\tcontinue;\n\t\t\tfor (let num in links) {\n\t\t\t\tif (num in mine)\n\t\t\t\t\tmain.request('repliedToMe', posts[post].num);\n\t\t\t}\n\t\t}\n\n\t\t// Apply various client-only DOM modifications\n\t\tif (options.get('anonymise'))\n\t\t\tmain.request('loop:anonymise');\n\t\tmain.request('time:render');\n\t}\n\textractReplies(el) {\n\t\tlet articles = el.getElementsByTagName('article');\n\t\tfor (let i = 0, l = articles.length; i < l; i++) {\n\t\t\tlet article = articles[i];\n\t\t\tnew posts.Article({\n\t\t\t\tmodel: new posts.models.Post(this.extractModel(article)),\n\t\t\t\tel: article\n\t\t\t});\n\t\t}\n\t}\n\textractThreads(el) {\n\t\tlet sections = el.getElementsByTagName('section');\n\t\tfor (let i = 0; i < sections.length ; i++) {\n\t\t\tlet section = sections[i];\n\t\t\tconst model = this.extractModel(section);\n\t\t\tnew posts.Section({\n\t\t\t\tmodel: new posts.models.Thread(model),\n\t\t\t\tel: section\n\t\t\t})\n\t\t\t\t .renderOmit();\n\t\t\t// Read the sync ID of the thread. Used later for syncronising\n\t\t\t// with the server.\n\t\t\tstate.syncs[model.num] = model.hctr;\n\t\t}\n\t}\n\textractModel(el) {\n\t\tlet info = this.posts[util.getNum(el)];\n\t\t// Did I make this post?\n\t\tif (info.num in this.mine)\n\t\t\tinfo.mine = true;\n\t\treturn info;\n\t}\n}\nmodule.exports = Extract;\n\n// Initial extraction. No need to defer, as we actually want it to hit ASAP.\nnew Extract(state.page.get('catalog'));\n","3/**\n * Finite State Machine\n */\nexport default class FSM {\n    /**\n     * Create a new finite state machine\n     * @param {string} start - Initial state\n     */\n    constructor(start) {\n        this.state = start\n        this.spec = {\n            acts: {},\n            ons: {},\n            wilds: {},\n            preflights: {}\n        }\n    }\n\n    /**\n     * Clone the current FSM\n     * @returns {FSM}\n     */\n    clone() {\n        const second = new FSM(this.state)\n        second.spec = this.spec\n        return second\n    }\n\n    /**\n     * Assign a handler to be execute on arrival to a new state\n     * @param {string} key - Target state\n     * @param {function} f - Handler\n     */\n    on(key, f) {\n        const ons = this.spec.ons[key]\n        if (ons) {\n            ons.push(f)\n        } else {\n            this.spec.ons[key] = [f]\n        }\n    }\n\n    /**\n     * Assign sanity check to perform before transition to a new state\n     * @param {string} key - Target state\n     * @param {function} f - Handler\n     */\n    preflight(key, f) {\n        const pres = this.spec.preflights[key]\n        if (pres) {\n            pres.push(f)\n        } else {\n            this.spec.preflights[key] = [f]\n        }\n    }\n\n    /**\n     * Specify transition and an optional handler to execute on it\n     * @param {string} trans_spec - Transition specification\n     * @param {function=} on_func - Handler\n     */\n    act(trans_spec, on_func) {\n        const halves = trans_spec.split('->')\n        if (halves.length != 2) {\n            throw new Error(\"Bad FSM spec: \" + trans_spec)\n        }\n        const parts = halves[0].split(','),\n            dest = halves[1].match(/^\\s*(\\w+)\\s*$/)[1]\n        let tok\n        for (let i = parts.length - 1; i >= 0; i--) {\n            const part = parts[i],\n                m = part.match(/^\\s*(\\*|\\w+)\\s*(?:\\+\\s*(\\w+)\\s*)?$/)\n            if (!m) {\n                throw new Error(\"Bad FSM spec portion: \" + part)\n            }\n            if (m[2]) {\n                tok = m[2]\n            }\n            if (!tok) {\n                throw new Error(\"Tokenless FSM action: \" + part)\n            }\n            const src = m[1]\n            if (src == '*') {\n                this.spec.wilds[tok] = dest\n            } else {\n                let acts = this.spec.acts[src]\n                if (!acts) {\n                    this.spec.acts[src] = acts = {}\n                }\n                acts[tok] = dest\n            }\n        }\n        if (on_func) {\n            this.on(dest, on_func)\n        }\n    }\n\n    /**\n     * Transition the FSM to a new state\n     * @param {string} ev - Target state\n     * @param {*} param - Argument for the handler functions\n     * @returns {bool} - Passed preflight sanity check, if any\n     */\n    feed(ev, param) {\n        const {spec} = this,\n            from = this.state,\n            acts = spec.acts[from],\n            to = (acts && acts[ev]) || spec.wilds[ev]\n        if (to && from != to) {\n            const ps = spec.preflights[to]\n            for (let i = 0; ps && i < ps.length; i++) {\n                if (!ps[i].call(this, param)) {\n                    return false\n                }\n            }\n            this.state = to\n            const fs = spec.ons[to]\n            for (let i = 0; fs && i < fs.length; i++) {\n                fs[i].call(this, param)\n            }\n        }\n        return true\n    }\n\n    /**\n     * Returns a function that executes FSM.prototype.feed with the suplied\n     * argument\n     * @param {string} ev - Target state\n     * @returns {function}\n     */\n    feeder(ev) {\n        return param =>  this.feed(ev, param)\n    }\n}\n","/*\n Hide posts you don't like\n */\n\nlet main = require('./main');\n\n// Remember hidden posts for 7 days only to prevent the cookie from\n// eclipsing the Sun\nlet hidden = new main.Memory('hide', 7, true);\n\nmain.reply('hide', function(model) {\n\t// Hiding your own posts would open up the gates for a ton of bugs. Fuck\n\t// that.\n\tif (model.get('mine'))\n\t\treturn;\n\tconst count = hidden.write(model.get('num'));\n\tmodel.remove();\n\n\t// Forward number to options menu\n\tmain.request('hide:render', count);\n});\n\nmain.reply('hide:clear', () => hidden.purgeAll());\n\n// Initial render\nmain.defer(() => main.request('hide:render', hidden.size()));\n","/*\n * Inter board/page/thread navigation with HTML5 history\n */\n\nlet main = require('./main'),\n\t{$, _, common, Extract, state} = main;\n\n// Click handler for post/thread/board links\nmain.$doc.on ('click', 'a.history', function(event) {\n\tif (event.ctrlKey)\n\t\treturn;\n\treadingSteiner(this.href, event);\n});\n\n// Loading status GIF\nlet $loading = $('#loadingImage');\nmain.reply('loading:show', () => $loading.show());\nmain.reply('loading:hide', () => $loading.hide());\n\n// Navigate to the URL\nfunction readingSteiner(url, event) {\n\tlet nextState = state.read(url);\n\t// Does the link point to the same page as this one?\n\tif (_.isMatch(state.page.attributes, nextState))\n\t\treturn;\n\n\t// Disconnect server-side Yakusoku in preparation for navigating away.\n\t// This helps avoid duplicate messages mid-navigation.\n\tmain.request('connection:lock');\n\n\tif (event)\n\t\tevent.preventDefault();\n\n\t// Deal with hashes and query strings\n\tconst split = url.split('#');\n\tlet address = split[0] + (/\\?/.test(split[0]) ? '&' : '?') + 'minimal=true';\n\tif (split.length !== 1)\n\t\taddress += '#' + split[1];\n\n\t/*\n\t * Fetch new DOM from the server\n\t * Decided to go withthout dedicated caching and use etags for browser\n\t * cache verification.\n\t */\n\t$loading.show();\n\tconst xhr = new XMLHttpRequest();\n\txhr.open('GET', address);\n\txhr.onload = function () {\n\t\t// In case the thread is dead, moderatator cookie expired or some\n\t\t// other shenanigans\n\t\tif (this.status !== 200) {\n\t\t\t$loading.hide()\n\t\t\treturn alert(this.status)\n\t\t}\n\n\t\t// Was redirected to different thread/board\n\t\tif (baseURL(url) !== baseURL(this.responseURL))\n\t\t\tnextState = state.read(this.responseURL);\n\t\tmain.request('postSM:feed', 'done');\n\t\tmain.trigger('state:clear');\n\n\t\t// Apply new DOM and load models\n\t\tmain.$threads[0].innerHTML = this.response;\n\n\t\t// Set new page state\n\t\tstate.page.set(nextState);\n\n\t\t// Reconfigure rendering singleton\n\t\tmain.oneeSama.op = nextState.thread;\n\t\tnew Extract(nextState.catalog);\n\n\t\t// Swap the database controller server-side. Catalog does not use a\n\t\t// Yakusoku(), so not needed.\n\t\tif (!nextState.catalog) {\n\t\t\tmain.request('connection:unlock', [common.RESYNC, nextState.board,\n\t\t\t\tstate.syncs, nextState.live]);\n\t\t}\n\n\t\tif (event) {\n\t\t\thistory.pushState(null, null, nextState.href);\n\n\t\t\t// Scroll to top on new pages with no hashes\n\t\t\tif (location.hash)\n\t\t\t\tmain.request('scroll:aboveBanner');\n\t\t\telse\n\t\t\t\twindow.scrollTo(0, 0);\n\t\t}\n\t\t$loading.hide();\n\t};\n\txhr.send();\n}\n\nfunction baseURL(url) {\n\treturn url.split(/[\\?#]/)[0];\n}\n\n// For back and forward history events\nwindow.onpopstate = function(event) {\n\treadingSteiner(event.target.location.href);\n\tmain.request('scroll:aboveBanner');\n};\n","/*\n It is not very efficient to spam liteners to the options object. This\n module loops through the post models and calls the appropriate methods in\n batch.\n */\n\nconst main = require('./main'),\n\t{util, follow, options, oneeSama} = main,\n\t{posts} = main.state;\n\noptions.on({\n\t'change:thumbs': reRenderImages,\n\t'change:spoilers': toggleSpoilers,\n\t'change:autogif': toggleAutoGIF,\n\t'change:anonymise': toggleAnonymisation,\n\t'workModeTOG': reRenderImages\n});\nfunction reRenderImages() {\n\tif(main.state.page.get('catalog')){\n\t\t//quick render, because we don't have models in the catalog\n\t\tconst show = (options.get(\"thumbs\")!=='hide' && !main.oneeSama.workMode)? '':'none';\n\t\tdocument.queryAll(\".expanded\").forEach(el => el.style.display=show);\n\t}else\n\t\tfollow(() => getImages((image, model) =>\n\t\t\timage && model.dispatch('renderImage', image)));\n}\n\nfunction getImages(func) {\n\tposts.each(model => func(model.get('image'), model));\n}\n\nfunction toggleSpoilers() {\n\tfollow(() => getImages((image, model) =>\n\t\timage && image.spoiler && model.dispatch('renderImage', image)));\n}\n\n// Toggle animated GIF thumbnails\nfunction toggleAutoGIF() {\n\tfollow(() => getImages((image, model) =>\n\t\timage && image.ext === '.gif' && model.dispatch('renderImage', image)));\n}\n\nfunction toggleAnonymisation(source, toggle) {\n\tfollow(() => {\n\t\tconst command = toggle ? 'anonymise' : 'renderName';\n\t\tposts.each(function(model) {\n\t\t\tconst {name, trip} = model.attributes;\n\t\t\tif (name || trip)\n\t\t\t\tmodel.dispatch(command);\n\t\t});\n\t});\n}\nmain.reply('loop:anonymise', () =>\n\toptions.get('anonymise') && toggleAnonymisation(null, true));\n","/*\n * Self-expiring localStorage key controller\n */\n\nlet main = require('./main'),\n\t{_, Cookie} = main;\n\nclass Memory {\n\tconstructor(key, expiry, needCookie) {\n\t\tthis.key = key;\n\t\tthis.expiry = expiry;\n\t\tthis.needCookie = needCookie;\n\t\tmain.defer(this.purgeExpired.bind(this));\n\t}\n\tbakeCookie(object) {\n\t\tif (!this.needCookie)\n\t\t\treturn;\n\t\tlet nums = Object.keys(object);\n\t\tnums.sort(function(a, b) {\n\t\t\treturn parseInt(a, 10) - parseInt(b, 10);\n\t\t});\n\t\tCookie.set(this.key, nums.join('/'));\n\t}\n\tnow() {\n\t\treturn Math.floor(Date.now() / 1000);\n\t}\n\tpurgeAll() {\n\t\tlocalStorage.removeItem(this.key);\n\t\tif (this.needCookie)\n\t\t\tCookie.remove(this.key);\n\t}\n\treadAll() {\n\t\tconst key = localStorage.getItem(this.key);\n\t\tif (!key)\n\t\t\treturn {};\n\t\tlet val;\n\t\ttry {\n\t\t\tval = JSON.parse(key);\n\t\t}\n\t\tcatch(e) {}\n\t\treturn _.isObject(val) ? val : {};\n\t}\n\twriteAll(object) {\n\t\tif (_.isEmpty(object))\n\t\t\treturn this.purgeAll();\n\t\tlocalStorage.setItem(this.key, JSON.stringify(object));\n\t\tthis.bakeCookie(object)\n\t}\n\twrite(key) {\n\t\tlet object = this.readAll();\n\t\tobject[key] = this.now();\n\t\tthis.writeAll(object);\n\t\t// Return number of keys\n\t\treturn _.size(object);\n\t}\n\tsize() {\n\t\treturn _.size(this.readAll());\n\t}\n\tpurgeExpired() {\n\t\tif (!this.expiry)\n\t\t\treturn;\n\t\tlet object = this.readAll();\n\t\tconst now = this.now(),\n\t\t\tlimit = 86400 * this.expiry;\n\t\tlet expired = [];\n\t\tfor (let key in object) {\n\t\t\tconst time = object[key];\n\t\t\tif (time && now > time + limit)\n\t\t\t\texpired.push(key);\n\t\t}\n\t\tif (!expired.length)\n\t\t\treturn;\n\t\tfor (let i = 0, lim = expired.length; i < lim; i++) {\n\t\t\tdelete object[expired[i]];\n\t\t}\n\t\tthis.writeAll(object);\n\t}\n}\nmodule.exports = Memory;\n","/*\n * Houses both the actual options controler and the options panel renderring\n * logic\n */\n\nimport {_, Backbone, state} from 'main'\nimport opts from './opts'\n\n// Try to get options from local storage\nvar options;\ntry {\n\toptions = JSON.parse(localStorage.options);\n}\ncatch(e) {}\nif (!options)\n\toptions = {};\noptions = module.exports = new Backbone.Model(options);\n\nvar OptionsCollection = Backbone.Collection.extend({\n\tpersist() {\n\t\tvar opts = {};\n\t\tthis.forEach(function(model) {\n\t\t\tconst val = model.getValue();\n\t\t\tif (val === model.get('default'))\n\t\t\t\treturn;\n\t\t\topts[model.get('id')] = val;\n\t\t});\n\t\tlocalStorage.options = JSON.stringify(opts);\n\t}\n});\n\nvar optionsCollection = new OptionsCollection();\n\n// Controller template for each individual option\nvar OptionModel = Backbone.Model.extend({\n\tinitialize(opts) {\n\t\t// Condition for loading option. Optional.\n\t\tif (opts.load !== undefined && !opts.load)\n\t\t\treturn;\n\n\t\t// No type = checkbox + default false\n\t\tif (!opts.type)\n\t\t\tthis.set('type', 'checkbox');\n\n\t\tconst val = this.getValue();\n\t\tthis.setValue(val);\n\t\tif (opts.exec !== undefined) {\n\t\t\tthis.listenTo(options, 'change:' + opts.id, this.execListen);\n\t\t\t// Execute with current value\n\t\t\tif (opts.execOnStart !== false)\n\t\t\t\topts.exec(val);\n\t\t}\n\t\toptionsCollection.add(this);\n\t},\n\t// Set the option, taking into acount board specifics\n\tsetValue(val) {\n\t\toptions.set(this.get('id'), val);\n\t},\n\t// Return default, if unset\n\tgetValue() {\n\t\tconst val = options.get(this.get('id'));\n\t\treturn val === undefined ? this.get('default') : val;\n\t},\n\tvalidate(val) {\n\t\tconst valid = this.get('validation');\n\t\treturn valid ? valid(val) : true;\n\t},\n\t// Exec wrapper for listening events\n\texecListen(model, val) {\n\t\tthis.get('exec')(val);\n\t}\n});\n\n// Highlight options button, if no options are set\n(function() {\n\tif (localStorage.getItem('options'))\n\t\treturn;\n\tvar $el = $('#options');\n\t$el.addClass('noOptions');\n\n\tfunction fadeout() {\n\t\t$el.filter('.noOptions').fadeOut(fadein);\n\t}\n\n\tfunction fadein() {\n\t\t$el.fadeIn();\n\t\t// Stop animation, if options pannel is opened\n\t\tif ($el.filter('.noOptions').length)\n\t\t\tfadeout();\n\t}\n\n\tfadeout();\n\n\t$el.click(function() {\n\t\t$el.removeClass('noOptions');\n\t});\n})();\n\n// View of the options panel\nvar OptionsView = Backbone.View.extend({\n\tinitialize() {\n\t\t// Set the options in the panel to their appropriate values\n\t\toptionsCollection.each(model => {\n\t\t\tlet $el = this.$el.find('#' + model.get('id'));\n\t\t\t/*\n\t\t\t * No corresponding element in panel. Can be caused by config\n\t\t\t * mismatches.\n\t\t\t */\n\t\t\tif (!$el.length)\n\t\t\t\treturn;\n\t\t\tconst type = model.get('type'),\n\t\t\t\tval = model.getValue();\n\t\t\tif (type == 'checkbox')\n\t\t\t\t$el.prop('checked', val);\n\t\t\telse if (type == 'number' || type instanceof Array)\n\t\t\t\t$el.val(val);\n\t\t\telse if (type == 'shortcut')\n\t\t\t\t$el.val(String.fromCharCode(val).toUpperCase());\n\t\t\t// 'image' type simply falls through, as those don't need to be set\n\t\t});\n\t\tthis.$hidden = this.$el.find('#hidden');\n\t\tmain.reply('hide:render', this.renderHidden, this);\n\t},\n\tevents: {\n\t\t'click .option_tab_sel>li>a': 'switchTab',\n\t\t'change': 'applyChange',\n\t\t'click #export': 'export',\n\t\t'click #import': 'import',\n\t\t'click #hidden': 'clearHidden'\n\t},\n\tswitchTab(event) {\n\t\tevent.preventDefault();\n\t\tvar $a = $(event.target);\n\t\t// Unhighight all tabs\n\t\tthis.$el.children('.option_tab_sel').find('a').removeClass('tab_sel');\n\t\t// Hightlight the new one\n\t\t$a.addClass('tab_sel');\n\t\t// Switch tabs\n\t\tvar $li = this.$el.children('.option_tab_cont').children('li');\n\t\t$li.removeClass('tab_sel');\n\t\t$li.filter('.' + $a.data('content')).addClass('tab_sel');\n\t},\n\t// Propagate options panel changes to the models and localStorage\n\tapplyChange(event) {\n\t\tvar $target = $(event.target),\n\t\t\tmodel = optionsCollection.get($target.attr('id')),\n\t\t\tval;\n\t\tif (!model)\n\t\t\treturn;\n\t\tconst type = model.get('type');\n\t\tif (type == 'checkbox')\n\t\t\tval = $target.prop('checked');\n\t\telse if (type == 'number')\n\t\t\tval = parseInt($target.val());\n\t\t// Not recorded; extracted directly by the background handler\n\t\telse if (type == 'image')\n\t\t\treturn main.request('background:store', event.target);\n\t\telse if (type == 'shortcut')\n\t\t\tval = $target.val().toUpperCase().charCodeAt(0);\n\t\telse\n\t\t\tval = $target.val();\n\n\t\tif (!model.validate(val))\n\t\t\treturn $target.val('');\n\t\tmodel.setValue(val);\n\t\toptionsCollection.persist();\n\t},\n\t// Dump options to file\n\texport() {\n\t\tvar a = document.getElementById('export')\n\t\ta.setAttribute('href', window.URL\n\t\t\t.createObjectURL(new Blob([JSON.stringify(localStorage)], {\n\t\t\t\ttype: 'octet/stream'\n\t\t\t}))\n\t\t);\n\t\ta.setAttribute('download', 'meguca-config.json');\n\t},\n\t// Import options from file\n\timport(event) {\n\t\t// Proxy to hidden file input\n\t\tevent.preventDefault();\n\t\tvar $input = this.$el.find('#importSettings');\n\t\t$input.click();\n\t\t$input.one('change', function() {\n\t\t\tvar reader = new FileReader();\n\t\t\treader.readAsText($input[0].files[0]);\n\t\t\treader.onload = function(e) {\n\t\t\t\tvar json;\n\t\t\t\t// In case of curruption\n\t\t\t\ttry {\n\t\t\t\t\tjson = JSON.parse(e.target.result);\n\t\t\t\t}\n\t\t\t\tcatch(e) {\n\t\t\t\t\talert('Import failed. File corrupt');\n\t\t\t\t}\n\t\t\t\tif (!json)\n\t\t\t\t\treturn;\n\t\t\t\tlocalStorage.clear();\n\t\t\t\tfor (let key in json) {\n\t\t\t\t\tlocalStorage[key] = json[key];\n\t\t\t\t}\n\t\t\t\talert('Import successfull. The page will now reload.');\n\t\t\t\tlocation.reload(true);\n\t\t\t};\n\t\t});\n\t},\n\t// Hiden posts counter and reset link\n\trenderHidden(count) {\n\t\tlet $el = this.$hidden;\n\t\t$el.text($el.text().replace(/\\d+$/, count));\n\t},\n\tclearHidden() {\n\t\tmain.request('hide:clear');\n\t\tthis.renderHidden(0);\n\t}\n});\n\n// Create and option model for each object in the array\nfor (let spec of opts) {\n\tnew OptionModel(spec);\n}\n\nmain.defer(function() {\n\tnew OptionsView({\n\t\tel: document.getElementById('options-panel')\n\t});\n});\n","/*\n * This file is used by both the client to populate the Backbone models and the\n * server to render the actual options panel.\n */\n\nimport {Cookie, util, state, config} from 'main'\n\n/*\n * Full schema of the option interface\n *\n * - id: Identifier of the option. Used for DOM element and localStorage tagging\n * - type: 'checkbox'/'number'/'image'/'shortCut'/array of options\n *\tarrays become a selection list. Defaults to 'checkbox', if omitted.\n * - default: Default value. false, if omitted.\n * - tab: Index of the tab the option belong to.\n * - exec: Function to execute on option change.\n * - execOnStart: Boolean. Should the function be executed on model population?\n *\tDefaults to true.\n * - load: Condition to display and execute the option. Defaults to true(always)\n * - validation: Function that validates the users input. Returns a boolean.\n * - hidden: If true this option won't be shown to the user. Defaults to false\n *\n * Tooltips and lables are defined per language in `lang/`.\n * All arguments except for `id` and `tab` are optional.\n */\n\n// Generate either a desktop or mobile set of options\nmodule.exports = function(isMobile) {\n\tconst notMobile = !isMobile;\n\tlet opts = [\n\t\t/* LANGUAGE SELECTION */\n\t\t{\n\t\t\tid: 'lang',\n\t\t\ttype: config.LANGS,\n\t\t\ttab: 0,\n\t\t\tdefault: config.DEFAULT_LANG,\n\t\t\t// True by default\n\t\t\texecOnStart: false,\n\t\t\t// Exec is not used on the server\n\t\t\texec(type) {\n\t\t\t\tCookie.set('lang', type);\n\t\t\t\talert(main.lang.langApplied);\n\t\t\t\tlocation.reload(true);\n\t\t\t}\n\t\t},\n\t\t/* INLINE EXPANSION */\n\t\t{\n\t\t\tid: 'inlinefit',\n\t\t\ttype: ['none', 'full', 'width', 'height', 'both'],\n\t\t\ttab: 1,\n\t\t\tdefault: 'width'\n\t\t},\n\t\t/* THUMBNAIL OPTIONS */\n\t\t{\n\t\t\tid: 'thumbs',\n\t\t\t// Hardcoded to avoid circular dependancy on the server\n\t\t\ttype: ['small', 'sharp', 'hide'],\n\t\t\ttab: 1,\n\t\t\tdefault: 'small',\n\t\t\texec(type) {\n\t\t\t\tCookie.set('thumb', type);\n\t\t\t\toneeSama.thumbStyle = type;\n\t\t\t}\n\t\t},\n\t\t/* IMAGE HOVER EXPANSION */\n\t\t{\n\t\t\tid: 'imageHover',\n\t\t\tdefault: true,\n\t\t\tload: notMobile,\n\t\t\ttab: 0\n\t\t},\n\t\t{\n\t\t\tid: 'webmHover',\n\t\t\tload: notMobile,\n\t\t\ttab: 0\n\t\t},\n\t\t/* Autogif TOGGLE */\n\t\t{\n\t\t\tid: 'autogif',\n\t\t\tload: notMobile,\n\t\t\ttab: 1,\n\t\t\texec(autogif) {\n\t\t\t\tCookie.set('agif', autogif);\n\t\t\t\toneeSama.autoGif = autogif;\n\t\t\t}\n\t\t},\n\t\t/* SPOILER TOGGLE */\n\t\t{\n\t\t\tid: 'spoilers',\n\t\t\ttab: 1,\n\t\t\tdefault: true,\n\t\t\texec(spoilertoggle) {\n\t\t\t\tCookie.set('spoil', spoilertoggle);\n\t\t\t\toneeSama.spoilToggle = spoilertoggle;\n\t\t\t}\n\t\t},\n\t\t/* LINKIFY TEXT URLS */\n\t\t{\n\t\t\tid: 'linkify',\n\t\t\ttab: 0,\n\t\t\texec(toggle) {\n\t\t\t\tCookie.set('linkify', toggle);\n\t\t\t\toneeSama.eLinkify = toggle;\n\t\t\t}\n\t\t},\n\t\t/* DESKTOP NOTIFICATIONS */\n\t\t{\n\t\t\tid: 'notification',\n\t\t\tload: notMobile,\n\t\t\ttab: 0,\n\t\t\texec(notifToggle) {\n\t\t\t\tif (notifToggle && (Notification.permission !== \"granted\"))\n\t\t\t\t\tNotification.requestPermission();\n\t\t\t}\n\t\t},\n\t\t/* ANONIMISE ALL POSTER NAMES */\n\t\t{\n\t\t\tid: 'anonymise',\n\t\t\ttab: 0\n\t\t},\n\t\t/* RELATIVE POST TIMESTAMPS */\n\t\t{\n\t\t\tid: 'relativeTime',\n\t\t\ttab: 0,\n\t\t\tdefault: true,\n\t\t\texec(toggle) {\n\t\t\t\toneeSama.rTime = toggle;\n\t\t\t}\n\t\t},\n\t\t/* R/A/DIO NOW PLAYING BANNER */\n\t\t{\n\t\t\tid: 'nowPlaying',\n\t\t\tload: notMobile && config.RADIO,\n\t\t\ttab: 3,\n\t\t\tdefault: true,\n\t\t\texec(toggle) {\n\t\t\t\tif (toggle)\n\t\t\t\t\t// Query the server for current stream info\n\t\t\t\t\tmain.send([index.RADIO]);\n\t\t\t\telse\n\t\t\t\t\tmain.request('banner:radio:clear');\n\t\t\t}\n\t\t}\n\t];\n\n\t/* IMAGE SEARCH LINK TOGGLE */\n\tfor (let engine of ['google', 'iqdb', 'saucenao', 'desustorage', 'exhentai']) {\n\t\topts.push({\n\t\t\tid: engine,\n\t\t\t// Use a custom internatiolisation function\n\t\t\tlang: 'imageSearch',\n\t\t\ttab: 2,\n\t\t\tdefault: engine === 'google',\n\t\t\texec: toggleHeadStyle(engine + 'Toggle',\n\t\t\t\t`.${engine}{display:initial;}`)\n\t\t});\n\t}\n\n\topts.push(\n\t\t/* ILLYA DANCE */\n\t\t{\n\t\t\tid: 'illyaBGToggle',\n\t\t\t/*\n\t\t\t The getters ensure there isn't any funny business with dependancy order\n\t\t\t on the server;\n\t\t\t */\n\t\t\tload: notMobile && hotConfig.ILLYA_DANCE,\n\t\t\ttab: 3\n\t\t},\n\t\t{\n\t\t\tid: 'illyaMuteToggle',\n\t\t\tload: notMobile && hotConfig.ILLYA_DANCE,\n\t\t\ttab: 3\n\t\t},\n\t\t/* HORIZONTAL POSTING */\n\t\t{\n\t\t\tid: 'horizontalPosting',\n\t\t\ttab: 3,\n\t\t\texec: toggleHeadStyle('horizontal',\n\t\t\t\t'article,aside{display:inline-block;}')\n\t\t},\n\t\t/* REPLY AT RIGHT */\n\t\t{\n\t\t\tid: 'replyright',\n\t\t\ttab: 1,\n\t\t\texec: toggleHeadStyle('reply-at-right',\n\t\t\t\t'section>aside{margin: -26px 0 2px auto;}')\n\t\t},\n\t\t/* THEMES */\n\t\t{\n\t\t\tid: 'theme',\n\t\t\t// Arrays will turn into selection boxes\n\t\t\ttype: [\n\t\t\t\t'moe', 'gar', 'mawaru', 'moon', 'ashita', 'console', 'tea',\n\t\t\t\t'higan', 'ocean', 'rave', 'tavern', 'glass'\n\t\t\t],\n\t\t\ttab: 1,\n\t\t\tdefault: hotConfig.DEFAULT_CSS,\n\t\t\texec(theme) {\n\t\t\t\tif (!theme)\n\t\t\t\t\treturn;\n\t\t\t\tdocument.getElementById('theme').setAttribute('href',\n\t\t\t\t\t`${config.MEDIA_URL}css/${theme}.css?v=${main.cssHash}`);\n\t\t\t}\n\t\t},\n\t\t/* CUSTOM USER-SET BACKGROUND */\n\t\t{\n\t\t\tid: 'userBG',\n\t\t\tload: notMobile,\n\t\t\ttab: 1\n\t\t},\n\t\t{\n\t\t\tid: 'userBGimage',\n\t\t\tload: notMobile,\n\t\t\ttype: 'image',\n\t\t\ttab: 1,\n\t\t\texecOnStart: false,\n\t\t\texec(upload) {\n\t\t\t\tmain.request('background:store', upload);\n\t\t\t}\n\t\t},\n\t\t/* LAST N CONFIG */\n\t\t{\n\t\t\tid: 'lastn',\n\t\t\ttype: 'number',\n\t\t\ttab: 0,\n\t\t\tvalidation: util.reasonable_last_n,\n\t\t\tdefault: hotConfig.THREAD_LAST_N,\n\t\t\texec(n) {\n\t\t\t\toneeSama.lastN = n;\n\t\t\t\tCookie.set('lastn', n);\n\t\t\t}\n\t\t},\n\t\t/* KEEP THREAD LENGTH WITHIN LASTN */\n\t\t/*\n\t\t Disabled, until dependancy features are implemnted (see issue #280)\n\t\t{\n\t\t\tid: 'postUnloading',\n\t\t\ttab: 0\n\t\t},*/\n\t\t/* LOCK TO BOTTOM EVEN WHEN DOCUMENT HIDDEN*/\n\t\t{\n\t\t\tid: 'alwaysLock',\n\t\t\ttab: 0\n\t\t}\n\t);\n\n\t/* SHORTCUT KEYS */\n\tconst shorts = [\n\t\t{id: 'new', default: 78},\n\t\t{id: 'togglespoiler', default: 73},\n\t\t{id: 'textSpoiler', default: 68},\n\t\t{id: 'done', default: 83},\n\t\t{id: 'expandAll', default: 69},\n\t\t{id: 'workMode', default: 66}\n\t];\n\tfor (let short of shorts) {\n\t\tshort.type = 'shortcut';\n\t\tshort.tab = 4;\n\t\tshort.load = notMobile;\n\t\topts.push(short);\n\t}\n\n\treturn opts;\n};\n\n// Create a function to append and toggle a style element in <head>\nfunction toggleHeadStyle(id, css) {\n\treturn function (toggle) {\n\t\tif (!document.getElementById(id)) {\n\t\t\tdocument.head.appendChild(util\n\t\t\t\t.parseDOM(`<style id=\"${id}\">${css}</style>`));\n\t\t}\n\n\t\t// The disabled property only exists on elements in the DOM, so we do\n\t\t// another query\n\t\tdocument.getElementById(id).disabled = !toggle;\n\t}\n}\n","/*\n * Reply posts\n */\n\nconst main = require('../main'),\n\tPostCommon = require('./common'),\n\t{_, Backbone} = main;\n\nmodule.exports = PostCommon.extend({\n\ttagName: 'article',\n\trender() {\n\t\tthis.setElement(main.oneeSama.article(this.model.attributes));\n\t\treturn this;\n\t},\n\tinsertIntoDOM() {\n\t\t_.last(document.query('#p' + this.model.get('op')).queryAll('article'))\n\t\t\t.after(this.el);\n\t\tthis.autoExpandImage().fun();\n\t}\n});\n","/*\n * Common methods to both OP and regular posts\n */\n\nconst main = require('../main'),\n\timager = require('./imager'),\n\t{_, Backbone, common, util, lang, oneeSama, options, state} = main;\n\nmodule.exports = imager.Hidamari.extend({\n\tclassName: 'glass',\n\t// One-way communication channel to the model\n\tinitialize() {\n\t\tthis.listenTo(this.model, 'dispatch', this.redirect);\n\t},\n\t// Extra initialisation logic for posts renderred client-side\n\tclientInit() {\n\t\tif (options.get('anonymise'))\n\t\t\tthis.anonymise();\n\t\treturn this;\n\t},\n\t// Proxy to the appropriate method\n\tredirect(command, ...args) {\n\t\tthis[command](...args);\n\t},\n\t// Update the post's text body\n\tupdateBody(frag) {\n\t\tif (!this.blockquote)\n\t\t\tthis.blockquote = this.el.query('blockquote');\n\n\t\t// This will rerender the HTML content on each update. Might be\n\t\t// some overhead involved, but simplifies live updates greatly.\n\t\tconst model = this.model.attributes;\n\t\tthis.blockquote.innerHTML = oneeSama.setModel(model).body(model.body);\n\t},\n\trenderTime() {\n\t\tthis.el.query('time').outerHTML = oneeSama.time(this.model.get('time'));\n\t},\n\trenderBacklinks(links) {\n\t\tthis.el.query('small').innerHTML = oneeSama.backlinks(links);\n\t},\n\t// Admin JS injections\n\tfun() {\n\t\t// Fun goes here\n\t},\n\t// Self-delusion tripfag filter\n\tanonymise() {\n\t\tthis.el.query('.name').innerHTML = `<b class=\"name\">${lang.anon}<b>`;\n\t},\n\t// Restore regular name\n\trenderName() {\n\t\tthis.el.query('.name').outerHTML = oneeSama.name(this.model.attributes);\n\t},\n\trenderModerationInfo(info) {\n\t\tconst el = this.getContainer();\n\t\tel.query('.modLog').remove();\n\t\tel.query('blockquote').before(util.parseDOM(oneeSama.modInfo(info)));\n\t},\n\tgetContainer() {\n\t\treturn this.el.query('.container');\n\t},\n\trenderBan() {\n\t\tconst el = this.getContainer();\n\t\tel.query('.banMessage').remove();\n\t\tel.query('blockquote').after(util.parseDOM(oneeSama.banned()));\n\t},\n\trenderEditing(editing) {\n\t\tconst {el} = this;\n\t\tif (editing)\n\t\t\tel.classList.add('editing');\n\t\telse {\n\t\t\tel.classList.remove('editing');\n\t\t\tel.query('blockquote').normalize();\n\t\t}\n\t}\n});\n","/*\nYoutube, soundcloud and pastebin link embeding\n */\n\n// TODO: DRY this shit\n\nlet main = require('../main'),\n\t{$, util} = main;\n\n// >80 char rule\nconst youtube_url_re = exports.youtube_url_re = /(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?youtube\\.com\\/watch\\/?\\?((?:[^\\s#&=]+=[^\\s#&]*&)*)?v=([\\w-]{11})((?:&[^\\s#&=]+=[^\\s#&]*)*)&?(#t=[\\dhms]{1,9})?/,\n\tyoutube_short_re = exports.youtube_short_re = /(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?youtu.be\\/([\\w-]{11})\\??(t=[\\dhms]{1,9})?/,\n\tyoutube_time_re = exports.youtube_time_re = /^#t=(?:(\\d\\d?)h)?(?:(\\d{1,3})m)?(?:(\\d{1,3})s)?$/,\n\tyoutube_short_time_re = exports.youtube_short_time_re = /^t=(?:(\\d\\d?)h)?(?:(\\d{1,3})m)?(?:(\\d{1,3})s)?$/;\n\nfunction make_video(id, params, start) {\n\tif (!params)\n\t\tparams = {allowFullScreen: 'true'};\n\tparams.allowScriptAccess = 'always';\n\tvar query = {\n\t\tautohide: 1,\n\t\tfs: 1,\n\t\tmodestbranding: 1,\n\t\torigin: document.location.origin,\n\t\trel: 0,\n\t\tshowinfo: 0\n\t};\n\tif (start)\n\t\tquery.start = start;\n\tif (params.autoplay)\n\t\tquery.autoplay = params.autoplay;\n\tif (params.loop) {\n\t\tquery.loop = '1';\n\t\tquery.playlist = id;\n\t}\n\n\treturn $('<iframe></iframe>', {\n\t\ttype: 'text/html',\n\t\tsrc: encodeURI('https://www.youtube.com/embed/' + id) + '?'\n\t\t\t+ $.param(query),\n\t\tframeborder: '0',\n\t\tattr: video_dims(),\n\t\tclass: 'youtube-player'\n\t});\n}\n\nfunction video_dims() {\n\tif (window.screen && screen.width <= 320)\n\t\treturn {width: 250, height: 150};\n\telse\n\t\treturn {width: 560, height: 340};\n}\n\nmain.$threads.on('click', '.watch', function(e) {\n\tif (e.which > 1 || e.metaKey || e.ctrlKey || e.altKey || e.shiftKey)\n\t\treturn;\n\tvar $target = $(e.target);\n\n\t// maybe squash that double-play bug? ugh, really\n\tif (!$target.is('a'))\n\t\treturn;\n\n\tvar $video = $target.find('iframe');\n\tif ($video.length) {\n\t\t$video.siblings('br').andSelf().remove();\n\t\t$target.css('width', 'auto');\n\t\treturn false;\n\t}\n\tif ($target.data('noembed'))\n\t\treturn;\n\t//check if longURL, if that fails, check if shortURL\n\tvar m = $target.attr('href').match(youtube_url_re);\n\tif (!m) {\n\t\tm = $target.attr('href').match(youtube_short_re);\n\t\tif (!m)\n\t\t// Shouldn't happen, but degrade to normal click action\n\t\t\treturn;\n\t\ttimeCall(m[1],m[2],youtube_short_time_re);\n\t}\n\ttimeCall(m[2],m[4],youtube_time_re);\n\tfunction timeCall(url, time, timeRex){\n\t\tvar start = 0;\n\t\tif (time){\n\t\t\tvar t = time.match(timeRex);\n\t\t\tif (t) {\n\t\t\t\tif (t[1])\n\t\t\t\t\tstart += parseInt(t[1], 10) * 3600;\n\t\t\t\tif (t[2])\n\t\t\t\t\tstart += parseInt(t[2], 10) * 60;\n\t\t\t\tif (t[3])\n\t\t\t\t\tstart += parseInt(t[3], 10);\n\t\t\t}\n\t\t}\n\t\t$target\n\t\t\t.css('width', video_dims().width)\n\t\t\t.append('<br>', make_video(url, null, start))\n\t}\n\treturn false;\n});\n\nmain.$threads.on('mouseenter', '.watch', function (event) {\n\tvar $target = $(event.target);\n\tif ($target.data('requestedTitle'))\n\t\treturn;\n\t$target.data('requestedTitle', true);\n\t// Edit textNode in place so that we don't mess with the embed\n\tvar node = $target.contents().filter(function () {\n\t\treturn this.nodeType === 3;\n\t})[0];\n\tif (!node)\n\t\treturn;\n\tconst orig = node.textContent;\n\tnode.textContent = orig + '...';\n\tvar m = $target.attr('href').match(youtube_url_re);\n\tif (!m){\n\t\tm = $target.attr('href').match(youtube_short_re);\n\t\tif(!m)\n\t\t\treturn;\n\t\t$.ajax({\n\t\t\turl: '//gdata.youtube.com/feeds/api/videos/' + m[1],\n\t\t\tdata: {v: '2', alt: 'jsonc'},\n\t\t\tdataType: 'json',\n\t\t\tsuccess: gotInfo,\n\t\t\terror() {\n\t\t\t\tnode.textContent = orig + '???';\n\t\t\t}\n\t\t});\n\t}\n\n\t$.ajax({\n\t\turl: '//gdata.youtube.com/feeds/api/videos/' + m[2],\n\t\tdata: {v: '2', alt: 'jsonc'},\n\t\tdataType: 'json',\n\t\tsuccess: gotInfo,\n\t\terror() {\n\t\t\tnode.textContent = orig + '???';\n\t\t}\n\t});\n\t// Creates the Titles upon hover\n\t// NOTE: Condense gotInfos into single function\n\tfunction gotInfo(data) {\n\t\tvar title = data && data.data && data.data.title;\n\t\tif (title) {\n\t\t\tnode.textContent = orig + ': ' + title;\n\t\t\t$target.css({color: 'black'});\n\t\t}\n\t\telse\n\t\t\tnode.textContent = orig + ' (gone?)';\n\n\t\tif (data\n\t\t\t&& data.data\n\t\t\t&& data.data.accessControl\n\t\t\t&& data.data.accessControl.embed === 'denied'\n\t\t) {\n\t\t\tnode.textContent += ' (EMBEDDING DISABLED)';\n\t\t\t$target.data('noembed', true);\n\t\t}\n\t}\n});\n\nfunction make_embed(uri, params, dims) {\n\tvar $obj = $('<object/>', {attr: dims});\n\tfor (var name in params) {\n\t\t$('<param/>', {\n\t\t\tattr: {\n\t\t\t\tname: name,\n\t\t\t\tvalue: params[name]\n\t\t\t}\n\t\t}).appendTo($obj);\n\t}\n\t$('<embed/>', {\n\t\tsrc: uri,\n\t\ttype: 'application/x-shockwave-flash'\n\t})\n\t\t.attr(dims)\n\t\t.attr(params)\n\t\t.appendTo($obj);\n\treturn $obj;\n}\n\n/* SOUNDCLOUD */\n\nconst soundcloud_url_re = exports.soundcloud_url_re = /(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.)?soundcloud\\.com\\/([\\w-]{1,40}\\/[\\w-]{1,80})\\/?/;\n\nfunction fetchSoundcloud(target, width, cb) {\n\tconst url = 'https://soundcloud.com/oembed?url='\n\t\t+ encodeURIComponent(target.getAttribute('href'))\n\t\t+ `&maxwidth=${width}&maxheight=166&auto_play=true&format=json`\n\t\t+ '&show_comments=false';\n\tconst xhr = new XMLHttpRequest();\n\txhr.open('GET', url);\n\txhr.responseType = 'json';\n\txhr.onload = function () {\n\t\tif (this.status !== 200)\n\t\t\treturn cb(this.status);\n\t\tcb(null, this.response);\n\t};\n\txhr.send();\n}\n\nmain.$threads.on('click', '.soundcloud', function (e) {\n\tif (e.which > 1 || e.ctrlKey || e.altKey || e.shiftKey || e.metaKey)\n\t\treturn;\n\tconst {target} = e,\n\t\tiframe = target.query('iframe');\n\te.preventDefault();\n\tif (iframe) {\n\t\tiframe.previousElementSibling.remove();\n\t\tiframe.remove();\n\t\treturn;\n\t}\n\n\tconst width = Math.round(window.innerWidth * 0.75);\n\tfetchSoundcloud(target, width, (err, json) => {\n\t\tif (err)\n\t\t\treturn alert(err);\n\t\ttarget.append(document.createElement('br'));\n\t\ttarget.append(util.parseDOM(json.html));\n\t\ttarget.style.width = width + 'px';\n\t});\n});\n\nmain.$threads.on('mouseenter', '.soundcloud:not(.fetched)', function (event) {\n\tconst {target} = event,\n\t\tnode = target.firstChild,\n\t\ttext = node.textContent;\n\tnode.textContent = text + ' ...';\n\n\t// We should not be doing 2 separate fetches on mouseover and click, but\n\t// what if the user manages to click without mouseenter somehow?\n\tfetchSoundcloud(target, 1000, (err, json) => {\n\t\tif (err)\n\t\t\treturn node.textContent = `${text}: Error: ${err}`;\n\t\tnode.textContent = `${text}: ${json.title}`;\n\t\ttarget.style.color = 'black';\n\t\ttarget.classList.add('fetched');\n\t});\n});\n\n// PASTEBIN\nconst pastebin_re = exports.pastebin_re = /(?:>>>*?)?(?:https?:\\/\\/)?(?:www\\.|m.)?pastebin\\.com\\/(.*)/;\n//Pastebin's API seems built for MAKING pastebins but not sharing them\n\n$(document).on('click', '.pastebin', function(event){\n\tif (event.which > 1 || event.ctrlKey || event.altKey || event.shiftKey || event.metaKey)\n\t\treturn;\n\tvar $target = $(event.target);\n\n\tvar $obj = $target.find('iframe');\n\tif ($obj.length) {\n\t\t$obj.siblings('br').andSelf().remove();\n\t\t$target.css({\n\t\t\twidth: 'auto',\n\t\t\theight: 'auto'\n\t\t});\n\t\treturn false;\n\t}\n\n\tvar m = $target.attr('href').match(pastebin_re);\n\tif (!m)\n\t\treturn;\n\tvar $window = $(window),\n\t\twidth = Math.round($window.innerWidth() * 0.65),\n\t\theight = Math.round($window.innerHeight() * 0.65);\n\t$target\n\t\t.css({\n\t\t\twidth: width,\n\t\t\theight: height\n\t\t})\n\t\t.append('<br>', $('<iframe></iframe>', {\n\t\t\ttype: 'text/html',\n\t\t\tsrc: 'https://pastebin.com/embed_iframe.php?i='+ m[1],\n\t\t\tframeborder: '0',\n\t\t\twidth: width,\n\t\t\theight: height\n\t\t}))\n\treturn false;\n});\n","/*\n Name, email, tripcode and staff title persistence and postform propagation\n */\n\nlet main = require('../main'),\n\t{$, $script, $email, $name, _, common, config} = main;\n\nfunction load() {\n\ttry {\n\t\tconst id = JSON.parse(localStorage.ident);\n\t\tif (id.name)\n\t\t\t$name.val(id.name);\n\t\tif (id.email)\n\t\t\t$email.val(id.email);\n\t}\n\tcatch(e) {}\n}\n\nlet save = _.debounce(function() {\n\ttry {\n\t\tconst name = $name.val();\n\t\tlet email = $email.val();\n\t\t// Staff login method\n\t\tif (email === config.LOGIN_KEYWORD) {\n\t\t\t$email.val('');\n\t\t\t$script(config.MEDIA_URL + 'js/login.js?v=' + main.clientHash);\n\t\t\temail = false;\n\t\t}\n\n\t\tif (name || email) {\n\t\t\tlet id = {};\n\t\t\tif (name)\n\t\t\t\tid.name = name;\n\t\t\tif (email)\n\t\t\t\tid.email = email;\n\t\t\tlocalStorage.ident = JSON.stringify(id);\n\t\t}\n\t\telse\n\t\t\tlocalStorage.removeItem('ident');\n\t}\n\tcatch(e) {}\n}, 1000);\n\n// Sync persistance and postForm with input changes\nfunction propagate() {\n\tlet postForm = main.request('postForm');\n\tif (postForm)\n\t\tpostForm.renderIdentity();\n\tsave();\n}\n\nmain.defer(function() {\n\tload();\n\t$name.on('input', propagate);\n\t$email.on('input', propagate);\n});\n","/*\n * Thumbnail and image renderring\n */\n\nconst main = require('../main'),\n\t{$threads, _, Backbone, common, util, oneeSama, options, state} = main;\n\nexports.Hidamari = Backbone.View.extend({\n\t/*\n\t Render entire <figure>. Rerenderring completely each time is considerable\n\t overhed, but the alternative is very convoluted logic. I don't really want\n\t to attach a FSM to each view, just for image renderring.\n\t */\n\trenderImage(arg, image, manual) {\n\t\t/*\n\t\t All kinds of listeners call this method, so we need to ensure we\n\t\t always get the appropriate image object.\n\t\t */\n\t\tconst reveal = arg === true,\n\t\t\t{model, el} = this;\n\t\tif (!image || !image.src)\n\t\t\timage = model.get('image');\n\t\tconst figure = el.query('figure');\n\t\tif (figure)\n\t\t\tfigure.remove();\n\n\t\t// Remove image on mod deletion\n\t\tif (!image)\n\t\t\treturn;\n\t\tel.query('blockquote')\n\t\t\t.before(util.parseDOM(oneeSama.image(image, reveal)));\n\n\t\t// Scroll the post back into view, if contracting images taller than\n\t\t// the viewport\n\t\tif (manual && model.get('tallImage')) {\n\t\t\twindow.scrollTop = el.getBoundingClientRect().top\n\t\t\t\t+ document.body.scrollTop\n\t\t\t\t- document.query('#banner').height;\n\t\t}\n\n\t\tmodel.set({\n\t\t\t// Only used in hidden thumbnail mode\n\t\t\tthumbnailRevealed: reveal,\n\t\t\timageExpanded: false,\n\t\t\ttallImage: false\n\t\t});\n\t},\n\tautoExpandImage() {\n\t\tconst img = this.model.get('image');\n\t\tif (!img\n\t\t\t|| !massExpander.get('expand')\n\t\t\t// Don't auto expand webm/PDF/MP3\n\t\t\t|| ['.webm', '.pdf', '.mp3'].indexOf(img.ext) > -1\n\t\t)\n\t\t\treturn this;\n\t\tthis.toggleImageExpansion(true, img);\n\t\treturn this;\n\t},\n\ttoggleImageExpansion(expand, img, manual) {\n\t\tconst fit = options.get('inlinefit');\n\t\tif (!img || fit === 'none')\n\t\t\treturn;\n\t\tif (expand)\n\t\t\tthis.fitImage(img, fit);\n\t\telse\n\t\t\tthis.renderImage(null, img, manual);\n\t},\n\tfitImage(img, fit){\n\t\t// Open PDF in a new tab on click\n\t\tif (img.ext === '.pdf')\n\t\t\treturn window.open(oneeSama.imagePaths().src + img.src, '_blank');\n\n\t\t// Audio controls are always the same height and do not need to be\n\t\t// fitted\n\t\tif (img.ext === '.mp3')\n\t\t\treturn this.renderAudio(img);\n\n\t\tlet newWidth, newHeight,\n\t\t\twidth = newWidth = img.dims[0],\n\t\t\theight = newHeight = img.dims[1];\n\t\tif (fit === 'full')\n\t\t\treturn this.expandImage(img, {width, height});\n\n\t\tconst both = fit === 'both',\n\t\t\twidthFlag = both || fit === 'width',\n\t\t\theightFlag = both || fit === 'height',\n\t\t\taspect = width / height;\n\t\tlet fullWidth, fullHeight;\n\t\tif (widthFlag) {\n\t\t\tconst maxWidth = this.imageMaxWidth();\n\t\t\tif (newWidth > maxWidth) {\n\t\t\t\tnewWidth = maxWidth;\n\t\t\t\tnewHeight = newWidth / aspect;\n\t\t\t\tfullWidth = true;\n\t\t\t}\n\t\t}\n\t\tif (heightFlag) {\n\t\t\tlet maxHeight = window.innerHeight\n\t\t\t\t- document.query('#banner').offsetHeight;\n\t\t\tif (newHeight > maxHeight) {\n\t\t\t\tnewHeight = maxHeight;\n\t\t\t\tnewWidth = newHeight * aspect;\n\t\t\t\tfullHeight = true;\n\t\t\t}\n\t\t}\n\t\tif (newWidth > 50 && newHeight > 50) {\n\t\t\twidth = newWidth;\n\t\t\theight = newHeight;\n\t\t}\n\t\tthis.expandImage(img, width, height, fullHeight && !fullWidth);\n\t},\n\t// Calculate maximum horizontal dimension an image can be expanded to\n\timageMaxWidth() {\n\t\tconst {el, model} = this;\n\t\treturn window.innerWidth\n\t\t\t- parseInt(el.closest('section').getBoundingClientRect().left) * 2\n\t\t\t- util.outerWidth(model.get('op') ? el : el.query('.background'));\n\t},\n\texpandImage(img, width, height, noMargin) {\n\t\tconst isVideo = img.ext === '.webm';\n\t\tconst attrs = {\n\t\t\tsrc: oneeSama.imagePaths().src + img.src,\n\t\t\twidth,\n\t\t\theight\n\t\t};\n\t\tlet cls = 'expanded';\n\t\tif (noMargin)\n\t\t\tcls += ' noMargin';\n\t\tattrs.class = cls;\n\n\t\tif (isVideo)\n\t\t\tattrs.autoplay = attrs.loop = attrs.controls = true\n\n\t\tthis.el.query('figure').lastChild.innerHTML = common.parseHTML\n\t\t\t`<${isVideo ? 'video' : 'img'} ${attrs}>`;\n\t\tthis.model.set({\n\t\t\timageExpanded: true,\n\t\t\ttallImage: height > window.innerHeight\n\t\t});\n\t},\n\trenderAudio(img) {\n\t\tthis.el.query('figure').append(util.parseDOM(common.parseHTML\n\t\t\t`<audio src=\"${oneeSama.imagePaths().src + img.src}\"\n\t\t\t\twidth=\"300\"\n\t\t\t\theight=\"3em\"\n\t\t\t\tautoplay loop controls\n\t\t\t>\n\t\t\t</audio>`));\n\t\tthis.model.set('imageExpanded', true);\n\t}\n});\n\n// Expand all images\nconst ExpanderModel = Backbone.Model.extend({\n\tinitialize() {\n\t\t$threads.on('click', '#expandImages', e => {\n\t\t\te.preventDefault();\n\t\t\tthis.toggle();\n\t\t});\n\t},\n\ttoggle() {\n\t\tconst expand = !this.get('expand');\n\t\tthis.set('expand', expand).massToggle(expand);\n\t\t$threads\n\t\t\t.find('#expandImages')\n\t\t\t.text(main.lang.expander[+expand]);\n\t},\n\t// More efficent than individual listeners\n\tmassToggle(expand) {\n\t\tconst fit = options.get('inlinefit');\n\t\tif (fit === 'none')\n\t\t\treturn;\n\t\tlet models = state.posts.models;\n\t\tfor (let i = 0, l = models.length; i < l; i++) {\n\t\t\tlet model = models[i],\n\t\t\t\timg = model.get('image');\n\t\t\tif (!img)\n\t\t\t\tcontinue;\n\t\t\tif (expand)\n\t\t\t\tmodel.dispatch('fitImage', img, fit);\n\t\t\telse\n\t\t\t\tmodel.dispatch('renderImage', null, img);\n\t\t}\n\t}\n});\n\nconst massExpander = exports.massExpander = new ExpanderModel();\nmain.reply('massExpander:unset', () => massExpander.unset());\n\n// Proxy image clicks to views. More performant than dedicated listeners for\n// each view.\n$threads.on('click', 'img, video', function(e) {\n\tif (options.get('inlinefit') == 'none' || e.which !== 1)\n\t\treturn;\n\tlet model = util.getModel(e.target);\n\tif (!model)\n\t\treturn;\n\te.preventDefault();\n\n\t// Remove image hover preview, if any\n\tmain.request('imager:clicked');\n\tmodel.dispatch('toggleImageExpansion', !model.get('imageExpanded'),\n\t\tmodel.get('image'), true);\n});\n\n// Reveal/hide thumbnail by clicking [Show]/[Hide] in hidden thumbnail mode\n$threads.on('click', '.imageToggle', function(e) {\n\te.preventDefault();\n\tlet model = util.getModel(e.target);\n\tif (!model)\n\t\treturn;\n\tmain.follow(() =>\n\t\tmodel.dispatch('renderImage', !model.get('thumbnailRevealed')));\n});\n","/*\nExports submodules from the posts module\n */\n\nmodule.exports = {\n\timager: require('./imager'),\n\tMenu: require('./menu'),\n\tcommon: require('./common'),\n\tArticle: require('./article'),\n\tSection: require('./section'),\n\tmodels: require('./models'),\n\tnonce: require('./nonce'),\n\tembed: require('./embed'),\n\tposting: require('./posting')\n};\n","/*\n Post action header dropdown menu\n */\n\nconst main = require('../main'),\n\t{$, _, Backbone, common, util, lang, state} = main;\n\nconst MenuView = module.exports = Backbone.View.extend({\n\tclassName: 'popup-menu glass',\n\ttagName: 'ul',\n\t// Post menu items\n\tactions: ['report', 'hide'],\n\tevents: {\n\t\tclick: 'handleClick'\n\t},\n\tinitialize({parent}) {\n\t\tparent._popup_menu = this;\n\t\tthis.parent = parent;\n\t\tthis.render();\n\t},\n\trender() {\n\t\tlet html = '';\n\t\tfor (let action of this.actions) {\n\t\t\thtml += `<li data-type=\"${action}\">${lang[action]}</li>`\n\t\t}\n\t\tconst {el, parent} = this;\n\t\tel.innerHTML = html;\n\t\tparent.append(el);\n\n\t\t// Calculate position. Can't use CSS translate, because it shifts\n\t\t// the background.\n\t\tel.style.left = el.getBoundingClientRect().left\n\t\t\t- (util.outerWidth(el) + el.offsetWidth) * 0.6\n\t\t\t+ 'px';\n\t},\n\t// Forward post model to appropriate handler\n\thandleClick(e) {\n\t\te.stopPropagation();\n\t\tmain.request(e.target.getAttribute('data-type'), this.model);\n\t\tthis.remove();\n\t},\n\tremove() {\n\t\tthis.parent._popup_menu = null;\n\t\tthis.el.remove();\n\t\tthis.stopListening();\n\t}\n});\n\nmain.reply('menu:extend', action =>\n\t_.extend(MenuView.prototype.actions, action));\n\nmain.$threads.on('click', '.control', event => {\n\tconst {target} = event;\n\n\t// Menu already exists on the element. Remove it instead.\n\tif (target._popup_menu)\n\t\treturn target._popup_menu.remove();\n\n\tconst model = util.getModel(target);\n\tif (model)\n\t\tnew MenuView({parent: target, model});\n});\n","/*\nGeneral post backbone models\n */\n\nlet main = require('../main'),\n\t{_, Backbone, state} = main;\n\nexports.Post = Backbone.Model.extend({\n\tidAttribute: 'num',\n\tinitialize() {\n\t\tstate.posts.add(this);\n\t},\n\t// Proxy commands to the view(s). Using a central channel helps us reduce\n\t// listener count overhead.\n\tdispatch(command, ...args) {\n\t\tthis.trigger('dispatch', command, ...args);\n\t},\n\tremove() {\n\t\t// Remove view\n\t\tthis.stopListening().dispatch('remove');\n\t\t// Remove from post collection\n\t\tstate.posts.remove(this);\n\t},\n\tupdate(frag, links, dice) {\n\t\tconst updates = {\n\t\t\tbody: this.get('body') + frag\n\t\t};\n\t\tif (links)\n\t\t\t_.extend(this.get('links'), links);\n\t\tif (dice)\n\t\t\tupdates.dice = (this.get('dice') || []).concat(dice);\n\t\tthis.set(updates);\n\t},\n\t// Calling a method is always less overhead than binding a dedicated\n\t// listener for each post's image\n\tsetImage(image, silent) {\n\t\tthis.set('image', image);\n\t\tif (!silent)\n\t\t\tthis.dispatch('renderImage', image);\n\t},\n\tsetSpoiler(spoiler, info) {\n\t\tlet image = this.get('image');\n\t\timage.spoiler = spoiler;\n\t\tthis.dispatch('renderImage', image);\n\t\tthis.moderationInfo(info);\n\t},\n\tremoveImage(info) {\n\t\t// Staff won't have the image removed, but rerendered with\n\t\t// indication, that it has been deleted and extra information\n\t\tthis.moderationInfo(info) \n\t\t\t|| this.unset('image').dispatch('renderImage');\n\t},\n\tdeletePost(info) {\n\t\tthis.moderationInfo(info) || this.remove();\n\t},\n\tsetBan(display, info) {\n\t\t// Displaying the 'USER WAS BANNED FOR THIS POST' message and\n\t\t// renderring the moderation info are independant actions\n\t\tif (display)\n\t\t\tthis.set('ban', true).dispatch('renderBan');\n\t\tthis.moderationInfo(info);\n\t},\n\taddBacklink(num, op) {\n\t\tlet backlinks = this.get('backlinks') || {};\n\t\tbacklinks[num] = op;\n\t\tthis.set({backlinks})\n\t\t\t.dispatch('renderBacklinks', backlinks);\n\t},\n\t// Add info about the moderation action taken. This is only used on\n\t// authenticated staff clients, but for sanity, lets keep it here in\n\t// common model methods.\n\tmoderationInfo(info) { \n\t\tif (!info)\n\t\t\treturn false;\n\t\tconst mod = this.get('mod') || [];\n\t\tmod.push(info);\n\t\tthis.set('mod', mod)\n\t\t\t.dispatch('renderModerationInfo', mod);\n\t\treturn true;\n\t}\n});\n\nexports.Thread = exports.Post.extend({\n\tdefaults: {\n\t\treplies: [],\n\t\tomit: 0,\n\t\timage_omit: 0\n\t},\n\tinitialize() {\n\t\t// Omitted images can only be calculated, if there are omitted posts\n\t\tif (this.get('omit'))\n\t\t\tthis.getImageOmit();\n\t\tstate.posts.add(this);\n\t},\n\tremove() {\n\t\tthis.stopListening().dispatch('remove');\n\t\tstate.posts.remove(this);\n\n\t\t// Propagate model removal to all replies\n\t\tconst replies = this.get('replies');\n\t\tfor (let i = 0, lim = replies.length; i < lim; i++) {\n\t\t\tlet model = state.posts.get(replies[i]);\n\t\t\tif (model)\n\t\t\t\tmodel.remove();\n\t\t}\n\t},\n\t/*\n\t With the current renderring and storage implementations we can not get the\n\t image omit count during the server-side render.\n\t */\n\tgetImageOmit() {\n\t\tlet image_omit = this.get('imgctr') -1;\n\t\tconst replies = this.get('replies');\n\n\t\tfor (let i = 0, lim = replies.length; i < lim; i++) {\n\t\t\tlet model = state.posts.get(replies[i]);\n\t\t\tif (!model)\n\t\t\t\tcontinue;\n\t\t\tif (model.get('image'))\n\t\t\t\timage_omit--;\n\t\t}\n\t\tthis.set('image_omit', image_omit);\n\t},\n\ttoggleLocked(val, info) {\n\t\tthis.moderationInfo(info);\n\t\tthis.set('locked', val).dispatch('renderLocked', val);\n\t}\n});\n","/*\nCryptographic nonces for websocket transactions\n */\n\nlet main = require('../main'),\n\t{common, state} = main;\n\nlet nonceCache = {};\n\nfunction get() {\n\tvar nonces;\n\tif (window.localStorage) {\n\t\ttry {\n\t\t\tnonces = JSON.parse(localStorage.postNonces);\n\t\t}\n\t\tcatch (e) {}\n\t}\n\telse\n\t\tnonces = nonceCache;\n\treturn nonces || {};\n}\nmain.reply('nonce:get', get);\n\nfunction save_nonces(nonces) {\n\tif (window.localStorage)\n\t\tlocalStorage.postNonces = JSON.stringify(nonces);\n\telse\n\t\tnonceCache = nonces;\n}\n\nfunction today_id() {\n\treturn Math.floor(Date.now() / (1000*60*60*24));\n}\n\nfunction create() {\n\tconst nonces = get(),\n\t\tnonce = common.randomID(32);\n\tnonces[nonce] = {\n\t\ttab: state.page.get('tabID'),\n\t\tday: today_id()\n\t};\n\tsave_nonces(nonces);\n\treturn nonce;\n}\nmain.reply('nonce:create', create);\n\n// Expire old nonces\nsetTimeout(function() {\n\tif (!window.localStorage)\n\t\treturn;\n\t// we need a lock on postNonces really\n\tlet nonces = get();\n\n\t// people messing with their system clock will mess with expiry, doh\n\tlet changed;\n\tconst yesterday = today_id() - 1;\n\tfor (let nonce in nonces) {\n\t\tif (nonces[nonce].day >= yesterday)\n\t\t\tcontinue;\n\t\tdelete nonces[nonce];\n\t\tchanged = true;\n\t}\n\n\tif (changed)\n\t\tsave_nonces(nonces);\n}, Math.floor(Math.random()*5000));\n\nfunction destroy(nonce) {\n\t// delete only after a delay so all tabs notice that it's ours\n\tsetTimeout(function() {\n\t\tlet nonces = get();\n\t\tif (!nonces[nonce])\n\t\t\treturn;\n\t\tdelete nonces[nonce];\n\t\tsave_nonces(nonces);\n\t}, 10000);\n}\nmain.reply('nonce:destroy', destroy);\n","/*\n * Evertything related to writing and commiting posts\n */\n\nconst Article = require('./article'),\n\tmain = require('../main'),\n\tembed = require('./embed'),\n\tident = require('./identity'),\n\timager = require('./imager'),\n\t{$, _, Backbone, Cookie, common, config, connSM, util, lang, oneeSama,\n\t\toptions, postSM, state} = main;\n\nlet postForm, postModel;\n/*\n The variable gets overwritten, so a simple refference will not do. Calling a\n fucntion to retrieve the var each time solves the problem.\n */\nmain.reply('postForm', () => postForm)\n\t.reply('postModel', () => postModel)\n\t.reply('postForm:indentity', () => postForm && postForm.renderIdentity());\n\n// Minimal size of the input buffer\nlet\tinputMinSize = 300;\n// For mobile\nif (window.screen && screen.width <= 320)\n\tinputMinSize = 50;\n\nconst ComposerModel = Backbone.Model.extend({idAttribute: 'num'});\n\n// Synchronyse postform state with websocket connectivity\nconnSM.on('synced', postSM.feeder('sync'));\nconnSM.on('dropped', postSM.feeder('desync'));\nconnSM.on('desynced', postSM.feeder('desync'));\n\n// Allow remotely altering posting FSM state\nmain.reply('postSM:feed', state => postSM.feed(state));\n\npostSM.act('* + desync -> none', () => {\n\t// TODO: Desync logic\n\tif (postForm) {\n\t\tpostForm.el.classList.remove('editing');\n\t\tpostForm.$input.val('');\n\t\tpostForm.finish();\n\t}\n\tmain.$threads.find('aside.posting').hide();\n});\n\npostSM.act('none + sync, draft, alloc + done -> ready', () => {\n\t// TODO: Add unfinished post checking\n\n\tif (postForm) {\n\t\tpostForm.remove();\n\t\tpostForm = postModel = null;\n\t}\n\tfor (let el of main.$threads[0].queryAll('aside.posting')) {\n\t\tel.style.display = '';\n\t}\n});\n\n// Make new postform\npostSM.act('ready + new -> draft', aside => {\n\tlet op,\n\t\tsection = aside.closest('section');\n\tif (section)\n\t\top = util.getNum(section);\n\telse\n\t\tsection = document.createElement('section');\n\n\t// Shift OP's replies on board pages\n\tif (op && !state.page.get('thread'))\n\t\tstate.posts.get(op).dispatch('shiftReplies', true);\n\n\tpostForm = new ComposerView({\n\t\tmodel: postModel = new ComposerModel({op}),\n\t\tdestination: aside,\n\t\tsection\n\t});\n});\n\npostSM.preflight('draft', aside => aside.matches('aside'));\n\npostSM.act('draft + alloc -> alloc', msg => postForm.onAllocation(msg));\n\n// Render image upload status messages\nmain.dispatcher[common.IMAGE_STATUS] = msg =>\n\tpostForm && postForm.dispatch(msg[0]);\n\nmain.$doc.on('click', 'aside.posting a', function () {\n\tpostSM.feed('new', this.parentNode);\n});\n\nmain.$doc.on('keydown', handle_shortcut);\n\nfunction handle_shortcut(event) {\n\tif (!event.altKey)\n\t\treturn;\n\n\tconst opts = options.attributes;\n\tswitch(event.which) {\n\t\tcase opts.new:\n\t\t\tconst aside = document.query('aside.posting');\n\t\t\tif (aside) {\n\t\t\t\tpostSM.feed('new', aside);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.togglespoiler:\n\t\t\tif (postForm) {\n\t\t\t\tpostForm.onToggle(event);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.done:\n\t\t\tif (postForm && !postForm.$submit.attr('disabled')) {\n\t\t\t\tpostForm.finish();\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\t// Insert text spoiler\n\t\tcase opts.textSpoiler:\n\t\t\tif (postForm) {\n\t\t\t\tvar postState = this.imouto.state2.spoiler;\n\t\t\t\t// Was spoiler already started?\n\t\t\t\tvar sp = (postState ? '[/' : ' [') + 'spoiler]';\n\t\t\t\tthis.imouto.state2.spoiler = !postState;\n\t\t\t\tthis.$input.val(this.$input.val() + sp);\n\t\t\t\tprevent();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase opts.expandAll:\n\t\t\timager.massExpander.toggle();\n\t\t\tprevent();\n\t\t\tbreak;\n\t\tcase opts.workMode:\n\t\t\tconst val = main.oneeSama.workMode = !main.oneeSama.workMode;\n\t\t\tCookie.set('workModeTOG', val);\n\t\t\tconst banner = document.querySelector(\"h1 > img\");\n\t\t\tif(banner!=null)\n\t\t\t\tbanner.style.display =  val? 'none':'';\n\t\t\tdocument.getElementById('theme').setAttribute('href',\n\t\t\t\t\t`${config.MEDIA_URL}css/${val? state.hotConfig.get('DEFAULT_CSS'): main.options.get(\"theme\")}.css?v=${main.cssHash}`);\n\t\t\toneeSama.thumbStyle = val? 'hide': main.options.get('thumbs');\n\t\t\tmain.options.trigger(\"workModeTOG\");\n\t\t\twindow.addEventListener('beforeunload', function () {\n\t\t\t\tCookie.set(\"workModeTOG\",false);\n\t\t\t});\n\t\t\tprevent()\n\t\t\tbreak;\n\t}\n\n\tfunction prevent() {\n\t\tevent.stopImmediatePropagation();\n\t\tevent.preventDefault();\n\t}\n}\n\n// TODO: Unify self-updates with OneeSama; this is redundant\nmain.oneeSama.hook('insertOwnPost', ({links}) => {\n\tif (!postForm || !links)\n\t\treturn;\n\tpostForm.$buffer.find('.nope').each(function () {\n\t\tvar $a = $(this);\n\t\tconst text = $a.text(),\n\t\t\tm = text.match(/^>>(\\d+)/);\n\t\tif (!m)\n\t\t\treturn;\n\t\tconst num = m[1],\n\t\t\top = links[num];\n\t\tif (!op)\n\t\t\treturn;\n\t\tlet $ref = $(common.join([postForm.imouto.postRef(num, op, false)]));\n\t\t$a.attr('href', $ref.attr('href')).attr('class', 'history');\n\t\tconst refText = $ref.text();\n\t\tif (refText != text)\n\t\t\t$a.text(refText);\n\t});\n});\n\nconst ArticleComposer = Article.extend({\n\tevents: {\n\t\t'click #cancel': 'cancel',\n\t\t'change #imageInput': 'onImageChosen',\n\t\t'input #trans': 'onInput',\n\t\t'keydown #trans': 'onKeyDown',\n\t\t'click #done': 'finish',\n\t\t'click #toggle': 'onToggle'\n\t},\n\tinitialize(args) {\n\t\t// super() call\n\t\tArticle.prototype.initialize.call(this);\n\t\tthis.listenTo(this.model, {\n\t\t\t'change': this.renderButtons,\n\t\t\t'change:spoiler': this.renderSpoilerPane\n\t\t});\n\t\tthis.render(args).insertIntoDOM(args);\n\t\tthis.model.set({\n\t\t\tspoiler: 0,\n\t\t\tnextSpoiler: -1\n\t\t});\n\n\t\tthis.pending = '';\n\t\tthis.line_count = 1;\n\t\tthis.char_count = 0;\n\n\t\t// Initialize the form's private rendering singleton instance\n\t\tconst imouto = this.imouto = new common.OneeSama({\n\t\t\tcallback: inject,\n\t\t\top: state.page.get('thread'),\n\t\t\tblockqoute: this.blockqoute,\n\t\t\teLinkify: main.oneeSama.eLinkify,\n\t\t\tlang: main.lang,\n\t\t\ttamashii(num) {\n\t\t\t\tlet section = document.query('#p' + num);\n\t\t\t\tsection = section && section.closest('section');\n\t\t\t\tif (section) {\n\t\t\t\t\tconst desc = num in state.mine.readAll() && lang.you;\n\t\t\t\t\treturn this.postRef(num, util.getNum(section), desc);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\treturn `<a class=\"nope\">&gt;&gt;${num}</a>`;\n\t\t\t}\n\t\t});\n\t\timouto.setModel(this.model);\n\t},\n\t// Initial render\n\trender() {\n\t\t// Define attributes separatly for readbility\n\t\tconst attrs = {\n\t\t\tinput: {\n\t\t\t\tname: 'body',\n\t\t\t\tid: 'input',\n\t\t\t\trows: 1,\n\t\t\t\tclass: 'themed exclude',\n\t\t\t\tautocomplete: main.isMobile\n\t\t\t},\n\t\t\tform: {\n\t\t\t\tmethod: 'post',\n\t\t\t\tenctype: 'multipart/form-data',\n\t\t\t\ttarget: 'upload',\n\t\t\t\tid: 'uploadForm'\n\t\t\t},\n\t\t\tcancel: {\n\t\t\t\ttype: 'buttom',\n\t\t\t\tvalue: lang.cancel,\n\t\t\t\tid: 'cancel'\n\t\t\t},\n\t\t\timageInput: {\n\t\t\t\ttype:'file',\n\t\t\t\tid: 'imageInput',\n\t\t\t\tname: 'image',\n\t\t\t\taccept: 'image/*;.webm;.pdf;.mp3'\n\t\t\t},\n\t\t\ttoggle: {\n\t\t\t\ttype: 'button',\n\t\t\t\tid: 'toggle'\n\t\t\t}\n\t\t};\n\n\t\tthis.el.innerHTML = parseHTML\n\t\t\t`<header>\n\t\t\t\t<a class=\"name nope\" target=\"_blank\">\n\t\t\t\t\t<b></b>\n\t\t\t\t</a>\n\t\t\t</header>\n\t\t\t<span class=\"oi control\" data-glyph=\"chevron-bottom\"></span>\n\t\t\t<div class=\"container\">\n\t\t\t\t<blockquote>\n\t\t\t\t\t<p id=\"buffer\" class=\"exclude\"></p>\n\t\t\t\t\t<p id=\"lineBuffer\" class=\"exclude\"></p>\n\t\t\t\t\t<textarea ${attrs.input}></textarea>\n\t\t\t\t</blockquote>\n\t\t\t\t<form ${attrs.form}>\n\t\t\t\t\t<input ${attrs.cancel}>\n\t\t\t\t\t<input ${attrs.imageInput}>\n\t\t\t\t\t<input ${attrs.toggle}>\n\t\t\t\t\t<strong id=\"uploadStatus\"></strong>\n\t\t\t\t</form>\n\t\t\t\t<small></small>\n\t\t\t</div>`;\n\n\t\t// Cache elements to avoid lookup\n\t\tconst els = ['buffer', 'lineBuffer', 'input', 'uploadForm', 'cancel',\n\t\t\t'imageInput', 'toggle', 'uploadStatus', 'hiddenUpload', 'sizer'];\n\t\tfor (let el of els) {\n\t\t\tthis[el] = document.query('#' + el);\n\t\t}\n\t\tthis.renderIdentity();\n\t\treturn this;\n\t},\n\t// Name, emaail and tripcode field\n\trenderIdentity() {\n\t\t// Model has already been alocated and has a proper identity rendered\n\t\tif (this.model.get('num'))\n\t\t\treturn;\n\t\tconst parsed = common.parse_name(main.$name.val(), main.$email.val()),\n\t\t\thaveTrip = !!(parsed[1] || parsed[2]);\n\t\tconst el = this.el.query('.name'),\n\t\t\tname = el.query('a');\n\t\tif (parsed[0])\n\t\t\tname.textContent = parsed[0] + ' ';\n\t\telse\n\t\t\tname.tetxContent = haveTrip ? '' : lang.anon;\n\t\tif (haveTrip)\n\t\t\tutil.parseDOM(' <code>!?</code>').forEach(el => name.after(el));\n\n\t\t// Insert staff title\n\t\tmain.oneeSama.trigger('fillMyName', name);\n\t\tconst email = main.$email.val().trim();\n\t\tif (email) {\n\t\t\tel.setAttribute('href', 'mailto:' + email);\n\t\t\tel.classList.remove('nope');\n\t\t\tel.classList.add('email');\n\t\t}\n\t\telse {\n\t\t\tel.removeAttribute('href');\n\t\t\tel.classList.add('nope');\n\t\t\tel.classList.remove('email');\n\t\t}\n\t},\n\tinsertIntoDOM({destination}) {\n\t\tdestination.before(this.el);\n\t\tthis.resizeInput();\n\t\tmain.$threads.queryAll('aside.postsing').forEach(el =>\n\t\t\tel.style.display = 'none');\n\t\tthis.fun();\n\t},\n\t/*\n\t Allows keeping the input buffer sized as if the text was monospace,\n\t without actually displaying monospace font. Keeps the input buffer from\n\t shifting around needlessly.\n\t */\n\tresizeInput(val) {\n\t\tconst {sizer, input} = this;\n\t\tif (typeof val !== 'string')\n\t\t\tval = input.value;\n\t\tsizer.textContent = val;\n\t\tlet size = sizer.width + common.INPUT_ROOM;\n\t\tsize = Math.max(size, inputMinSize\n\t\t\t- input.getBoundingClientRect().left\n\t\t\t- this.el.getBoundingClientRect().left);\n\t\tthis.input.style.width = size + 'px';\n\t},\n\trenderButtons() {\n\t\tconst {num, uploading, uploaded, uploadStatus, sentAllocRequest}\n\t\t\t= this.model.attributes;\n\t\tconst allocWait = sentAllocRequest && !num;\n\t\tthis.submit.disabled = !!(uploading || allocWait);\n\t\tif (uploaded)\n\t\t\tthis.submit.style.marginLeft = 0;\n\t\tthis.cancel.disabled = !!allocWait;\n\t\tthis.cancel.style.display = (!num || uploading) ? '' : 'none';\n\t\tthis.imageInput.disabled = !!uploading;\n\t\tthis.uploadStatus.innerHTML = uploadStatus;\n\t},\n\trenderSpoilerPane(model, spoiler) {\n\t\tconst background = spoiler\n\t\t\t? `${config.MEDIA_URL}spoil/spoil${spoiler}.png`\n\t\t\t: config.MEDIA_URL + 'css/ui/pane.png';\n\t\tthis.toggle.style.backgroundImage = `url(\"${background}\")`;\n\t}\n});\n\nconst ComposerView = Backbone.View.extend({\n\tevents: {\n\t\t'input #trans': 'onInput',\n\t\t'keydown #trans': 'onKeyDown',\n\t\t'click #done': 'finish',\n\t\t'click #toggle': 'onToggle'\n\t},\n\tinitialize(args) {\n\t\tthis.listenTo(this.model, {\n\t\t\t'change': this.renderButtons,\n\t\t\t'change:spoiler': this.renderSpoilerPane\n\t\t});\n\n\t\tthis.render(args);\n\n\t\tthis.pending = '';\n\t\tthis.line_count = 1;\n\t\tthis.char_count = 0;\n\n\t\t// Initialize the form's private rendering singleton instance\n\t\tlet imouto = this.imouto = new common.OneeSama({\n\t\t\tcallback: inject,\n\t\t\top: state.page.get('thread'),\n\t\t\tstate: [common.S_BOL, 0],\n\n\t\t\t// TODO: Convert current OneeSama.state array to more flexible\n\t\t\t// object\n\t\t\tstate2: {spoiler: 0},\n\t\t\t$buffer: this.$buffer,\n\t\t\teLinkify: main.oneeSama.eLinkify,\n\t\t\tlang: main.lang,\n\t\t\ttamashii(num) {\n\t\t\t\tlet section = document.query('#p' + num);\n\t\t\t\tsection = section && section.closest('section');\n\t\t\t\tif (section) {\n\t\t\t\t\tconst desc = num in state.mine.readAll() && this.lang.you;\n\t\t\t\t\treturn this.postRef(num, util.getNum(section), desc);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\treturn `<a class=\"nope\">&gt;&gt;${num}</a>`;\n\t\t\t}\n\t\t});\n\t\timouto.hook('spoilerTag', util.touchable_spoiler_tag);\n\t\tmain.oneeSama.trigger('imouto', imouto);\n\t},\n\t// Initial render\n\trender({destination, section}) {\n\t\tconst op = this.model.get('op');\n\t\tthis.setElement((op ? document.createElement('article') : section));\n\n\t\t// A defined op means the post is a reply, not a new thread\n\t\tthis.isThread = !op;\n\n\t\tthis.$buffer = $('<p/>');\n\t\tthis.$lineBuffer = $('<p/>');\n\t\tthis.$meta = $('<header><a class=\"nope\"><b/></a> <time/></header>');\n\t\tthis.$input = $('<textarea/>', {\n\t\t\tname: 'body',\n\t\t\tid: 'trans',\n\t\t\trows: '1',\n\t\t\tclass: 'themed',\n\t\t\tautocomplete: main.isMobile\n\t\t});\n\t\tthis.$submit = $('<input/>', {\n\t\t\tid: 'done',\n\t\t\ttype: 'button',\n\t\t\tvalue: main.lang.done\n\t\t});\n\t\tthis.$subject = $('<input/>', {\n\t\t\tid: 'subject',\n\t\t\tclass: 'themed',\n\t\t\tmaxlength: state.hotConfig.SUBJECT_MAX_LENGTH,\n\t\t\twidth: '80%'\n\t\t});\n\t\tthis.$blockquote = $('<blockquote/>');\n\n\t\t/*\n\t\t Allows keeping the input buffer sized as if the text was monospace,\n\t\t without actually displaying monospace font. Keeps the input buffer from\n\t\t shifting around needlessly.\n\t\t */\n\t\tthis.$sizer = $('<pre/>').appendTo('body');\n\n\t\tthis.$blockquote.append(this.$buffer, this.$lineBuffer, this.$input);\n\t\tthis.$el.append(this.$meta, this.$blockquote, '<small/>');\n\t\tif (this.isThread) {\n\t\t\tthis.$el.append(`<label for=\"subject\">${lang.subject}: </label>`,\n\t\t\t\tthis.$subject);\n\t\t\tthis.$blockquote.hide();\n\t\t}\n\t\tthis.$uploadForm = this.renderUploadForm();\n\t\tthis.$el.append(this.$uploadForm);\n\n\t\t// Add a menu to the postform\n\t\tmain.oneeSama.trigger('draft', this.$el);\n\t\tthis.renderIdentity();\n\n\t\t// Insert into the DOM\n\t\tdestination.style.display = 'none';\n\t\tif (this.isThread) {\n\t\t\tdestination.after(this.el);\n\t\t\tthis.el.after(document.createElement('hr'));\n\t\t\tthis.$subject.focus();\n\t\t}\n\t\telse {\n\t\t\tdestination.before(this.el);\n\t\t\tthis.resizeInput();\n\t\t\tthis.$input.focus();\n\t\t}\n\n\t\tmain.$threads.find('aside.posting').hide();\n\t\tthis.fun();\n\t},\n\t// Render the name, email, and admin title, if any\n\trenderIdentity() {\n\t\t// Model has already been alocated and has a proper identity rendered\n\t\tif (this.model.get('num'))\n\t\t\treturn;\n\t\tconst parsed = common.parse_name(main.$name.val(), main.$email.val()),\n\t\t\thaveTrip = !!(parsed[1] || parsed[2]);\n\t\tlet $b = this.$meta.find('b');\n\t\tif (parsed[0])\n\t\t\t$b.text(parsed[0] + ' ');\n\t\telse\n\t\t\t$b.text(haveTrip ? '' : main.lang.anon);\n\t\tif (haveTrip)\n\t\t\t$b.append(' <code>!?</code>');\n\t\t\n\t\t// Insert staff title\n\t\tmain.oneeSama.trigger('fillMyName', $b);\n\t\tconst email = main.$email.val().trim();\n\t\tlet $tag = this.$meta.children('a').first();\n\t\tif (email) {\n\t\t\t$tag.attr({\n\t\t\t\thref: 'mailto:' + email,\n\t\t\t\ttarget: '_blank',\n\t\t\t\tclass: 'email'\n\t\t\t});\n\t\t}\n\t\telse\n\t\t\t$tag.removeAttr('href').removeAttr('target').attr('class', 'nope');\n\t},\n\trenderButtons() {\n\t\tconst attrs = this.model.attributes,\n\t\t\tallocWait = attrs.sentAllocRequest && !attrs.num,\n\t\t\td = attrs.uploading || allocWait;\n\t\t// Beware of undefined!\n\t\tthis.$submit.prop('disabled', !!d);\n\t\tif (attrs.uploaded)\n\t\t\tthis.$submit.css({'margin-left': '0'});\n\t\tthis.$cancel.prop('disabled', !!allocWait);\n\t\tthis.$cancel.toggle(!!(!attrs.num || attrs.uploading));\n\t\tthis.$imageInput.prop('disabled', !!attrs.uploading);\n\t\tthis.$uploadStatus.html(attrs.uploadStatus);\n\t},\n\trenderSpoilerPane(model, sp) {\n\t\tconst background = sp ? `${config.MEDIA_URL}spoil/spoil${sp}.png`\n\t\t\t: config.MEDIA_URL + 'css/ui/pane.png';\n\t\tthis.$toggle.css('background-image', `url(\"${background}\")`);\n\t},\n\trenderUploadForm() {\n\t\tvar $form = $('<form method=\"post\" enctype=\"multipart/form-data\" '\n\t\t\t+ 'target=\"upload\"></form>');\n\t\tthis.$cancel = $('<input/>', {\n\t\t\ttype: 'button',\n\t\t\tvalue: lang.cancel,\n\t\t\tclick: $.proxy(this, 'cancel')\n\t\t});\n\t\tthis.$imageInput = $('<input/>', {\n\t\t\ttype: 'file',\n\t\t\tid: 'image',\n\t\t\tname: 'image',\n\t\t\taccept: config.WEBM ? 'imager/*;.webm' : 'image/*',\n\t\t\tchange: $.proxy(this, 'onImageChosen')\n\t\t});\n\t\tthis.$toggle = $('<input/>', {\n\t\t\ttype: 'button',\n\t\t\tid: 'toggle'\n\t\t});\n\t\tthis.$uploadStatus = $('<strong/>');\n\t\t$form.append(this.$cancel,\n\t\t\tthis.$imageInput,\n\t\t\tthis.$toggle, ' ',\n\t\t\tthis.$uploadStatus);\n\t\tthis.$iframe = $('<iframe/>', {\n\t\t\tsrc: '',\n\t\t\tname: 'upload',\n\t\t\tid: 'hidden-upload'\n\t\t}).appendTo('body');\n\t\tthis.model.set({\n\t\t\tspoiler: 0,\n\t\t\tnextSpoiler: -1\n\t\t});\n\t\treturn $form;\n\t},\n\t// Cancel file upload\n\tcancel() {\n\t\tif (this.model.get('uploading')) {\n\t\t\tthis.$iframe.remove();\n\t\t\tthis.$iframe = $('<iframe></iframe>', {\n\t\t\t\tsrc: '',\n\t\t\t\tname: 'upload',\n\t\t\t\tid: 'hidden-upload'\n\t\t\t}).appendTo('body');\n\t\t\tthis.uploadError('');\n\t\t\tthis.model.set({cancelled: true});\n\t\t}\n\t\telse\n\t\t\tthis.finish();\n\t},\n\tonImageChosen() {\n\t\tif (this.model.get('uploading') || this.model.get('uploaded'))\n\t\t\treturn;\n\t\tif (!this.$imageInput.val()) {\n\t\t\tthis.model.set('uploadStatus', '');\n\t\t\treturn;\n\t\t}\n\t\tconst extra = this.prepareUpload();\n\t\tfor (var k in extra) {\n\t\t\t$('<input type=hidden>')\n\t\t\t\t.attr('name', k)\n\t\t\t\t.val(extra[k])\n\t\t\t\t.appendTo(this.$uploadForm);\n\t\t}\n\t\tthis.$uploadForm.prop('action', util.uploadURL());\n\t\tthis.$uploadForm.submit();\n\t\tthis.$iframe.load(function() {\n\t\t\tif (!postForm)\n\t\t\t\treturn;\n\t\t\tvar doc = this.contentWindow || this.contentDocument;\n\t\t\tif (!doc)\n\t\t\t\treturn;\n\t\t\ttry {\n\t\t\t\tvar error = $(doc.document || doc).text();\n\t\t\t\t/*\n\t\t\t\t if it's a real response, it'll postMessage to us, so we don't have\n\t\t\t\t to do anything.\n\t\t\t\t */\n\t\t\t\tif (/legitimate imager response/.test(error))\n\t\t\t\t\treturn;\n\t\t\t\t// sanity check for weird browser responses\n\t\t\t\tif (error.length < 5 || error.length > 100)\n\t\t\t\t\terror = lang.unknownUpload;\n\t\t\t\tpostForm.uploadError(error);\n\t\t\t}\n\t\t\tcatch(e) {\n\t\t\t\t/*\n\t\t\t\t likely cross-origin restriction\n\t\t\t\t wait before erroring in case the message shows up\n\t\t\t\t */\n\t\t\t\tsetTimeout(function() {\n\t\t\t\t\tpostForm.uploadFallbackMessage();\n\t\t\t\t}, 500);\n\t\t\t}\n\t\t});\n\t\tthis.notifyUploading();\n\t},\n\tprepareUpload() {\n\t\tthis.model.set('uploadStatus', lang.uploading);\n\t\tthis.$input.focus();\n\t\tconst attrs = this.model.attributes;\n\t\treturn {spoiler: attrs.spoiler, op: attrs.op || 0};\n\t},\n\t/*\n\t this is just a fallback message for when we can't tell, if there was an\n\t error due to cross-origin restrictions\n\t */\n\tuploadFallbackMessage() {\n\t\tvar a = this.model.attributes,\n\t\t\tstat = a.uploadStatus;\n\t\tif (!a.cancelled && a.uploading && (!stat || stat == lang.uploading))\n\t\t\tthis.model.set('uploadStatus', lang.unknownResult);\n\t},\n\tnotifyUploading() {\n\t\tthis.model.set({uploading: true, cancelled: false});\n\t\tthis.$input.focus();\n\t},\n\tresizeInput(val) {\n\t\tif (typeof val !== 'string')\n\t\t\tval = this.$input.val();\n\t\tthis.$sizer.text(val);\n\t\tvar size = this.$sizer.width() + common.INPUT_ROOM;\n\t\tsize = Math.max(size, inputMinSize\n\t\t\t- this.$input.offset().left - this.$el.offset().left);\n\t\tthis.$input.css('width', size + 'px');\n\t},\n\tonInput(val) {\n\t\tif (val === undefined || val instanceof $.Event)\n\t\t\tval = this.$input.val();\n\t\tvar start = this.$input[0].selectionStart,\n\t\t\tend = this.$input[0].selectionEnd;\n\n\t\tvar changed = false,\n\t\t\tm, time, video;\n\n\t\t// Turn YouTube links into proper refs\n\t\twhile(true) {\n\t\t\tm = val.match(embed.youtube_url_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\t// Substitute\n\t\t\ttime = this.findTimeArg(m[3])\n\t\t\t\t|| this.findTimeArg(m[1])\n\t\t\t\t|| m[4]\n\t\t\t\t|| '';\n\t\t\tvideo = '>>>/watch?v=' + m[2] + time;\n\t\t\tval = embedRewrite(m, video);\n\t\t}\n\n\t\t//Youtu.be links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.youtube_short_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\t// Substitute\n\t\t\ttime = this.findTimeArg(m[2]) || '';\n\t\t\tvideo = '>>>/watch?v=' + m[1] + time;\n\t\t\tval = embedRewrite(m, video);\n\t\t}\n\n\t\t// SoundCloud links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.soundcloud_url_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\tvar sc = '>>>/soundcloud/' + m[1];\n\t\t\tval = embedRewrite(m, sc);\n\t\t}\n\n\t\t// Pastebin links\n\t\twhile(true) {\n\t\t\tm = val.match(embed.pastebin_re);\n\t\t\tif (!m)\n\t\t\t\tbreak;\n\t\t\tvar pbin = '>>>/pastebin/' + m[1];\n\t\t\tval = embedRewrite(m, pbin);\n\t\t}\n\n\t\t// Rewite embedable URLs to native embed URL syntax\n\t\tfunction embedRewrite(m, rw) {\n\t\t\tvar old = m[0].length;\n\t\t\tvar newVal = val.substr(0, m.index) + rw + val.substr(m.index + old);\n\t\t\tchanged = true;\n\t\t\tif (m.index < start) {\n\t\t\t\tvar diff = old - rw.length;\n\t\t\t\tstart -= diff;\n\t\t\t\tend -= diff;\n\t\t\t}\n\t\t\treturn newVal;\n\t\t}\n\n\t\tif (changed)\n\t\t\tthis.$input.val(val);\n\n\t\tvar nl = val.lastIndexOf('\\n');\n\t\tif (nl >= 0) {\n\t\t\tvar ok = val.substr(0, nl);\n\t\t\tval = val.substr(nl + 1);\n\t\t\tthis.$input.val(val);\n\t\t\tif (this.model.get('sentAllocRequest') || /[^ ]/.test(ok))\n\t\t\t\tthis.commit(ok + '\\n');\n\t\t}\n\t\telse {\n\t\t\tm = val\n\t\t\t\t.split('')\n\t\t\t\t.reverse()\n\t\t\t\t.join('')\n\t\t\t\t.match(/^(\\s*\\S+\\s+\\S+)\\s+(?=\\S)/);\n\t\t\tif (m) {\n\t\t\t\tvar lim = val.length - m[1].length;\n\t\t\t\tthis.commit(val.substr(0, lim));\n\t\t\t\tval = val.substr(lim);\n\t\t\t\tstart -= lim;\n\t\t\t\tend -= lim;\n\t\t\t\tthis.$input.val(val);\n\t\t\t\tthis.$input[0].setSelectionRange(start, end);\n\t\t\t}\n\t\t}\n\n\t\tthis.$input.attr('maxlength', common.MAX_POST_CHARS - this.char_count);\n\t\tthis.resizeInput(val);\n\t},\n\tfindTimeArg(params) {\n\t\tif (!params || params.indexOf('t=') < 0)\n\t\t\treturn false;\n\t\tparams = params.split('&');\n\t\tfor (let i = 0, len = params.length; i < len; i++) {\n\t\t\tlet pair = '#p' + params[i];\n\t\t\tif (embed.youtube_time_re.test(pair))\n\t\t\t\treturn pair;\n\t\t}\n\t\treturn false;\n\t},\n\t// Commit any staged words to the server\n\tcommit(text) {\n\t\tvar lines;\n\t\tif (text.indexOf('\\n') >= 0) {\n\t\t\tlines = text.split('\\n');\n\t\t\tthis.line_count += lines.length - 1;\n\t\t\tconst breach = this.line_count - common.MAX_POST_LINES + 1;\n\t\t\tif (breach > 0) {\n\t\t\t\tfor (var i = 0; i < breach; i++)\n\t\t\t\t\tlines.pop();\n\t\t\t\ttext = lines.join('\\n');\n\t\t\t\tthis.line_count = common.MAX_POST_LINES;\n\t\t\t}\n\t\t}\n\t\tconst left = common.MAX_POST_CHARS - this.char_count;\n\t\tif (left < text.length)\n\t\t\ttext = text.substr(0, left);\n\t\tif (!text)\n\t\t\treturn;\n\t\tthis.char_count += text.length;\n\n\t\t// Either get an allocation or send the committed text\n\t\tconst attrs = this.model.attributes;\n\t\tif (!attrs.num && !attrs.sentAllocRequest) {\n\t\t\tmain.send([common.INSERT_POST, this.allocationMessage(text, null)]);\n\t\t\tthis.model.set({sentAllocRequest: true});\n\t\t}\n\t\telse if (attrs.num)\n\t\t\tmain.send(text);\n\t\telse\n\t\t\tthis.pending += text;\n\n\t\t// Add it to the user's display\n\t\tif (lines) {\n\t\t\tlines[0] = this.$lineBuffer.text() + lines[0];\n\t\t\tthis.$lineBuffer.text(lines.pop());\n\t\t\tfor (let o = 0, len = lines.length; o < len; o++)\n\t\t\t\tthis.imouto.fragment(lines[o] + '\\n');\n\t\t}\n\t\telse {\n\t\t\tthis.$lineBuffer.append(document.createTextNode(text));\n\t\t\tthis.$lineBuffer[0].normalize();\n\t\t}\n\t},\n\t// Construct the message for post allocation in the database\n\tallocationMessage(text, image) {\n\t\tvar msg = {nonce: main.request('nonce:create')};\n\n\t\tfunction opt(key, val) {\n\t\t\tif (val)\n\t\t\t\tmsg[key] = val;\n\t\t}\n\n\t\topt('name', main.$name.val().trim());\n\t\topt('email', main.$email.val().trim());\n\t\topt('subject', this.$subject.val().trim());\n\t\topt('frag', text);\n\t\topt('image', image);\n\t\topt('op', this.model.get('op'));\n\n\t\treturn msg;\n\t},\n\tonKeyDown(event) {\n\t\tmain.follow(() => {\n\t\t\tswitch(event.which) {\n\t\t\t\tcase 13:\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t// fall-through\n\t\t\t\tcase 32:\n\t\t\t\t\t// predict result\n\t\t\t\t\tvar input = this.$input[0];\n\t\t\t\t\tvar val = this.$input.val();\n\t\t\t\t\tval = val.slice(0, input.selectionStart)\n\t\t\t\t\t\t+ (event.which == 13 ? '\\n' : ' ')\n\t\t\t\t\t\t+ val.slice(input.selectionEnd);\n\t\t\t\t\tthis.onInput(val);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\thandle_shortcut.bind(this)(event);\n\t\t\t}\n\t\t});\n\t},\n\tfinish() {\n\t\tif (this.model.get('num')) {\n\t\t\tthis.flushPending();\n\t\t\tthis.commit(this.$input.val());\n\t\t\tthis.$input.remove();\n\t\t\tthis.$submit.remove();\n\t\t\tif (this.$uploadForm)\n\t\t\t\tthis.$uploadForm.remove();\n\t\t\tif (this.$iframe) {\n\t\t\t\tthis.$iframe.remove();\n\t\t\t\tthis.$iframe = null;\n\t\t\t}\n\t\t\tthis.imouto.fragment(this.$lineBuffer.text());\n\t\t\tthis.$buffer.replaceWith(this.$buffer.contents());\n\t\t\tthis.$lineBuffer.remove();\n\t\t\tthis.$blockquote.css({\n\t\t\t\t'margin-left': '', 'padding-left': ''\n\t\t\t}\n\t\t\t);\n\t\t\tmain.send([common.FINISH_POST]);\n\t\t\tthis.preserve = true;\n\t\t\tif (this.isThread)\n\t\t\t\tthis.$el.append(main.oneeSama.replyBox());\n\n\t\t\tlet missing = this.imouto.allRolls.sent - this.imouto.allRolls.seen;\n\t\t\t//if missing>0 we have to wait until insertOwnPosts \"sees\" the\n\t\t\t// dice\n\t\t\tif (missing > 0) {\n\t\t\t\tlet checkAgain;\n\t\t\t\t(checkAgain= (n) => {\n\t\t\t\t\tsetTimeout(()=> {\n\t\t\t\t\t\tif (this.imouto.allRolls.seen == this.imouto.allRolls.sent || n ==0)\n\t\t\t\t\t\t\tpostSM.feed('done');\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tcheckAgain(n - 1);\n\t\t\t\t\t}, 100);\n\t\t\t\t})(5); //retry 5 times\n\t\t\t}\n\t\t\telse\n\t\t\t\tpostSM.feed('done');\n\t\t}else\n\t\t\tpostSM.feed('done');\n\t},\n\t// Send any unstaged words\n\tflushPending() {\n\t\tif (this.pending) {\n\t\t\tmain.send(this.pending);\n\t\t\tthis.pending = '';\n\t\t}\n\t},\n\tonToggle(event) {\n\t\tconst attrs = this.model.attributes;\n\t\tif (attrs.uploading || attrs.uploaded)\n\t\t\treturn;\n\t\tevent.preventDefault();\n\t\tevent.stopImmediatePropagation();\n\t\tif (attrs.spoiler) {\n\t\t\tthis.model.set({spoiler: 0});\n\t\t\treturn;\n\t\t}\n\t\tconst pick = common.pick_spoiler(attrs.nextSpoiler);\n\t\tthis.model.set({\n\t\t\tspoiler: pick.index,\n\t\t\tnextSpoiler: pick.next\n\t\t});\n\t},\n\tonAllocation(msg) {\n\t\tconst num = msg.num;\n\t\tstate.ownPosts[num] = num;\n\t\tthis.model.set({num: num});\n\t\tthis.flushPending();\n\t\tvar header = $(main.oneeSama.header(msg));\n\t\tthis.$meta.replaceWith(header);\n\t\tthis.$meta = header;\n\t\tif (!this.isThread)\n\t\t\tthis.$el.addClass('editing');\n\n\t\t/*\n\t\t TODO: Hide threads that are over THREADS_PER_PAGE. Also would need to be\n\t\t removed from syncs client and server-side. Hmm.\n\t\t */\n\n\t\tthis.$el.attr('id', 'p' + num);\n\n\t\tif (msg.image)\n\t\t\tthis.insertUploaded(msg.image);\n\n\t\tif (this.$uploadForm)\n\t\t\tthis.$uploadForm.append(this.$submit);\n\t\telse\n\t\t\tthis.$blockquote.after(this.$submit);\n\t\tif (this.isThread) {\n\t\t\tthis.$subject.siblings('label').andSelf().remove();\n\t\t\tthis.$blockquote.show();\n\t\t\tthis.resizeInput();\n\t\t\tthis.$input.focus();\n\t\t}\n\n\t\t/*\n\t\t Ensures you are nagged at by the browser, when navigating away from an\n\t\t unfinished allocated post.\n\t\t */\n\t\twindow.onbeforeunload = function() {\n\t\t\treturn \"You have an unfinished post.\";\n\t\t};\n\t},\n\t// Insert an image that has been uploaded and processed by the server\n\tinsertUploaded(info) {\n\t\tthis.renderImage(null, info);\n\t\tthis.$imageInput\n\t\t\t.siblings('strong')\n\t\t\t.andSelf()\n\t\t\t.remove();\n\t\tthis.$cancel.remove();\n\t\tthis.$uploadForm.find('#toggle').remove();\n\t\tthis.flushPending();\n\t\tthis.model.set({\n\t\t\tuploading: false,\n\t\t\tuploaded: true,\n\t\t\tsentAllocRequest: true\n\t\t});\n\n\t\t// Stop obnoxious wrap-around-image behaviour\n\t\tvar $img = this.$el.find('img');\n\t\tthis.$blockquote.css({\n\t\t\t'margin-left': $img.css('margin-right'),\n\t\t\t'padding-left': $img.width()\n\t\t});\n\n\t\tthis.resizeInput();\n\t},\n\t// Handle image upload status\n\tdispatch(msg) {\n\t\tconst a = msg.arg;\n\t\tswitch(msg.t) {\n\t\t\tcase 'alloc':\n\t\t\t\tthis.onImageAllocation(a);\n\t\t\t\tbreak;\n\t\t\tcase 'error':\n\t\t\t\tthis.uploadError(a);\n\t\t\t\tbreak;\n\t\t\tcase 'status':\n\t\t\t\tthis.uploadStatus(a);\n\t\t\t\tbreak;\n\t\t}\n\t},\n\tonImageAllocation(msg) {\n\t\tconst attrs = this.model.attributes;\n\t\tif (attrs.cancelled)\n\t\t\treturn;\n\t\tif (!attrs.num && !attrs.sentAllocRequest) {\n\t\t\tmain.send([common.INSERT_POST, this.allocationMessage(null, msg)]);\n\t\t\tthis.model.set({sentAllocRequest: true});\n\t\t}\n\t\telse\n\t\t\tmain.send([common.INSERT_IMAGE, msg]);\n\t},\n\tuploadError(msg) {\n\t\tif (this.model.get('cancelled'))\n\t\t\treturn;\n\t\tthis.model.set({\n\t\t\tuploadStatus: msg,\n\t\t\tuploading: false\n\t\t});\n\t\tif (this.$uploadForm)\n\t\t\tthis.$uploadForm.find('input[name=alloc]').remove();\n\t},\n\tuploadStatus(msg) {\n\t\tif (this.model.get('cancelled'))\n\t\t\treturn;\n\t\tthis.model.set('uploadStatus', msg);\n\t},\n\taddReference(num, sel) {\n\t\t// If a >>link exists, put this one on the next line\n\t\tvar val = this.$input.val();\n\t\tif (/^>>\\d+$/.test(val)) {\n\t\t\tthis.$input.val(val + '\\n');\n\t\t\tthis.onInput();\n\t\t\tval = this.$input.val();\n\t\t}\n\t\t// Quote selected text automatically\n\t\tif (sel) {\n\t\t\tsel = sel.split('\\n');\n\t\t\t// Prepend > to each line\n\t\t\tfor (let i = 0, len = sel.length; i < len; i++)\n\t\t\t\tsel[i] = '>' + sel[i];\n\t\t\tnum += '\\n' + sel.join('\\n') + '\\n';\n\t\t}\n\t\tthis.$input.val(val + '>>' + num);\n\t\tthis.$input[0].selectionStart = this.$input.val().length;\n\t\tthis.onInput();\n\t\tthis.$input.focus();\n\t},\n\tremove() {\n\t\tif (!this.preserve) {\n\t\t\tif (this.isThread)\n\t\t\t\tthis.$el.next('hr').remove();\n\t\t\tthis.$el.remove();\n\t\t}\n\t\tthis.$sizer.remove();\n\t\tif (this.$iframe) {\n\t\t\tthis.$iframe.remove();\n\t\t\tthis.$iframe = null;\n\t\t}\n\t\tthis.stopListening();\n\t\twindow.onbeforeunload = null;\n\t},\n\t// Extend with imager.js methods\n\trenderImage: imager.Hidamari.renderImage,\n\t// Overrides automatic image expansion, if any\n\tautoExpandImage() {\n\t\treturn this;\n\t},\n\tfun() {\n\t\t\n\t}\n});\nexports.ComposerView = ComposerView;\n\nfunction openPostBox(num) {\n\tpostSM.feed('new', document.query(`#p${num} aside.posting`));\n}\nmain.reply('openPostBox', openPostBox);\n\nwindow.addEventListener('message', function(event) {\n\tconst msg = event.data;\n\tif (msg !== 'OK' && postForm)\n\t\tpostForm.uploadError(msg);\n}, false);\n\nmain.$threads.on('click', 'a.quote', function(e) {\n\te.preventDefault();\n\n\t// TODO: Set highlighted post\n\n\t/*\n\t Make sure the selection both starts and ends in the quoted post's\n\t blockquote\n\t */\n\tconst post = e.target.closest('article, section'),\n\t\tgsel = getSelection(),\n\t\tnum = util.getNum(post);\n\n\tfunction isInside(prop) {\n\t\tconst el = gsel[prop] && gsel[prop].parentElement;\n\t\treturn  el\n\t\t\t&& el.closest('blockquote')\n\t\t\t&& el.closest('article, section') === post;\n\t}\n\n\tlet sel;\n\tif (isInside('baseNode') && isInside('focusNode'))\n\t\tsel = gsel.toString();\n\topenPostBox(util.getNum(post.closest('section')));\n\tpostForm.addReference(num, sel);\n});\n","/*\n * OP and thread related logic\n */\n\nconst main = require('../main'),\n\tPostCommon = require('./common'),\n\t{$, _, Backbone, util, oneeSama, state} = main;\n\nmodule.exports = PostCommon.extend({\n\ttagName: 'section',\n\trender() {\n\t\tconst attrs = this.model.attributes;\n\t\tthis.setElement(oneeSama.section(attrs)).insertIntoDOM();\n\n\t\t// Insert reply box into the new thread\n\t\tconst reply = util.parseDOM(oneeSama.replyBox());\n\t\tif (attrs.num in state.ownPosts || !!main.request('postForm'))\n\t\t\treply.style.display = 'none';\n\t\tthis.el.append(reply);\n\n\t\t// Remove next <hr>\n\t\tthis.el.nextElementSibling.remove();\n\t\treturn this;\n\t},\n\tinsertIntoDOM() {\n\t\tmain.$threads[0].query('aside')\n\t\t\t.after(this.el, document.createElement('hr'));\n\t\tthis.fun();\n\t},\n\trenderLocked(locked) {\n\t\tthis.el.classList[locked ? 'add' : 'remove']('locked');\n\t},\n\tremove() {\n\t\t// Remove next <hr>\n\t\tthis.el.nextElementSibling.remove();\n\t\tthis.el.remove();\n\t\tthis.stopListening();\n\t\treturn this;\n\t},\n\t/*\n\t Remove the top reply on board pages, if over limit, when a new reply is\n\t added\n\t */\n\tshiftReplies(postForm) {\n\t\tconst attrs = this.model.attributes,\n\t\t\t{replies} = attrs;\n\t\tlet lim = state.hotConfig.get('ABBREVIATED_REPLIES'),\n\t\t\tchanged;\n\t\tif (postForm)\n\t\t\tlim--;\n\t\t// Need a static length, because the original array get's modified\n\t\tconst len = replies.slice().length;\n\t\tfor (let i = len; i > lim; i--) {\n\t\t\tconst post = state.posts.get(replies.shift());\n\t\t\tif (!post)\n\t\t\t\tcontinue;\n\t\t\tif (post.get('image'))\n\t\t\t\tattrs.image_omit++;\n\t\t\tattrs.omit++;\n\t\t\tchanged = true;\n\t\t\tpost.remove();\n\t\t}\n\t\tif (changed)\n\t\t\tthis.renderOmit(attrs.omit, attrs.image_omit)\n\t},\n\t// Posts and images omited indicator\n\trenderOmit(omit = this.model.get('omit'),\n\t\timage_omit = this.model.get('image_omit')\n\t) {\n\t\tif (omit === 0)\n\t\t\treturn;\n\t\tconst {thread, href} = state.page.attributes;\n\t\tthis.el.query('.omit').innerHTML = oneeSama.lang.abbrev_msg(omit,\n\t\t\tthis.model.get('image_omit'), thread && href.split('?')[0]);\n\t},\n\t// Move thread to the top of the page\n\tbumpThread() {\n\t\tthis.el.nextElementSibling.remove();\n\t\tthis.el.remove();\n\t\tthis.insertIntoDOM();\n\t}\n});\n","/*\n * Various page scrolling logic\n */\n\nconst main = require('./main'),\n\t{$, Backbone, options, state} = main;\n\nconst {body} = document;\nlet atBottom, lockIndicator, isThread;\n\nfunction cacheState() {\n\tlockIndicator = document.query('#lock');\n\tisThread = !!state.posts.get('thread');\n}\n\n// Recache state on page change\nstate.page.on('change', cacheState);\ncacheState();\n\n// Sets the scroll lock position to a post or to bottom of the document\nfunction checkBottom() {\n\tatBottom = (body.scrollHeight - window.innerHeight) <= window.scrollY;\n\tif (lockIndicator)\n\t\tlockIndicator.style.visibility = atBottom ? 'visible' : 'hidden';\n}\n\ncheckBottom();\ndocument.addEventListener('scroll', checkBottom);\n\n/*\n Lock position to the bottom of a thread or keep the viewport from bumping\n on out of sight DOM mutation.\n */\n// Cache previous reference element to minimize DOM lookup\nlet referenceEl;\n\nfunction followDOM(func) {\n\tconst previous = referenceDistance(),\n\t\tret = func();\n\n\t// Prevent scrolling with new posts, if page isn't visible\n\tif (atBottom && (!document.hidden || options.get('alwaysLock')))\n\t\twindow.scrollTo(0,  body.scrollHeight);\n\telse {\n\t\t// Element was removed or something\n\t\tif (!elExists(referenceEl))\n\t\t\treturn ret;\n\n\t\t// Only compensate, if the height increased ~above the viewport\n\t\tconst delta = topDistance(referenceEl, true) - previous;\n\t\tif (delta)\n\t\t\twindow.scrollBy(0, delta);\n\t}\n\treturn ret;\n}\nmain.follow = followDOM;\n\n// Check if element reference exists and is in the DOM\nfunction elExists(el) {\n\treturn el && document.contains(el);\n}\n\n// Return element position dimentions against the viewport, if the element\n// is withing the viewport\nfunction topDistance(el, skipCheck) {\n\tconst {top} = el.getBoundingClientRect();\n\tif (skipCheck || (top >= 0 && top < window.innerHeight))\n\t\treturn top;\n\treturn null;\n}\n\nfunction referenceDistance() {\n\tif (elExists(referenceEl)) {\n\t\tconst bounds = topDistance(referenceEl);\n\t\tif (bounds !== null)\n\t\t\treturn bounds;\n\t}\n\n\t// Find new reference element (first inside viewport). Account for empty\n\t// threads and boards with no artciles or sections.\n\tfor (let selector of ['article', 'section', 'threads']) {\n\t\tfor (let el of main.$threads[0].queryAll(selector)) {\n\t\t\tconst bounds = topDistance(el);\n\t\t\tif (bounds !== null) {\n\t\t\t\treferenceEl = el;\n\t\t\t\treturn bounds;\n\t\t\t}\n\t\t}\n\t}\n}\n\n// Account for banner height, when scrolling to an anchor\nfunction aboveBanner (){\n\tif (!/^#p\\d+$/.test(location.hash))\n\t\treturn;\n\tlet $anchor = $(location.hash);\n\tif (!$anchor.length)\n\t\treturn;\n\t$(window).scrollTop($anchor.offset().top - $('#banner').height());\n}\nmain.reply('scroll:aboveBanner', aboveBanner);\nwindow.onload = aboveBanner;\n","/*\n * Central model keeping the state of the page\n */\n\nconst main = require('./main'),\n\t{_, Backbone} = main\n\n// Read page state by parsing a URL\nexport function read(href) {\n\tconst state = {\n\t\tboard: href.match(/\\/([a-zA-Z0-9]+?)\\//)[1],\n\t\tthread: href.match(/\\/(\\d+)(:?#\\d+)?(?:[\\?&]\\w+=\\w+)*$/),\n\t\t// Displayed last N posts setting on thread pages\n\t\tlastN: href.match(/[\\?&]last=(\\d+)/)\n\t}\n\tfor (let key of ['thread', 'lastN']) {\n\t\tconst val = state[key]\n\t    state[key] = val ? parseInt(val[1]) : 0\n\t}\n\treturn state\n}\n\n// Initial page state\nexport const page = new Backbone.Model(read(location.href))\n\n// Hot-reloadable configuration\n\n// TODO: We need actual listeners to this model for hot reloads\n\n// Tracks the synchronisation counter of each thread\nexport let syncs = {}\n\n// Posts I made in this tab\nexport const ownPosts = {}\n\n// remember which posts are mine for two days\nexport const mine = new main.Memory('mine', 2, true)\n\n// All posts currently displayed\nexport const posts = new Backbone.Collection()\n\nmain.on('state:clear', () => {\n\t/*\n\t * Emptying the whole element should be faster than removing each post\n\t * individually through models and listeners\n\t */\n\tmain.$threads.innerHTML = ''\n\n\t// The <threads> tag has already been emptied, no need to perform\n\t// element removal with the default `.remove()` method\n\tmodels.each(model =>\n\t\tmodel.dispatch('stopListening'))\n\n\tposts.reset()\n\n\t// Prevent old threads from syncing\n\texports.syncs = {}\n\tmain.request('massExpander:unset')\n})\n\n// Post links verified server-side\nexport const links = {}\n\nexport function addLinks(addition) {\n\tif (addition) {\n\t\t_.extend(links, addition);\n\t}\n}\n","/*\nTimezone corrections, batch timestamp updates, syncwatch, util.\n */\n\nlet main = require('./main'),\n\t{$, Backbone, common, oneeSama, options, state} = main;\n\n// Get a more accurate server-client time offset, for interclient syncing\n// Does not account for latency, but good enough for our purposes\nvar serverTimeOffset = 0;\nmain.dispatcher[common.GET_TIME] = function(msg){\n\tif (!msg[0])\n\t\treturn;\n\tserverTimeOffset = msg[0] - Date.now();\n};\nmain.reply('time:offset', () => serverTimeOffset);\n\nlet renderTimer;\nfunction batcTimeRender(source, rtime = options.get('relativeTime')) {\n\tstate.posts.each(model => model.dispatch('renderTime'));\n\tif (renderTimer)\n\t\tclearTimeout(renderTimer);\n\tif (rtime)\n\t\trenderTimer = setTimeout(batcTimeRender, 60000)\n}\nmain.reply('time:render', batcTimeRender);\noptions.on('change:relativeTime', batcTimeRender);\n\n/* syncwatch */\nfunction timer_from_el(el) {\n\tif (!serverTimeOffset)\n\t\treturn;\n\tel.classList.add('timerTicking');\n\tconst start = el.getAttribute('start'),\n\t\tend = el.getAttribute('end'),\n\t\tmaxh = common.pad(el.getAttribute('hour')),\n\t\tmaxm = common.pad(el.getAttribute('min')),\n\t\tmaxs = common.pad(el.getAttribute('sec'));\n\n\t(function moumouikkai() {\n\t\t// Prevent memory leak\n\t\tif (!document.body.contains(el))\n\t\t\treturn;\n\t\tconst now = common.serverTime();\n\t\tif (now > end)\n\t\t\treturn el.textContent = main.lang.finished;\n\n\t\t// If the start time is in the future\n\t\tif (start > now) {\n\t\t\tconst countdown = Math.round((start - now) / 1000);\n\t\t\tif(countdown === 10)\n\t\t\t\tmain.request('time:syncwatch');\n\t\t\tel.textContent = 'Countdown: ' + countdown;\n\t\t\treturn setTimeout(moumouikkai, 1000);\n\t\t}\n\n\t\tlet diff = now - start;\n\t\tconst hour = Math.floor(diff / 1000 /60 / 60);\n\t\tdiff -= hour * 1000 * 60 * 60;\n\t\tconst min = Math.floor( diff / 1000 / 60);\n\t\tdiff -= min * 1000 * 60;\n\t\tconst sec = Math.floor(diff / 1000);\n\t\tel.textContent = common.pad(hour) + \":\" + common.pad(min) + \":\"\n\t\t\t+ common.pad(sec) + \" / \" + maxh + \":\" + maxm + \":\" + maxs;\n\t\treturn setTimeout(moumouikkai, 1000);\n\t})();\n}\n\nfunction mouikkai() {\n\tsetInterval(function() {\n\t\tconst els = document.getElementsByTagName('syncwatch');\n\t\tfor (let i = 0; i < els.length; i++) {\n\t\t\tif (els[i].classList.contains('timerTicking'))\n\t\t\t\tcontinue;\n\t\t\ttimer_from_el(els[i]);\n\t\t}\n\t}, 1000);\n}\n\nmain.defer(batcTimeRender)\n\t.defer(mouikkai)\n\t.defer(function() {\n\t\t// Append UTC clock to the top of the schedule\n\t\tlet seconds;\n\t\tlet el = document.getElementById('UTCClock').firstChild;\n\t\tel.addEventListener('click', handler);\n\n\t\tfunction handler() {\n\t\t\tseconds = true;\n\t\t\tthis.removeAttribute('title');\n\t\t\tthis.style.cursor = 'default';\n\t\t\tthis.removeEventListener('click', handler);\n\t\t\trender();\n\t\t}\n\n\t\tfunction render() {\n\t\t\tif (!serverTimeOffset)\n\t\t\t\treturn setTimeout(render, 1000);\n\t\t\tel.innerHTML = oneeSama\n\t\t\t\t.readableUTCTime(new Date(common.serverTime()), seconds);\n\t\t\tsetTimeout(render, seconds ? 1000 : 60000);\n\t\t}\n\n\t\trender();\n\t});\n","/*\n Client-side helper functions\n */\n\nimport {_, config, state} from 'main'\nmain.util = module.exports\n\n/**\n * Make spoiler tags toggleable on mobile\n * @param {Element}\n */\nexport function touchable_spoiler_tag(del) {\n\tdel.html = '<del onclick=\"void(0)\">'\n}\n\n/**\n * Return image upload URL\n * @returns {string}\n */\nexport function imageUploadURL() {\n\treturn (config.hard.HTTP.upload || '../upload/') + '?id='\n\t\t+ state.page.get('connID')\n}\n\n/**\n * Retrieve post number of post element\n * @param {Element} el\n * @returns {int}\n */\nexport function getNum(el) {\n\tif (!el) {\n\t    return 0\n\t}\n\treturn parseInt(el.getAttribute('id').slice(1), 10)\n}\n\n/**\n * Retrieve post number of closest parent post\n * @param {Element} el\n * @returns {int}\n */\nexport function getID(el) {\n\tif (!el) {\n    \treturn 0\n\t}\n\treturn getNum(el.closest('article, section'))\n}\n\n/**\n * Retrieve model of closest parent post\n * @param {Element} el\n * @returns {(Backbone.Model|null)}\n */\nexport function getModel(el) {\n\tconst id = getID(el)\n\tif (!id)\n\t\treturn null\n\treturn state.posts.get(id)\n}\n\n/**\n * Parse HTML string to node array\n * @param {string} string\n * @returns {Element[]}\n */\nexport function parseEls(string) {\n\tconst el = document.createElement('div')\n\tel.innerHTML = string\n\tconst children = el.childNodes\n\treturn Array.from(children)\n}\n\n/**\n * Parse HTML string to Element\n * @param {string} string\n * @returns {Element}\n */\nexport function parseEl(string) {\n\tconst el = document.createElement('div')\n\tel.innerHTML = string\n\treturn el.firstChild\n}\n\n/**\n * Add an event listener that filters targets according to a CSS selector\n * @param {Element} el - Target element\n * @param {string} type - Event type\n * @param {string} selector - CSS selector\n * @param {function} handler - Callback function\n */\nexport function listener(el, type, selector, handler) {\n\tel.addEventListener(type, function (event) {\n\t\tif (event.target.matches(selector))\n\t\t\thandler.call(this, event)\n\t})\n}\n\n/**\n * Add event listener to element, that will only be executed once\n * @param {Element} el - Target element\n * @param {string} type\t- Event type\n * @param {function} handler - Callback function\n */\nexport function once(el, type, handler) {\n\tel.addEventListener(type, function (event) {\n\t\thandler.call(this, event)\n\t\tel.removeEventListener(type, handler)\n\t})\n}\n\n/**\n * Return width of element with padding and margin\n * @param {Element} el\n * @returns {int}\n */\nexport function outerWidth(el) {\n\tconst style =  getComputedStyle(el),\n\t\tprops = ['marginLeft', 'marginRight', 'paddingLeft','paddingRight']\n\tlet width = 0\n\tfor (let prop of props) {\n\t\twidth += parseInt(style[prop]);\n\t}\n\treturn width\n}\n\n/**\n * Confirms email is saging\n * @param {string} email\n * @returns {bool}\n */\nexport function isSage(email) {\n\treturn email && email.trim() === 'sage'\n}\n\n\n// TODO: Refactor server time syncronisation\nlet cachedOffset;\nexport function serverTime() {\n\tconst d = Date.now();\n\tif (imports.isNode)\n\t\treturn d;\n\n\t// The offset is intialised as 0, so there is something to return, until\n\t// we get a propper number from the server.\n\tif (!cachedOffset)\n\t\tcachedOffset = imports.main.request('time:offset');\n\treturn d + cachedOffset;\n}\n\nexport function readable_dice(bit, dice) {\n\tlet inner;\n\tswitch (bit) {\n\t\tcase '#flip':\n\t\t\tinner = (dice[2] == 2).toString();\n\t\t\tbreak;\n\t\tcase '#8ball':\n\t\t\tinner = imports.hotConfig.EIGHT_BALL[dice[2] - 1];\n\t\t\tbreak;\n\t\tcase '#pyu':\n\t\tcase '#pcount':\n\t\tcase '#q':\n\t\t\tinner = dice[0];\n\t\t\tbreak;\n\t}\n\tif (inner !== undefined)\n\t\treturn _.escape(`${bit} (${inner})`);\n\tif (/^#sw/.test(bit))\n\t\treturn readableSyncwatch(dice[0]);\n\treturn readableRegularDice(bit, dice);\n}\n\nfunction readableSyncwatch(dice) {\n\tdice.class = 'embed';\n\treturn parseHTML\n\t\t`<syncwatch ${dice}>\n\t\t\tsyncwatch\n\t\t</syncwatch>`;\n}\n\nfunction readableRegularDice(bit, [max, bias, ...rolls]) {\n\tbit += ' (';\n\tconst eq = rolls.length > 1 || bias;\n\tif (eq)\n\t\tbit += rolls.join(', ');\n\tif (bias)\n\t\tbit += (bias < 0 ? ' - ' + (-bias) : ' + ' + bias);\n\tlet sum = bias;\n\tfor (let roll of rolls) {\n\t\tsum += roll;\n\t}\n\treturn bit + (eq ? ' = ' : '') + sum + ')';\n}\n\nexport function pick_spoiler(metaIndex) {\n\tconst imgs = imports.config.SPOILER_IMAGES,\n\t\tn = imgs.length;\n\tlet i;\n\tif (metaIndex < 0)\n\t\ti = Math.floor(Math.random() * n);\n\telse\n\t\ti = metaIndex % n;\n\treturn {\n\t\tindex: imgs[i],\n\t\tnext: (i + 1) % n\n\t};\n}\n\nexport const thumbStyles = ['small', 'sharp', 'hide']\n\nexport function readable_filesize(size) {\n\t/* Dealt with it. */\n\tif (size < 1024)\n\t\treturn size + ' B';\n\tif (size < 1048576)\n\t\treturn Math.round(size / 1024) + ' KB';\n\tsize = Math.round(size / 104857.6).toString();\n\treturn size.slice(0, -1) + '.' + size.slice(-1) + ' MB';\n}\n\nexport function pad(n) {\n\treturn (n < 10 ? '0' : '') + n;\n}\n\n// Various UI-related links wrapped in []\nexport function action_link_html(href, name, id, cls) {\n\treturn parseHTML\n\t\t`<span class=\"act\">\n\t\t\t<a href=\"${href}\"\n\t\t\t\t${id && ` id=\"${id}\"`}\n\t\t\t\t${cls && ` class=\"${cls}\"`}\n\t\t\t>\n\t\t\t\t${name}\n\t\t\t</a>\n\t\t</span>`;\n}\n\n/**\n * Confirm last N posts to view setting matches bounds\n * @param {int} n\n * @returns {bool}\n */\nexport function resonableLastN(n) {\n\treturn Number.isInteger(n) && n <= 500\n}\n\nexport function parse_name(name) {\n\tvar tripcode = '', secure = '';\n\tvar hash = name.indexOf('#');\n\tif (hash >= 0) {\n\t\ttripcode = name.substr(hash + 1);\n\t\tname = name.substr(0, hash);\n\t\thash = tripcode.indexOf('#');\n\t\tif (hash >= 0) {\n\t\t\tsecure = _.escape(tripcode.substr(hash + 1));\n\t\t\ttripcode = tripcode.substr(0, hash);\n\t\t}\n\t\ttripcode = _.escape(tripcode);\n\t}\n\tname = name.trim().replace(imports.hotConfig.EXCLUDE_REGEXP, '');\n\treturn [\n\t\tname.substr(0, 100), tripcode.substr(0, 128),\n\t\tsecure.substr(0, 128)\n\t];\n}\n\n/**\n * Generate a random alphannumeric string of lower and upper case hexadecimal\n * characters\n * @param {int} len\t- String length\n * @returns {string}\n */\nexport function randomID(len) {\n\tlet id = ''\n\tfor (let i = 0; i < len; i++) {\n\t\tlet char = (Math.random() * 36).toString(36)[0]\n\t\tif (Math.random() < 0.5)\n\t\t\tchar = char.toUpperCase()\n\t\tid += char\n\t}\n\treturn id\n}\n\n/**\n * Template string tag function for HTML. Strips indentation and trailing\n * newlines. Based on https://gist.github.com/zenparsing/5dffde82d9acef19e43c\n * @param {*}\n * @returns {string}\n */\nexport function parseHTML(callSite) {\n\t// if argumennts.length === 1\n\tif (typeof callSite === 'string')\n\t\treturn formatHTML(callSite);\n\tif (typeof callSite === 'function')\n\t\treturn formatHTML(callSite(args))\n\n\t/*\n\t Slicing the arguments object is deoptimising, so we construct a new array\n\t instead.\n\t */\n\tconst len = arguments.length;\n\tlet args = [];\n\tfor (let i = 1; i < len; i++) {\n\t\targs[i - 1] = arguments[i]\n\t}\n\n\tconst output = callSite\n\t\t.slice(0, len)\n\t\t.map((text, i) => {\n\t\t\tconst arg = args[i - 1]\n\t\t\tlet result;\n\t\t\t/*\n\t\t\t Simplifies conditionals. If the placeholder returns a non-zero\n\t\t\t falsy value, it is ommitted.\n\t\t\t */\n\t\t\tif (i === 0 || (!arg && arg !== 0))\n\t\t\t\tresult = ''\n\t\t\telse if (arg instanceof Object)\n\t\t\t\tresult = elementAttributes(arg)\n\t\t\telse\n\t\t\t\tresult = arg\n\n\t\t\treturn result + text\n\t\t})\n\t\t.join('')\n\n\treturn formatHTML(output)\n}\n\n/**\n * Strip leading indentation from HTML string\n */\nfunction formatHTML(str) {\n\tlet size = -1;\n\treturn str\n\t\t.replace(/\\n(\\s+)/g, (m, m1) => {\n\t\t\tif (size < 0)\n\t\t\t\tsize = m1.replace(/\\t/g, '    ').length\n\t\t\treturn m1.slice(Math.min(m1.length, size))\n\t\t})\n\t\t// Remove empty lines\n\t\t.replace(/^\\s*\\n/gm, '')\n}\n\n/**\n * Generate an HTML element attribute list\n */\nfunction elementAttributes(attrs) {\n\tlet html = '';\n\tfor (let key in attrs) {\n\t\thtml += ' '\n\t\tconst val = attrs[key]\n\t\tif (val === true)\n\t\t\thtml += key\n\t\telse if (val || val === 0)\n\t\t\thtml += `${key}=\"${val}\"`\n\t}\n\treturn html\n}\n\n/**\n * Makes a ', ' seperated list out of on array of strings\n * @param {string[]} items\n * @returns {string}\n */\nexport function commaList(items) {\n\tlet html = ''\n\tfor (let item of items) {\n\t\t// Falsy value. Skip item.\n\t\tif (!item && item !== 0)\n\t\t\tcontinue\n\t\tif (html)\n\t\t\thtml += ', '\n\t\thtml += item\n\t}\n\treturn html\n}\n\n/**\n * Acertains client has the proper authorisation to perfrom task. This is only\n * for rendering. The same validation is performed server-side.\n * @param {string} action - Privilidged action to check permission for\n * @returns {bool}\n */\nexport function checkAuth(action) {\n\tconst cls = config.staff.classes[main.ident && main.ident.auth]\n    return cls && !!cls.rights[action]\n}\n","/*\n * Loads the depandancies in order and aggregates exports from various modules\n */\n\n// NOTE: The entire bundle uses strict mode through the Babel transpiler\n\n/*\n * Because we are going to attach listeners to these all over the place, have\n * to load soome core modules in specific order. Also avoids nasty circular\n * dependancy, by placing some of the exports here and not in child modules.\n */\nconst _ = require('underscore'),\n\tBackbone = require('backbone'),\n\tCookie = require('js-cookie'),\n\tradio = require('backbone.radio')\n\nimport FSM from './fsm'\n\n// Load standard library ES6 polyfills\nrequire('core-js')\n// Load DOM level 4 polyfill\nrequire('dom4')\n// Load Backbone.View native JS replacement\nrequire('backbone.nativeview')\nBackbone.View = Backbone.NativeView\n\n// Central aplication object and message bus\nlet main = module.exports = radio.channel('main')\n\n_.extend(main, {\n\t// Bind dependancies to main object for pretier destructuring requires\n\t_, Backbone, Cookie, FSM,\n\t$script: require('scriptjs'),\n\tSockJS: require('sockjs-client'),\n\n\t/*\n\t Ofload expensive and not that neccessary initialisation logic till\n\t after the core modules are started\n\t */\n\t_deferred: [],\n\tdefer(func) {\n\t\tmain._deferred.push(func)\n\t\treturn main\n\t},\n\texecDefered() {\n\t\tfor (let func of this._deferred) {\n\t\t\tfunc()\n\t\t}\n\t},\n\n\t// Websocket call handler map. Store them here, to avoid requiring\n\t// modules in the wrong order.\n\tdispatcher: {}\n})\n\n// Import configuration variables from the template HTML\n_.extend(main, {config, configHash, clientHash, isMobile})\n\n// Clear cookies, if versions mismatch. Get regenerated each client start\n// anyway.\nconst cookieVersion = 3\nif (localStorage.cookieVersion != cookieVersion) {\n\tfor (let cookie in Cookie.get()) {\n\n\t\t// Clear legacy cookies that were set for each board separatly.\n\t\t// Otherwise, they would override the new ones.\n\t\tconst paths = main.config.boards.enabled.slice()\n\t\tpaths.push('')\n\t\tfor (let path of paths) {\n\t\t\tCookie.remove(cookie, {path})\n\t\t}\n\t}\n\tlocalStorage.cookieVersion = cookieVersion\n}\n\n// You can invoke the client-side debug mode with the `debug=true` query string\nif (/[&\\?]debug=true/.test(location.href))\n\tmain.config.hard.debug = true\nif (main.config.hard.debug) {\n\tradio.DEBUG = true\n\twindow.Backbone = Backbone // Export Backbone instance for easier debugging\n\tradio.tuneIn('main') // Log all channel traffic\n}\n\nmain.send = main.request.bind(main, 'send') // Shorthand\n\n/*\n Core modules. The other will be more or less decoupled, but these are the\n monolithic foundation.\n */\nmain.Memory = require('./memory')\nconst lang = main.lang = require('lang'),\n\tstate = main.state = require('./state'),\n\tutil = require('./util'),\n\tcommon = main.common = require('./common')\n\n/*\n// Initialise main rendering object\nlet oneeSama = main.oneeSama = new common.OneeSama({\n\top: state.page.get('thread'),\n\tlang,\n\t// Core post link handler\n\ttamashii(num) {\n\t\tlet frag;\n\t\tconst op = state.links[num];\n\t\tif (op) {\n\t\t\tconst desc = num in state.mine.readAll() && this.lang.you;\n\t\t\tfrag = this.postRef(num, op, desc);\n\t\t}\n\t\telse\n\t\t\tfrag = '>>' + num;\n\t\treturn frag;\n\t}\n});\n*/\nmain.options = require('./options')\nmain.scroll = require('./scroll')\nstate.page.set('tabID', common.randomID(32))\n\n// Load language-specific CSS\ndocument.head.appendChild(util.parseDOM(common.parseHTML\n\t`<style>\n\t\t.locked:after {\n\t\t\tcontent: \"${lang.thread_locked}\";\n\t\t}\n\t\t.locked > header nav:after {\n\t\t\tcontent: \" (${lang.locked})\";\n\t\t}\n\t</style>`));\n\n_.extend(main, {\n\t// Cached DOM elements\n\t$threads: document.query('threads'),\n\t$name: document.query('input[name=name]'),\n\t$email: document.query('input[name=email]'),\n\n\tconnSM: new FSM('load'),\n\tpostSM: new FSM('none')\n});\n\n// 2nd tier dependacy modules. These are needed before the websocket\n// connection is opened, because they populate the dispatcher handler object.\n_.extend(main, {\n\tloop: require('./loop'),\n\ttime: require('./time'),\n\tamusement: require('./amusement')\n});\n\n// Load post models and views\nmain.posts = require('./posts')\nmain.Extract = require('./extract')\n// Start the client\nmain.client = require('./client')\nmain.conection = require('./connection')\n\n// Load independant auxilary modules\n_.extend(main, {\n\thistory: require('./history'),\n\thide: require('./hide')\n})\n\nmain.execDefered()\nmain.request('loading:hide')\n"],"sourceRoot":"/source/"}